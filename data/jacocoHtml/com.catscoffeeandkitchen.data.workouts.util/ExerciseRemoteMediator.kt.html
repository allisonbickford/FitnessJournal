<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExerciseRemoteMediator.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.data.workouts.util</a> &gt; <span class="el_source">ExerciseRemoteMediator.kt</span></div><h1>ExerciseRemoteMediator.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.data.workouts.util

import androidx.paging.ExperimentalPagingApi
import androidx.paging.LoadType
import androidx.paging.PagingState
import androidx.paging.RemoteMediator
import androidx.room.withTransaction
import com.catscoffeeandkitchen.data.workouts.db.FitnessJournalDb
import com.catscoffeeandkitchen.data.workouts.models.ExerciseWithSets
import com.catscoffeeandkitchen.data.workouts.models.RemoteKeys
import com.catscoffeeandkitchen.data.workouts.network.ExerciseSearchService
import com.catscoffeeandkitchen.data.workouts.network.models.*
import com.catscoffeeandkitchen.domain.models.ExerciseEquipmentType
import com.catscoffeeandkitchen.domain.util.capitalizeWords
import retrofit2.HttpException
import timber.log.Timber
import java.io.IOException
import com.catscoffeeandkitchen.data.workouts.models.exercise.ExerciseEntity as DbExercise

@OptIn(ExperimentalPagingApi::class)
<span class="nc" id="L21">class ExerciseRemoteMediator(</span>
<span class="nc" id="L22">    private val query: String,</span>
<span class="nc" id="L23">    private val muscleFilter: String,</span>
<span class="nc" id="L24">    private val category: String,</span>
<span class="nc" id="L25">    private val service: ExerciseSearchService,</span>
<span class="nc" id="L26">    private val database: FitnessJournalDb</span>
<span class="nc" id="L27">) : RemoteMediator&lt;Int, ExerciseWithSets&gt;() {</span>

    companion object {
        const val PAGE_SIZE = 20
        const val STARTING_PAGE = 0
        fun isBarbellExercise(exerciseName: String): Boolean {
<span class="nc" id="L33">            val lowercased = exerciseName.lowercase()</span>
<span class="nc bnc" id="L34" title="All 2 branches missed.">            return lowercased.contains(&quot;barbell&quot;) ||</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">                    lowercased.contains(&quot;bench press&quot;) ||</span>
<span class="nc bnc" id="L36" title="All 2 branches missed.">                    lowercased.contains(&quot;good morning&quot;) ||</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">                    lowercased.contains(&quot;hip thrust&quot;) ||</span>
<span class="nc bnc" id="L38" title="All 4 branches missed.">                    (lowercased.contains(&quot;squat&quot;) &amp;&amp; !lowercased.contains(&quot;dumbbell&quot;))</span>
        }
    }

    override suspend fun initialize(): InitializeAction {
        // Launch remote refresh as soon as paging starts and do not trigger remote prepend or
        // append until refresh has succeeded. In cases where we don't mind showing out-of-date,
        // cached offline data, we can return SKIP_INITIAL_REFRESH instead to prevent paging
        // triggering remote refresh.
<span class="nc" id="L47">        return InitializeAction.LAUNCH_INITIAL_REFRESH</span>
    }

<span class="nc" id="L50">    override suspend fun load(loadType: LoadType, state: PagingState&lt;Int, ExerciseWithSets&gt;): MediatorResult {</span>
<span class="nc bnc" id="L51" title="All 3 branches missed.">        val page = when (loadType) {</span>
            LoadType.REFRESH -&gt; {
<span class="nc" id="L53">                val remoteKeys = getRemoteKeyClosestToCurrentPosition(state)</span>
<span class="nc bnc" id="L54" title="All 4 branches missed.">                remoteKeys?.nextKey?.minus(1) ?: STARTING_PAGE</span>
            }
            LoadType.PREPEND -&gt; {
<span class="nc" id="L57">                val remoteKeys = getRemoteKeyForFirstItem(state)</span>
<span class="nc bnc" id="L58" title="All 4 branches missed.">                val prevKey = remoteKeys?.prevKey</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">                    ?: return MediatorResult.Success(endOfPaginationReached = remoteKeys != null)</span>
<span class="nc" id="L60">                prevKey</span>
            }
            LoadType.APPEND -&gt; {
<span class="nc" id="L63">                val remoteKeys = getRemoteKeyForLastItem(state)</span>
<span class="nc bnc" id="L64" title="All 4 branches missed.">                val nextKey = remoteKeys?.nextKey</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                    ?: return MediatorResult.Success(endOfPaginationReached = remoteKeys != null)</span>
<span class="nc" id="L66">                nextKey</span>
            }
        }

<span class="nc" id="L70">        try {</span>
<span class="nc" id="L71">            val searchedExercises = mutableListOf&lt;WgerSearchData&gt;()</span>

<span class="nc" id="L73">            var nextPage: String? = null</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">            if (query.isNotEmpty()) {</span>
<span class="nc" id="L75">                val searchResult = service.searchExercises(</span>
<span class="nc" id="L76">                    query,</span>
                )

<span class="nc" id="L79">                searchResult.suggestions.forEach { item -&gt;</span>
//                    val exerciseData = service.getExercises(name = item.data.name, limit = 1, offset = 0).results
//                    exerciseData.firstOrNull()?.let { data -&gt;
<span class="nc" id="L82">                        searchedExercises.add(WgerSearchData(</span>
<span class="nc" id="L83">                        id = item.data.id,</span>
<span class="nc" id="L84">                        item.data.baseId,</span>
<span class="nc" id="L85">                        item.data.name,</span>
<span class="nc bnc" id="L86" title="All 8 branches missed.">                        WgerExerciseCategory.values().find { it.name.lowercase() == item.data.category.lowercase() }</span>
<span class="nc" id="L87">                            ?.name ?: WgerExerciseCategory.Unknown.name,</span>
<span class="nc" id="L88">                        &quot;https://wger.de${item.data.image}&quot;,</span>
<span class="nc" id="L89">                        &quot;https://wger.de${item.data.imageThumbnail}&quot;,</span>
//                        muscles = exerciseData.firstOrNull()?.muscles.orEmpty() +
//                                exerciseData.firstOrNull()?.musclesSecondary.orEmpty()
                    ))
//                }
<span class="nc" id="L94">                }</span>
            } else {
<span class="nc" id="L96">                val exerciseResult = service.getExercises(</span>
<span class="nc" id="L97">                    name = query,</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">                    muscle = WgerMuscle.values().find { it.coloquial.contains(muscleFilter.capitalizeWords()) },</span>
<span class="nc bnc" id="L99" title="All 4 branches missed.">                    category = WgerExerciseCategory.values().find { it.name.lowercase() == category.lowercase() },</span>
<span class="nc" id="L100">                    limit = PAGE_SIZE,</span>
<span class="nc" id="L101">                    offset = page * state.config.pageSize</span>
                )

<span class="nc" id="L104">                exerciseResult.results.forEach { item -&gt;</span>
//                    val exerciseData = service.getExerciseImages(
//                        id = item.id, limit = 1, offset = 0).results
//                    exerciseData.firstOrNull()?.let { exercise -&gt;
<span class="nc" id="L108">                        searchedExercises.add(</span>
<span class="nc" id="L109">                        WgerSearchData(</span>
<span class="nc" id="L110">                            item.id,</span>
<span class="nc" id="L111">                            item.exerciseBase,</span>
<span class="nc" id="L112">                            item.name,</span>
<span class="nc bnc" id="L113" title="All 10 branches missed.">                            WgerExerciseCategory.values().find { it.number == item.category }</span>
<span class="nc" id="L114">                                ?.name ?: WgerExerciseCategory.Unknown.name,</span>
<span class="nc" id="L115">                            null, null,</span>
//                            exerciseData.firstOrNull()?.image,
//                            exerciseData.firstOrNull()?.image,
<span class="nc" id="L118">                            muscles = item.muscles + item.musclesSecondary</span>
                        )
<span class="nc" id="L120">                    ) }</span>
//                }

<span class="nc" id="L123">                nextPage = exerciseResult.next</span>
            }

<span class="nc" id="L126">            database.withTransaction {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                if (loadType == LoadType.REFRESH) {</span>
<span class="nc" id="L128">                    database.remoteKeysDao().clearRemoteKeys()</span>
//                    database.exerciseDao().clearRemoteExercises()
                }
<span class="nc bnc" id="L131" title="All 2 branches missed.">                val prevKey = if (page == STARTING_PAGE) null else page - 1</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                val nextKey = if (nextPage == null) null else page + 1</span>
<span class="nc" id="L133">                val keys = searchedExercises.map { wgerExercise -&gt;</span>
<span class="nc" id="L134">                    RemoteKeys(exerciseName = wgerExercise.name, prevKey = prevKey, nextKey = nextKey)</span>
                }

<span class="nc" id="L137">                database.remoteKeysDao().insertAll(keys)</span>
<span class="nc" id="L138">                database.exerciseDao().insertAll(searchedExercises.map { wgerExercise -&gt;</span>
<span class="nc" id="L139">                    val equipment = when {</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                        isBarbellExercise(wgerExercise.name) -&gt; ExerciseEquipmentType.Barbell</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                        wgerExercise.name.contains(&quot;dumbbell&quot;, ignoreCase = true) -&gt; ExerciseEquipmentType.Dumbbell</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                        wgerExercise.name.contains(&quot;machine&quot;, ignoreCase = true) -&gt; ExerciseEquipmentType.Machine</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                        wgerExercise.name.contains(&quot;cable&quot;, ignoreCase = true) -&gt; ExerciseEquipmentType.Cable</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                        wgerExercise.name.contains(&quot;bodyweight&quot;, ignoreCase = true) -&gt; ExerciseEquipmentType.Bodyweight</span>
<span class="nc" id="L145">                        else -&gt; ExerciseEquipmentType.Bodyweight</span>
                    }

<span class="nc" id="L148">                    DbExercise(</span>
<span class="nc" id="L149">                        eId = 0L,</span>
<span class="nc" id="L150">                        name = wgerExercise.name,</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                        musclesWorked = wgerExercise.muscles?.flatMap { muscle -&gt;</span>
<span class="nc bnc" id="L152" title="All 10 branches missed.">                            WgerMuscle.values().find { it.number == muscle }?.coloquial.orEmpty()</span>
<span class="nc" id="L153">                        }.orEmpty(),</span>
<span class="nc" id="L154">                        userCreated = false,</span>
<span class="nc" id="L155">                        category = wgerExercise.category,</span>
<span class="nc" id="L156">                        thumbnailUrl = wgerExercise.image,</span>
<span class="nc" id="L157">                        equipmentType = equipment,</span>
                    )
                })
            }
<span class="nc bnc" id="L161" title="All 2 branches missed.">            return MediatorResult.Success(endOfPaginationReached = nextPage == null)</span>
<span class="nc" id="L162">        } catch (exception: IOException) {</span>
<span class="nc" id="L163">            Timber.e(exception)</span>
<span class="nc" id="L164">            return MediatorResult.Error(exception)</span>
<span class="nc" id="L165">        } catch (exception: HttpException) {</span>
<span class="nc" id="L166">            Timber.e(exception)</span>
<span class="nc" id="L167">            return MediatorResult.Error(exception)</span>
        }

    }

    private suspend fun getRemoteKeyForFirstItem(state: PagingState&lt;Int, ExerciseWithSets&gt;): RemoteKeys? {
        // Get the first page that was retrieved, that contained items.
        // From that first page, get the first item
<span class="nc bnc" id="L175" title="All 10 branches missed.">        return state.pages.firstOrNull { it.data.isNotEmpty() }?.data?.firstOrNull()</span>
<span class="nc" id="L176">            ?.let { ex -&gt;</span>
                // Get the remote keys of the first items retrieved
<span class="nc" id="L178">                database.remoteKeysDao().remoteKeysExerciseName(ex.exercise.name)</span>
            }
    }

    private suspend fun getRemoteKeyForLastItem(state: PagingState&lt;Int, ExerciseWithSets&gt;): RemoteKeys? {
        // Get the last page that was retrieved, that contained items.
        // From that last page, get the last item
<span class="nc bnc" id="L185" title="All 10 branches missed.">        return state.pages.lastOrNull() { it.data.isNotEmpty() }?.data?.lastOrNull()</span>
<span class="nc" id="L186">            ?.let { ex -&gt;</span>
                // Get the remote keys of the last item retrieved
<span class="nc" id="L188">                database.remoteKeysDao().remoteKeysExerciseName(exerciseName = ex.exercise.name)</span>
            }
    }


    private suspend fun getRemoteKeyClosestToCurrentPosition(
        state: PagingState&lt;Int, ExerciseWithSets&gt;
    ): RemoteKeys? {
        // The paging library is trying to load data after the anchor position
        // Get the item closest to the anchor position
<span class="nc bnc" id="L198" title="All 2 branches missed.">        return state.anchorPosition?.let { position -&gt;</span>
<span class="nc bnc" id="L199" title="All 6 branches missed.">            state.closestItemToPosition(position)?.exercise?.name?.let { name -&gt;</span>
<span class="nc" id="L200">                database.remoteKeysDao().remoteKeysExerciseName(name)</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>