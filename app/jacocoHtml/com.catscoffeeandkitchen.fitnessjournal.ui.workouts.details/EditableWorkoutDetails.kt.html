<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EditableWorkoutDetails.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details</a> &gt; <span class="el_source">EditableWorkoutDetails.kt</span></div><h1>EditableWorkoutDetails.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details

import android.app.Activity
import android.content.pm.PackageManager
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.animation.*
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.runtime.saveable.rememberSaveable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.core.app.ActivityCompat.shouldShowRequestPermissionRationale
import androidx.core.content.ContextCompat
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleEventObserver
import androidx.lifecycle.LifecycleOwner
import com.catscoffeeandkitchen.domain.models.Exercise
import com.catscoffeeandkitchen.domain.models.ExerciseSet
import com.catscoffeeandkitchen.domain.models.Workout
import com.catscoffeeandkitchen.fitnessjournal.R
import com.catscoffeeandkitchen.fitnessjournal.TestTags
import com.catscoffeeandkitchen.fitnessjournal.services.TimerServiceConnection
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalButton
import com.catscoffeeandkitchen.fitnessjournal.ui.util.WeightUnit
import com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details.exercise.*
import java.time.OffsetDateTime

@OptIn(ExperimentalFoundationApi::class)
@Composable
fun WorkoutDetails(
    scrollState: LazyListState,
    workout: Workout,
    sets: List&lt;UiExercise&gt;,
    unit: WeightUnit,
    workoutActions: WorkoutActions?,
    exerciseUiActions: ExerciseUiActions?,
    exerciseNavigableActions: ExerciseNavigableActions?,
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">    startTimer: (Long) -&gt; Unit = {},</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">    connection: TimerServiceConnection? = null,</span>
<span class="fc" id="L53">    lifecycleOwner: LifecycleOwner = LocalLifecycleOwner.current</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">) {</span>
<span class="fc" id="L55">    val context = LocalContext.current</span>
<span class="pc" id="L56">    var showNotificationRationaleDialog by remember { mutableStateOf(false) }</span>
<span class="pc" id="L57">    var useKeyboard by rememberSaveable { mutableStateOf(false) }</span>
<span class="pc" id="L58">    var timeSinceKey by remember { mutableStateOf(null as OffsetDateTime?) }</span>
<span class="pc" id="L59">    var selectedTimer by remember { mutableStateOf(30L) }</span>

<span class="fc" id="L61">    DisposableEffect(lifecycleOwner) {</span>
<span class="fc" id="L62">        val observer = LifecycleEventObserver { _, event -&gt;</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">            if (event == Lifecycle.Event.ON_RESUME) {</span>
<span class="pc bpc" id="L64" title="2 of 4 branches missed.">                val seconds = connection?.timerService?.seconds</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">                if (seconds != null) {</span>
<span class="nc" id="L66">                    timeSinceKey = OffsetDateTime.now().minusSeconds(seconds - 1)</span>
                }
            }
<span class="fc" id="L69">        }</span>

<span class="fc" id="L71">        lifecycleOwner.lifecycle.addObserver(observer)</span>
<span class="fc" id="L72">        onDispose {</span>
            lifecycleOwner.lifecycle.removeObserver(observer)
        }
    }

<span class="fc" id="L77">    val permissionLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L78">        ActivityResultContracts.RequestPermission()</span>
<span class="fc" id="L79">    ) { isGranted: Boolean -&gt;</span>
<span class="nc" id="L80">        startTimer(selectedTimer)</span>
<span class="nc" id="L81">    }</span>

<span class="pc bpc" id="L83" title="1 of 2 branches missed.">    if (showNotificationRationaleDialog) {</span>
<span class="pc" id="L84">        AlertDialog(</span>
<span class="nc" id="L85">            modifier = Modifier.fillMaxWidth(.7f),</span>
<span class="nc" id="L86">            onDismissRequest = { showNotificationRationaleDialog = false },</span>
<span class="nc" id="L87">            confirmButton = {</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">                TextButton(</span>
                    onClick = {
<span class="nc" id="L90">                        showNotificationRationaleDialog = false</span>
<span class="nc" id="L91">                        permissionLauncher.launch(&quot;android.permission.POST_NOTIFICATIONS&quot;)</span>
<span class="nc" id="L92">                    }</span>
<span class="pc bnc" id="L93" title="All 4 branches missed.">                ) { Text(&quot;OK&quot;) }</span>
<span class="nc" id="L94">            },</span>
<span class="fc" id="L95">            text = {</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">                Text(&quot;Notifications are only shown to&quot; +</span>
<span class="nc" id="L97">                        &quot; display seconds left on a timer you start.&quot;)</span>
<span class="nc" id="L98">            }</span>
        )
    }


<span class="pc bpc" id="L103" title="1 of 2 branches missed.">    LazyColumn(</span>
<span class="fc" id="L104">        state = scrollState,</span>
<span class="fc" id="L105">        verticalArrangement = Arrangement.spacedBy(8.dp),</span>
<span class="fc" id="L106">        modifier = Modifier.testTag(TestTags.ScrollableComponent),</span>
    ) {
<span class="fc" id="L108">        item {</span>
<span class="pc bpc" id="L109" title="3 of 4 branches missed.">            WorkoutNameAndNoteSection(</span>
<span class="fc" id="L110">                workoutName = workout.name,</span>
<span class="fc" id="L111">                workoutNote = workout.note,</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                updateName = { workoutActions?.updateName(it) },</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                updateNote = { workoutActions?.updateNote(it) },</span>
<span class="nc" id="L114">            )</span>
<span class="fc" id="L115">        }</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (workout.completedAt == null) {</span>
<span class="fc" id="L118">            stickyHeader {</span>
<span class="pc bpc" id="L119" title="3 of 4 branches missed.">                Column(</span>
<span class="fc" id="L120">                    modifier = Modifier</span>
<span class="fc" id="L121">                        .background(MaterialTheme.colorScheme.background)</span>
<span class="fc" id="L122">                        .fillMaxWidth()</span>
<span class="fc" id="L123">                        .padding(12.dp)</span>
<span class="fc" id="L124">                        .border(1.dp, MaterialTheme.colorScheme.primary, MaterialTheme.shapes.small)</span>
<span class="fc" id="L125">                        .padding(8.dp)</span>
                ) {
<span class="pc bpc" id="L127" title="3 of 4 branches missed.">                    Text(&quot;Start a Timer&quot;, style = MaterialTheme.typography.titleSmall)</span>

<span class="fc" id="L129">                    Row(</span>
<span class="fc" id="L130">                        horizontalArrangement = Arrangement.spacedBy(18.dp),</span>
                    ) {
<span class="pc bpc" id="L132" title="3 of 4 branches missed.">                        listOf(30L, 60L, 90L, 120L).forEach { amount -&gt;</span>
<span class="fc" id="L133">                            TimerButton(amount) { time -&gt;</span>
<span class="nc" id="L134">                                timeSinceKey = time</span>
<span class="nc" id="L135">                                selectedTimer = amount</span>

<span class="nc" id="L137">                                when {</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                                    ContextCompat.checkSelfPermission(</span>
<span class="nc" id="L139">                                        context,</span>
<span class="nc" id="L140">                                        &quot;android.permission.POST_NOTIFICATIONS&quot;</span>
                                    ) == PackageManager.PERMISSION_GRANTED -&gt; {
<span class="nc" id="L142">                                        startTimer(amount)</span>
                                    }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                                    shouldShowRequestPermissionRationale(</span>
<span class="nc" id="L145">                                        context as Activity,</span>
<span class="nc" id="L146">                                        &quot;android.permission.POST_NOTIFICATIONS&quot;</span>
                                    ) -&gt; {
<span class="nc" id="L148">                                        showNotificationRationaleDialog = true</span>
                                    }
                                    else -&gt; {
<span class="nc" id="L151">                                        permissionLauncher</span>
<span class="nc" id="L152">                                            .launch(&quot;android.permission.POST_NOTIFICATIONS&quot;)</span>
                                    }
                                }
<span class="nc" id="L155">                            }</span>
<span class="pc" id="L156">                        }</span>
<span class="pc" id="L157">                    }</span>

<span class="pc bpc" id="L159" title="1 of 2 branches missed.">                    timeSinceKey?.let { time -&gt;</span>
<span class="nc" id="L160">                        TimeSinceText(</span>
<span class="nc" id="L161">                            startTime = time,</span>
<span class="nc bnc" id="L162" title="All 6 branches missed.">                            totalTime = connection?.timerService?.startingSeconds ?: selectedTimer,</span>
                        )
<span class="pc" id="L164">                    }</span>
<span class="pc" id="L165">                }</span>
<span class="fc" id="L166">            }</span>
        }

<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (workout.completedAt != null) {</span>
<span class="nc" id="L170">            item {</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">                FitnessJournalButton(</span>
<span class="nc" id="L172">                    text = &quot;Create Plan from this Workout&quot;,</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                    onClick = { workoutActions?.createPlanFromWorkout() },</span>
<span class="nc" id="L174">                    fullWidth = true</span>
<span class="nc" id="L175">                )</span>
<span class="nc" id="L176">            }</span>
        }

<span class="pc bpc" id="L179" title="3 of 8 branches missed.">        if (workout.entries.any { it.sets.any { set -&gt; !set.isComplete } }) {</span>
<span class="fc" id="L180">            item {</span>
<span class="pc bpc" id="L181" title="3 of 4 branches missed.">                Row(</span>
<span class="fc" id="L182">                    modifier = Modifier</span>
<span class="fc" id="L183">                        .fillMaxWidth()</span>
<span class="fc" id="L184">                        .padding(12.dp),</span>
<span class="fc" id="L185">                    horizontalArrangement = Arrangement.spacedBy(8.dp),</span>
<span class="fc" id="L186">                    verticalAlignment = Alignment.CenterVertically</span>
                ) {
<span class="pc bpc" id="L188" title="3 of 4 branches missed.">                    Switch(</span>
<span class="fc" id="L189">                        useKeyboard,</span>
<span class="pc bnc" id="L190" title="All 2 branches missed.">                        onCheckedChange = { useKeyboard = !useKeyboard }</span>
                    )
<span class="pc" id="L192">                    Text(&quot;Use Keyboard Inputs&quot;, style = MaterialTheme.typography.labelMedium)</span>
<span class="pc" id="L193">                }</span>
<span class="fc" id="L194">            }</span>
        }

<span class="fc" id="L197">        itemsIndexed(workout.entries, key = { _, entry -&gt; entry.position }) { index, entry -&gt;</span>
            ExerciseCard(
                ExerciseUiData(
                    workout.id,
                    entry,
                    unit = unit,
                    isFirstExercise = index == 0,
                    isLastExercise = index == sets.lastIndex,
                    useKeyboard = useKeyboard,
                    wasChosenFromGroup = entry.exercise != null &amp;&amp;
                            entry.expectedSet?.exerciseGroup != null
                ),
                uiActions = exerciseUiActions,
                navigableActions = exerciseNavigableActions,
<span class="nc" id="L211">                onCompleteSet = { },</span>
                modifier = Modifier.animateItemPlacement(),
            )
        }

<span class="pc bpc" id="L216" title="1 of 2 branches missed.">        if (workout.completedAt == null) {</span>
<span class="fc" id="L217">            item {</span>
<span class="pc bpc" id="L218" title="3 of 4 branches missed.">                FitnessJournalButton(</span>
<span class="fc" id="L219">                    &quot;Add Exercise&quot;,</span>
                    onClick = {
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">                        exerciseNavigableActions?.addExercise()</span>
<span class="fc" id="L222">                    },</span>
<span class="fc" id="L223">                    icon = {</span>
<span class="pc bpc" id="L224" title="1 of 4 branches missed.">                        Icon(painterResource(id = R.drawable.fitness_center), &quot;group&quot;)</span>
<span class="fc" id="L225">                    },</span>
<span class="fc" id="L226">                    fullWidth = true,</span>
<span class="fc" id="L227">                    modifier = Modifier.padding(horizontal = 2.dp).testTag(TestTags.AddExerciseButton)</span>
<span class="nc" id="L228">                )</span>
<span class="fc" id="L229">            }</span>

<span class="fc" id="L231">            item {</span>
<span class="pc bpc" id="L232" title="3 of 4 branches missed.">                Row(</span>
<span class="fc" id="L233">                    modifier = Modifier</span>
<span class="fc" id="L234">                        .fillMaxWidth()</span>
<span class="fc" id="L235">                        .padding(bottom = 12.dp),</span>
<span class="fc" id="L236">                    horizontalArrangement = Arrangement.Center</span>
                ) {
<span class="pc bpc" id="L238" title="3 of 4 branches missed.">                    OutlinedButton(</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                        onClick = { workoutActions?.finish() },</span>
<span class="fc" id="L240">                        shape = RoundedCornerShape(4.dp),</span>
<span class="fc" id="L241">                        modifier = Modifier.padding(12.dp)</span>
<span class="fc" id="L242">                    ) {</span>
<span class="pc bpc" id="L243" title="1 of 4 branches missed.">                        Text(&quot;Finish Workout&quot;)</span>
<span class="pc" id="L244">                    }</span>
<span class="pc" id="L245">                }</span>
<span class="fc" id="L246">            }</span>
        } else {
<span class="pc" id="L248">            item {</span>
<span class="nc bnc" id="L249" title="All 4 branches missed.">                Box(modifier = Modifier</span>
<span class="nc" id="L250">                    .fillMaxWidth()</span>
<span class="nc" id="L251">                    .padding(bottom = 12.dp))</span>
<span class="nc" id="L252">            }</span>
        }
<span class="fc" id="L254">    }</span>
<span class="fc" id="L255">}</span>

@Composable
fun TimerButton(
    seconds: Long,
    onClick: (OffsetDateTime) -&gt; Unit
<span class="pc bpc" id="L261" title="6 of 12 branches missed.">) {</span>
<span class="fc" id="L262">    TextButton(</span>
<span class="fc" id="L263">        onClick = {</span>
<span class="nc" id="L264">            onClick(OffsetDateTime.now().minusSeconds(seconds - 1))</span>
<span class="nc" id="L265">        }</span>
<span class="fc" id="L266">    ) {</span>
<span class="pc bpc" id="L267" title="2 of 4 branches missed.">        Text(&quot;${seconds}s&quot;)</span>
<span class="fc" id="L268">    }</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">}</span>

@Preview(showBackground = true)
@Composable
<span class="nc bnc" id="L273" title="All 4 branches missed.">fun AddWorkoutFormPreview() {</span>
<span class="nc" id="L274">    val workoutState = Workout(</span>
<span class="nc" id="L275">        id = 1L,</span>
<span class="nc" id="L276">        completedAt = OffsetDateTime.now().minusDays(3),</span>
<span class="nc" id="L277">        addedAt = OffsetDateTime.now().minusDays(10),</span>
<span class="nc" id="L278">        sets = listOf(</span>
<span class="nc" id="L279">            ExerciseSet(</span>
<span class="nc" id="L280">                exercise = Exercise(</span>
<span class="nc" id="L281">                    &quot;Bicep Curls&quot;,</span>
<span class="nc" id="L282">                    musclesWorked = listOf(&quot;Bicep&quot;, &quot;Tricep&quot;),</span>
                ),
<span class="nc" id="L284">                reps = 10,</span>
<span class="nc" id="L285">                weightInPounds = 20f,</span>
<span class="nc" id="L286">                id = 20</span>
            )
        )
    )

<span class="nc" id="L291">    val scrollState = rememberLazyListState()</span>

<span class="nc" id="L293">    WorkoutDetails(</span>
<span class="nc" id="L294">        workout = workoutState,</span>
<span class="nc" id="L295">        sets = workoutState.sets.map { set -&gt;</span>
<span class="nc" id="L296">            UiExercise(</span>
<span class="nc" id="L297">                name = set.exercise.name,</span>
<span class="nc" id="L298">                exercise = set.exercise,</span>
<span class="nc" id="L299">                group = null,</span>
<span class="nc" id="L300">                position = 1</span>
            )
        },
<span class="nc" id="L303">        scrollState = scrollState,</span>
<span class="nc" id="L304">        unit = WeightUnit.Pounds,</span>
<span class="nc" id="L305">        workoutActions = null,</span>
<span class="nc" id="L306">        exerciseUiActions = null,</span>
<span class="nc" id="L307">        exerciseNavigableActions = null,</span>
    )
<span class="nc bnc" id="L309" title="All 2 branches missed.">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>