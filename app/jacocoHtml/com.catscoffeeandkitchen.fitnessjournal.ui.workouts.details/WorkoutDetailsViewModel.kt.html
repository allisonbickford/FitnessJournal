<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkoutDetailsViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details</a> &gt; <span class="el_source">WorkoutDetailsViewModel.kt</span></div><h1>WorkoutDetailsViewModel.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details

import android.content.Context
import android.content.Intent
import android.content.SharedPreferences
import androidx.compose.runtime.MutableState
import androidx.compose.runtime.State
import androidx.compose.runtime.mutableStateOf
import androidx.lifecycle.SavedStateHandle
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.catscoffeeandkitchen.domain.models.*
import com.catscoffeeandkitchen.domain.usecases.*
import com.catscoffeeandkitchen.domain.usecases.exercise.*
import com.catscoffeeandkitchen.domain.usecases.exercisegroup.UpdateExercisesInGroupUseCase
import com.catscoffeeandkitchen.domain.usecases.exerciseset.AddExerciseSetUseCase
import com.catscoffeeandkitchen.domain.usecases.exerciseset.AddMultipleExerciseSetsUseCase
import com.catscoffeeandkitchen.domain.usecases.exerciseset.ReplaceExerciseForSetsUseCase
import com.catscoffeeandkitchen.domain.usecases.workoutplan.AddSetToWorkoutPlanUseCase
import com.catscoffeeandkitchen.domain.usecases.workoutplan.CreatePlanFromWorkoutUseCase
import com.catscoffeeandkitchen.domain.util.DataState
import com.catscoffeeandkitchen.fitnessjournal.services.TimerService
import com.catscoffeeandkitchen.fitnessjournal.services.TimerServiceConnection
import com.catscoffeeandkitchen.fitnessjournal.ui.util.SharedPrefsConstants.WeightUnitKey
import com.catscoffeeandkitchen.fitnessjournal.ui.util.WeightUnit
import com.catscoffeeandkitchen.fitnessjournal.ui.util.WeightUnit.Pounds
import com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details.exercise.ExerciseUiActions
import dagger.hilt.android.lifecycle.HiltViewModel
import dagger.hilt.android.qualifiers.ApplicationContext
import kotlinx.coroutines.Job
import kotlinx.coroutines.launch
import timber.log.Timber
import java.time.Instant
import java.time.OffsetDateTime
import java.time.ZoneOffset
import javax.inject.Inject
import kotlin.math.roundToInt

@HiltViewModel
<span class="fc" id="L40">class WorkoutDetailsViewModel @Inject constructor(</span>
<span class="fc" id="L41">    private val createWorkoutUseCase: CreateWorkoutUseCase,</span>
<span class="fc" id="L42">    private val createPlanFromWorkoutUseCase: CreatePlanFromWorkoutUseCase,</span>
<span class="fc" id="L43">    private val updateWorkoutUseCase: UpdateWorkoutUseCase,</span>
<span class="fc" id="L44">    private val addSetUseCase: AddExerciseSetUseCase,</span>
<span class="fc" id="L45">    private val addMultipleSetsUseCase: AddMultipleExerciseSetsUseCase,</span>
<span class="fc" id="L46">    private val addEntryUseCase: AddWorkoutEntryUseCase,</span>
<span class="fc" id="L47">    private val removeExerciseUseCase: RemoveExerciseFromWorkoutUseCase,</span>
<span class="fc" id="L48">    private val replaceExerciseForSetsUseCase: ReplaceExerciseForSetsUseCase,</span>
<span class="fc" id="L49">    private val updateSetUseCase: UpdateSetUseCase,</span>
<span class="fc" id="L50">    private val updateMultipleSetsUseCase: UpdateMultipleSetsUseCase,</span>
<span class="fc" id="L51">    private val updateExercisePositionUseCase: UpdateExercisePositionUseCase,</span>
<span class="fc" id="L52">    private val updateExercisesInGroupUseCase: UpdateExercisesInGroupUseCase,</span>
<span class="fc" id="L53">    private val chooseExerciseInGroupUseCase: ChooseExerciseInGroupUseCase,</span>
<span class="fc" id="L54">    private val replaceExerciseWithGroup: ReplaceExerciseWithGroupUseCase,</span>
<span class="fc" id="L55">    private val getWorkoutUseCase: GetWorkoutUseCase,</span>
<span class="fc" id="L56">    private val removeSetUseCase: RemoveSetUseCase,</span>
<span class="fc" id="L57">    private val sharedPreferences: SharedPreferences,</span>
<span class="fc" id="L58">    val timerServiceConnection: TimerServiceConnection,</span>
    savedStateHandle: SavedStateHandle,
<span class="pc" id="L60">    @ApplicationContext val context: Context,</span>
<span class="fc" id="L61">): ViewModel(), ExerciseUiActions {</span>
<span class="pc" id="L62">    var cachedWorkout: Workout? = null</span>
    private var connectionIsBound = false

<span class="fc" id="L65">    private var _workout: MutableState&lt;DataState&lt;Workout&gt;&gt; = mutableStateOf(DataState.NotSent())</span>
<span class="fc" id="L66">    val workout: State&lt;DataState&lt;Workout&gt;&gt; = _workout</span>

<span class="fc" id="L68">    private var _weightUnit: MutableState&lt;WeightUnit&gt; = mutableStateOf(Pounds)</span>
<span class="fc" id="L69">    val weightUnit: State&lt;WeightUnit&gt; = _weightUnit</span>

    private val workoutInstance: Workout?
        get() {
<span class="fc bfc" id="L73" title="All 4 branches covered.">            val data = (_workout.value as? DataState.Success)?.data</span>
<span class="pc bpc" id="L74" title="2 of 6 branches missed.">            return if (data?.id == 0L) null</span>
<span class="fc" id="L75">            else data</span>
        }

    val exercises: List&lt;UiExercise&gt;
<span class="pc bpc" id="L79" title="2 of 4 branches missed.">        get() = workoutInstance?.entries.orEmpty().map { entry -&gt;</span>
<span class="fc" id="L80">                    UiExercise(</span>
<span class="fc" id="L81">                        name = entry.name,</span>
<span class="fc" id="L82">                        position = entry.position,</span>
<span class="pc bpc" id="L83" title="3 of 4 branches missed.">                        exercise = entry.exercise ?: entry.expectedSet?.exercise,</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">                        group = entry.expectedSet?.exerciseGroup,</span>
                    )
<span class="fc" id="L86">                }.sortedBy { it.position }</span>

    val finishedExercises: List&lt;UiExercise&gt;
<span class="nc bnc" id="L89" title="All 4 branches missed.">        get() = workoutInstance?.entries.orEmpty()</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">            .filter { it.sets.any { set -&gt; set.isComplete } }</span>
<span class="nc" id="L91">            .map { UiExercise(</span>
<span class="nc" id="L92">                name = it.name,</span>
<span class="nc" id="L93">                exercise = it.exercise,</span>
<span class="nc" id="L94">                position = it.position</span>
            ) }
<span class="nc" id="L96">            .sortedBy { it.position }</span>

    val cachedFinishedExercises: List&lt;UiExercise&gt;
<span class="nc bnc" id="L99" title="All 4 branches missed.">        get() = cachedWorkout?.entries.orEmpty()</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">            .filter { it.sets.any { set -&gt; set.isComplete } }</span>
<span class="nc" id="L101">            .map { UiExercise(</span>
<span class="nc" id="L102">                name = it.name,</span>
<span class="nc" id="L103">                exercise = it.exercise,</span>
<span class="nc" id="L104">                position = it.position</span>
            ) }
<span class="nc" id="L106">            .sortedBy { it.position }</span>

    val cachedExercises: List&lt;UiExercise&gt;
<span class="nc bnc" id="L109" title="All 4 branches missed.">        get() = cachedWorkout?.entries.orEmpty().map { entry -&gt;</span>
<span class="nc" id="L110">                    UiExercise(</span>
<span class="nc" id="L111">                        name = entry.name,</span>
<span class="nc" id="L112">                        position = entry.position,</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">                        exercise = entry.exercise ?: entry.expectedSet?.exercise,</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                        group = entry.expectedSet?.exerciseGroup,</span>
                    )
<span class="nc" id="L116">                }.sortedBy { it.position }</span>

<span class="fc" id="L118">    init {</span>
<span class="fc" id="L119">        val workoutId = savedStateHandle.get&lt;Long&gt;(&quot;workoutId&quot;)</span>
<span class="fc" id="L120">        val plan = savedStateHandle.get&lt;String?&gt;(&quot;plan&quot;)</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (workoutId != null) {</span>
<span class="pc bpc" id="L122" title="2 of 4 branches missed.">            if (workoutId == 0L &amp;&amp; _workout.value is DataState.NotSent) {</span>
<span class="fc" id="L123">                viewModelScope.launch {</span>
<span class="fc" id="L124">                    createWorkoutUseCase.run(</span>
<span class="fc" id="L125">                        Workout(id = 0L),</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">                        planId = plan?.toLong()</span>
<span class="fc" id="L127">                    ).collect { state -&gt;</span>
<span class="fc" id="L128">                        _workout.value = state</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">                        if (state is DataState.Success) {</span>
<span class="fc" id="L130">                            savedStateHandle[&quot;workoutId&quot;] = state.data.id</span>
                        }
<span class="fc" id="L132">                    }</span>
<span class="fc" id="L133">                }</span>
            } else {
<span class="nc" id="L135">                viewModelScope.launch {</span>
<span class="nc" id="L136">                    getWorkoutUseCase.run(workoutId).collect { wo -&gt;</span>
<span class="nc" id="L137">                        _workout.value = wo</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">                        cachedWorkout = (wo as? DataState.Success)?.data</span>
<span class="nc" id="L139">                    }</span>
<span class="nc" id="L140">                }</span>
            }
        }

<span class="fc" id="L144">        val unit = sharedPreferences.getInt(WeightUnitKey, 0)</span>
<span class="pc bpc" id="L145" title="3 of 6 branches missed.">        _weightUnit.value = WeightUnit.values().firstOrNull { it.ordinal == unit } ?: Pounds</span>
<span class="fc" id="L146">    }</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">    fun getWorkout() = viewModelScope.launch {</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">        workoutInstance?.let { currentWorkout -&gt;</span>
<span class="fc" id="L150">            viewModelScope.launch {</span>
<span class="fc" id="L151">                getWorkoutUseCase.run(currentWorkout.id).collect { wo -&gt;</span>
<span class="fc" id="L152">                    _workout.value = wo</span>
<span class="fc bfc" id="L153" title="All 4 branches covered.">                    cachedWorkout = (wo as? DataState.Success)?.data</span>
<span class="fc" id="L154">                }</span>
<span class="fc" id="L155">            }</span>
<span class="fc" id="L156">        }</span>
<span class="pc" id="L157">    }</span>

    override fun swapExercise(
        exercisePosition: Int,
        exercise: Exercise,
<span class="nc" id="L162">    ) = viewModelScope.launch {</span>
<span class="nc" id="L163">        val instance = workoutInstance</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (instance != null) {</span>
<span class="nc" id="L165">            val relatedSets = instance.entries</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">                .filter { it.position == exercisePosition }.flatMap { it.sets }</span>

<span class="nc" id="L168">            replaceExerciseForSetsUseCase.run(</span>
<span class="nc" id="L169">                relatedSets.map { it.id },</span>
<span class="nc" id="L170">                exercise,</span>
<span class="nc" id="L171">                exercisePosition,</span>
<span class="nc" id="L172">                instance.addedAt</span>
<span class="nc" id="L173">            ).collect { state -&gt;</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                if (state is DataState.Success) {</span>
<span class="nc" id="L175">                    val updatedWorkout = instance.copy(</span>
<span class="nc" id="L176">                        sets = instance.sets.map { set -&gt;</span>
<span class="nc bnc" id="L177" title="All 6 branches missed.">                            if (relatedSets.any { it.id == set.id }) set.copy(exercise = state.data)</span>
<span class="nc" id="L178">                            else set</span>
<span class="nc" id="L179">                        }.sortedBy { it.setNumber }</span>
                    )
<span class="nc" id="L181">                    _workout.value = DataState.Success(updatedWorkout)</span>
                }
<span class="nc" id="L183">            }</span>
        }
<span class="nc" id="L185">    }</span>

<span class="fc" id="L187">    override fun addExercise(name: String) = viewModelScope.launch {</span>
<span class="pc bpc" id="L188" title="3 of 6 branches missed.">        (workout.value as? DataState.Success)?.data?.let { currentWorkout -&gt;</span>
<span class="fc" id="L189">            addEntryUseCase.run(</span>
<span class="fc" id="L190">                entry = WorkoutEntry(</span>
<span class="fc" id="L191">                    position = currentWorkout.entries.size + 1,</span>
<span class="fc" id="L192">                    exercise = Exercise(name = name)</span>
                ),
<span class="fc" id="L194">                workoutAddedAt = currentWorkout.addedAt,</span>
<span class="fc" id="L195">            ).collect { state -&gt;</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">                if (state is DataState.Success) {</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">                    workoutInstance?.let {</span>
<span class="fc" id="L198">                        _workout.value = DataState.Success(</span>
<span class="fc" id="L199">                            it.copy(entries = it.entries + state.data)</span>
                        )
<span class="fc" id="L201">                    }</span>
                }
<span class="fc" id="L203">            }</span>
<span class="fc" id="L204">        }</span>
<span class="fc" id="L205">    }</span>

<span class="nc" id="L207">    fun updateWorkoutName(name: String) = viewModelScope.launch {</span>
<span class="nc bnc" id="L208" title="All 6 branches missed.">        (workout.value as? DataState.Success)?.data?.let { currentWorkout -&gt;</span>
<span class="nc" id="L209">            _workout.value = DataState.Loading()</span>
<span class="nc" id="L210">            val updatedWorkout = currentWorkout.copy(name = name)</span>
<span class="nc" id="L211">            updateWorkoutUseCase.run(updatedWorkout).collect { updated -&gt;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (updated is DataState.Success) {</span>
<span class="nc" id="L213">                    cachedWorkout = updatedWorkout</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                } else if (updated is DataState.Error) {</span>
<span class="nc" id="L215">                    _workout.value = DataState.Error(updated.e)</span>
                }
<span class="nc" id="L217">            }</span>
<span class="nc" id="L218">        }</span>
<span class="nc" id="L219">    }</span>

<span class="nc" id="L221">    fun finishWorkout() = viewModelScope.launch {</span>
<span class="nc bnc" id="L222" title="All 6 branches missed.">        (workout.value as? DataState.Success)?.data?.let { currentWorkout -&gt;</span>
<span class="nc" id="L223">            _workout.value = DataState.Loading()</span>
<span class="nc" id="L224">            val updatedWorkout = currentWorkout.copy(completedAt = OffsetDateTime.now())</span>
<span class="nc" id="L225">            updateWorkoutUseCase.run(updatedWorkout).collect { updated -&gt;</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                if (updated is DataState.Success) {</span>
<span class="nc" id="L227">                    cachedWorkout = updatedWorkout</span>
<span class="nc" id="L228">                    _workout.value = DataState.Success(updatedWorkout)</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                } else if (updated is DataState.Error) {</span>
<span class="nc" id="L230">                    _workout.value = DataState.Error(updated.e)</span>
                }
<span class="nc" id="L232">            }</span>
<span class="nc" id="L233">        }</span>
<span class="nc" id="L234">    }</span>

<span class="nc" id="L236">    fun updateWorkoutNote(note: String?) = viewModelScope.launch {</span>
<span class="nc bnc" id="L237" title="All 6 branches missed.">        (workout.value as? DataState.Success)?.data?.let { currentWorkout -&gt;</span>
<span class="nc" id="L238">            _workout.value = DataState.Loading()</span>
<span class="nc" id="L239">            val updatedWorkout = currentWorkout.copy(note = note)</span>
<span class="nc" id="L240">            updateWorkoutUseCase.run(updatedWorkout).collect { updated -&gt;</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                if (updated is DataState.Success) {</span>
<span class="nc" id="L242">                    _workout.value = DataState.Success(updatedWorkout)</span>
<span class="nc" id="L243">                    cachedWorkout = updatedWorkout</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                } else if (updated is DataState.Error) {</span>
<span class="nc" id="L245">                    _workout.value = DataState.Error(updated.e)</span>
                }
<span class="nc" id="L247">            }</span>
<span class="nc" id="L248">        }</span>
<span class="nc" id="L249">    }</span>

<span class="nc" id="L251">    fun createPlanFromWorkout() = viewModelScope.launch {</span>
<span class="nc bnc" id="L252" title="All 6 branches missed.">        (workout.value as? DataState.Success)?.data?.let { wkot -&gt;</span>
<span class="nc" id="L253">            createPlanFromWorkoutUseCase.run(wkot).collect { dataState -&gt;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">                if (dataState is DataState.Success) {</span>
<span class="nc" id="L255">                    getWorkout()</span>
                }
<span class="nc" id="L257">            }</span>
<span class="nc" id="L258">        }</span>
<span class="nc" id="L259">    }</span>

<span class="nc" id="L261">    override fun removeEntry(entry: WorkoutEntry) = viewModelScope.launch {</span>
<span class="nc bnc" id="L262" title="All 6 branches missed.">        (workout.value as? DataState.Success)?.data?.let { wkot -&gt;</span>
<span class="nc" id="L263">            removeExerciseUseCase.run(entry, wkot.addedAt).collect { state -&gt;</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                if (state is DataState.Success) {</span>
<span class="nc" id="L265">                    getWorkout()</span>
                }
<span class="nc" id="L267">            }</span>
<span class="nc" id="L268">        }</span>
<span class="nc" id="L269">    }</span>

<span class="nc" id="L271">    override fun moveEntryTo(entry: WorkoutEntry, newPosition: Int) = viewModelScope.launch {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        workoutInstance?.let { instance -&gt;</span>
<span class="nc" id="L273">            updateExercisePositionUseCase.run(</span>
<span class="nc" id="L274">                instance.addedAt,</span>
<span class="nc" id="L275">                entry,</span>
<span class="nc" id="L276">                newPosition,</span>
<span class="nc" id="L277">            ).collect { result -&gt;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                if (result is DataState.Success) {</span>
<span class="nc" id="L279">                    getWorkout()</span>
                }
<span class="nc" id="L281">            }</span>
<span class="nc" id="L282">        }</span>
<span class="nc" id="L283">    }</span>

    override fun addExerciseSet(
        entry: WorkoutEntry,
        workoutId: Long
<span class="fc" id="L288">    ) = viewModelScope.launch {</span>
<span class="fc" id="L289">        addSetUseCase.run(</span>
<span class="fc" id="L290">            entry,</span>
<span class="fc" id="L291">            workoutId = workoutId,</span>
<span class="fc" id="L292">            set = ExerciseSet(</span>
<span class="fc" id="L293">                0L,</span>
<span class="fc" id="L294">                exercise = entry.exercise!!,</span>
<span class="fc" id="L295">                reps = 0,</span>
<span class="fc" id="L296">                setNumber = 0</span>
            )
<span class="fc" id="L298">        ).collect { state -&gt;</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">            if (state is DataState.Success) {</span>
<span class="nc bnc" id="L300" title="All 6 branches missed.">                (workout.value as? DataState.Success)?.data?.let { wkot -&gt;</span>
<span class="nc" id="L301">                    _workout.value = DataState.Success(</span>
<span class="nc" id="L302">                        wkot.copy(entries = wkot.entries.map { entry -&gt;</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">                            if (entry.position == state.data.position)</span>
<span class="nc" id="L304">                                state.data</span>
                            else
<span class="nc" id="L306">                                entry</span>
                        })
                    )
<span class="nc" id="L309">                }</span>
            }
<span class="fc" id="L311">        }</span>
<span class="pc" id="L312">    }</span>

    override fun updateSet(
        set: ExerciseSet,
<span class="nc" id="L316">    ) = viewModelScope.launch {</span>
<span class="nc" id="L317">        updateSetUseCase.run(</span>
<span class="nc" id="L318">            set = set,</span>
<span class="nc" id="L319">        ).collect { state -&gt;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if (state is DataState.Success) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                workoutInstance?.let { instance -&gt;</span>
<span class="nc" id="L322">                    _workout.value = DataState.Success(</span>
<span class="nc" id="L323">                        instance.copy(entries = instance.entries.map { entry -&gt;</span>
<span class="nc" id="L324">                            entry.copy(sets = entry.sets.map { set -&gt;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                                if (set.id == state.data.id) {</span>
<span class="nc" id="L326">                                    state.data</span>
                                } else {
<span class="nc" id="L328">                                    set</span>
                                }
<span class="nc" id="L330">                            }.sortedBy { it.setNumber })</span>
                        })
                    )
<span class="nc" id="L333">                }</span>
            }
<span class="nc" id="L335">        }</span>
<span class="nc" id="L336">    }</span>

<span class="nc" id="L338">    override fun updateSets(sets: List&lt;ExerciseSet&gt;) = viewModelScope.launch {</span>
<span class="nc" id="L339">        updateMultipleSetsUseCase.run(sets).collect { state -&gt;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">            if (state is DataState.Success) {</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">                workoutInstance?.let { instance -&gt;</span>
<span class="nc" id="L342">                    _workout.value = DataState.Success(</span>
<span class="nc" id="L343">                        instance.copy(entries = instance.entries.map { entry -&gt;</span>
<span class="nc" id="L344">                            entry.copy(sets = entry.sets.map { set -&gt;</span>
<span class="nc bnc" id="L345" title="All 6 branches missed.">                                val setToUse = sets.find { it.id == set.id }</span>
<span class="nc bnc" id="L346" title="All 8 branches missed.">                                Timber.d(&quot;*** setToUse = ${setToUse?.setNumber} (${setToUse?.id}), reps = ${setToUse?.reps}, pounds = ${setToUse?.weightInPounds}&quot;)</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                                setToUse ?: set</span>
<span class="nc" id="L348">                            }.sortedBy { it.setNumber })</span>
                        })
                    )
<span class="nc" id="L351">                }</span>
            }
<span class="nc" id="L353">        }</span>
<span class="nc" id="L354">    }</span>

    override fun removeSet(
        set: ExerciseSet,
        workoutId: Long,
<span class="nc" id="L359">    ) = viewModelScope.launch {</span>
<span class="nc" id="L360">        removeSetUseCase.run(set, workoutId).collect { dataState -&gt;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">            if (dataState is DataState.Error) {</span>
<span class="nc" id="L362">                Timber.e(dataState.e)</span>
            }
<span class="nc bnc" id="L364" title="All 2 branches missed.">            if (dataState is DataState.Success) {</span>
                // filter out the set from the workout
<span class="nc bnc" id="L366" title="All 2 branches missed.">                workoutInstance?.let { currentWorkout -&gt;</span>
<span class="nc" id="L367">                    _workout.value = DataState.Success(currentWorkout.copy(</span>
<span class="nc" id="L368">                        entries = currentWorkout.entries.mapNotNull { entry -&gt;</span>
<span class="nc bnc" id="L369" title="All 12 branches missed.">                            if (entry.sets.isNotEmpty() &amp;&amp; entry.sets.all { it.id == set.id }) {</span>
<span class="nc" id="L370">                                null</span>
                            } else {
<span class="nc bnc" id="L372" title="All 4 branches missed.">                                entry.copy(sets = entry.sets.filterNot { s -&gt; s.id == set.id }</span>
<span class="nc" id="L373">                                    .sortedBy { it.setNumber })</span>
                            }
                        }
                    )
<span class="nc" id="L377">                )}</span>
            }
<span class="nc" id="L379">        }</span>
<span class="nc" id="L380">    }</span>

    override fun addWarmupSets(
        workoutId: Long,
        entry: WorkoutEntry,
        unit: WeightUnit
<span class="nc" id="L386">    ) = viewModelScope.launch {</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        val highWeight = if (unit == WeightUnit.Pounds)</span>
<span class="nc bnc" id="L388" title="All 4 branches missed.">            entry.sets.maxOf { it.weightInPounds } else</span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">            entry.sets.maxOf { it.weightInKilograms }</span>

<span class="nc" id="L391">        val increments = mapOf(</span>
<span class="nc" id="L392">            .25 to 12,</span>
<span class="nc" id="L393">            .575 to 8,</span>
<span class="nc" id="L394">            .725 to 5,</span>
<span class="nc" id="L395">            .825 to 3,</span>
<span class="nc" id="L396">            .925 to 1</span>
        )

<span class="nc" id="L399">        var nextSetNumber = 1</span>
<span class="nc" id="L400">        val setsToAdd = arrayListOf&lt;ExerciseSet&gt;()</span>
<span class="nc" id="L401">        increments.forEach { warmupSet -&gt;</span>
<span class="nc" id="L402">            setsToAdd.add(</span>
<span class="nc" id="L403">                ExerciseSet(</span>
<span class="nc" id="L404">                    0L,</span>
<span class="nc bnc" id="L405" title="All 6 branches missed.">                    exercise = entry.exercise ?: entry.expectedSet?.exercise ?: Exercise(name = &quot;Unknown Exercise&quot;),</span>
<span class="nc" id="L406">                    reps = warmupSet.value,</span>
<span class="nc" id="L407">                    setNumber = nextSetNumber,</span>
<span class="nc" id="L408">                    weightInPounds = round(warmupSet.key * highWeight, 5).toFloat(),</span>
<span class="nc" id="L409">                    weightInKilograms = round(warmupSet.key * highWeight, 5).toFloat(),</span>
<span class="nc" id="L410">                    type = ExerciseSetType.WarmUp</span>
                )
            )
<span class="nc" id="L413">            nextSetNumber++</span>
<span class="nc" id="L414">        }</span>

<span class="nc" id="L416">        addMultipleSetsUseCase.run(</span>
<span class="nc" id="L417">            entry = entry,</span>
<span class="nc" id="L418">            workoutId = workoutId,</span>
<span class="nc" id="L419">            sets = setsToAdd</span>
<span class="nc" id="L420">        ).collect { state -&gt;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">            if (state is DataState.Success) {</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                workoutInstance?.let { wo -&gt;</span>
<span class="nc" id="L423">                    _workout.value = DataState.Success(</span>
<span class="nc" id="L424">                        wo.copy(entries = wo.entries.map { item -&gt;</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">                            if (entry.position == item.position) state.data.copy(</span>
<span class="nc" id="L426">                                sets = state.data.sets.sortedBy { it.setNumber })</span>
<span class="nc" id="L427">                            else item</span>
                        })
<span class="nc" id="L429">                    )}</span>
            }
<span class="nc" id="L431">        }</span>
<span class="nc" id="L432">    }</span>

<span class="nc" id="L434">    override fun replaceWithGroup(entry: WorkoutEntry): Job = viewModelScope.launch {</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        workoutInstance?.let { wo -&gt;</span>
<span class="nc" id="L436">            replaceExerciseWithGroup.run(wo.addedAt, entry).collect { state -&gt;</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                if (state is DataState.Success) {</span>
<span class="nc" id="L438">                    _workout.value = DataState.Success(wo.copy(entries = wo.entries.map { item -&gt;</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                        if (item.position == entry.position) {</span>
<span class="nc" id="L440">                            state.data</span>
                        } else {
<span class="nc" id="L442">                            item</span>
                        }
                    }))
                }
<span class="nc" id="L446">            }</span>
<span class="nc" id="L447">        }</span>
<span class="nc" id="L448">    }</span>

    override fun selectExerciseFromGroup(
        group: ExerciseGroup,
        exercise: Exercise,
        position: Int,
        expectedSet: ExpectedSet?,
<span class="nc" id="L455">    ) = viewModelScope.launch {</span>
<span class="nc bnc" id="L456" title="All 6 branches missed.">        (workout.value as? DataState.Success)?.data?.let { workout -&gt;</span>
<span class="nc" id="L457">            chooseExerciseInGroupUseCase</span>
<span class="nc" id="L458">                .run(workout.addedAt, group, exercise, position, expectedSet)</span>
<span class="nc" id="L459">                .collect { result -&gt;</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                    if (result is DataState.Success) {</span>
<span class="nc" id="L461">                        getWorkout()</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                    } else if (result is DataState.Error) {</span>
<span class="nc" id="L463">                        Timber.e(result.e)</span>
                    }
<span class="nc" id="L465">            }</span>
<span class="nc" id="L466">        }</span>
<span class="nc" id="L467">    }</span>

    fun editGroup(
        exerciseGroup: ExerciseGroup,
        selectedExercises: List&lt;String&gt;,
<span class="nc" id="L472">    ) = viewModelScope.launch {</span>
<span class="nc" id="L473">        updateExercisesInGroupUseCase.run(exerciseGroup, selectedExercises).collect { state -&gt;</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">            if (state is DataState.Success) {</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">                workoutInstance?.let { _workout.value = DataState.Success(it.copy(</span>
<span class="nc" id="L476">                    entries = it.entries.map { entry -&gt;</span>
<span class="nc bnc" id="L477" title="All 8 branches missed.">                        if (entry.expectedSet?.exerciseGroup?.id == exerciseGroup.id) {</span>
<span class="nc" id="L478">                            entry.copy(</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">                                expectedSet = entry.expectedSet?.copy(</span>
<span class="nc" id="L480">                                    exerciseGroup = state.data</span>
                                )
                            )
                        } else {
<span class="nc" id="L484">                            entry</span>
                        }
                    }
<span class="nc" id="L487">                )) }</span>
            }
<span class="nc" id="L489">        }</span>
<span class="nc" id="L490">    }</span>

    private fun round(value: Double, nearest: Int): Int {
<span class="nc" id="L493">        return (value / nearest).roundToInt() * nearest</span>
    }

    fun startTimerNotification(seconds: Long) {
<span class="nc bnc" id="L497" title="All 2 branches missed.">        timerServiceConnection.timerService?.cancelTimer()</span>

<span class="nc" id="L499">        val intent = Intent(context, TimerService::class.java)</span>
<span class="nc" id="L500">        intent.putExtra(&quot;seconds&quot;, seconds)</span>

<span class="nc" id="L502">        context.startForegroundService(intent)</span>
<span class="nc" id="L503">        connectionIsBound = context.bindService(intent, timerServiceConnection, Context.BIND_AUTO_CREATE)</span>
<span class="nc" id="L504">    }</span>

    override fun onCleared() {
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">        if (connectionIsBound) {</span>
<span class="nc" id="L508">            context.unbindService(timerServiceConnection)</span>
        }
<span class="fc" id="L510">        super.onCleared()</span>
<span class="fc" id="L511">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>