<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchExercisesScreen.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.workouts.searchexercises</a> &gt; <span class="el_source">SearchExercisesScreen.kt</span></div><h1>SearchExercisesScreen.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.workouts.searchexercises

import androidx.annotation.VisibleForTesting
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.clickable
import androidx.compose.foundation.combinedClickable
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.ColorFilter
import androidx.compose.ui.graphics.ColorMatrix
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.navigation.NavController
import androidx.navigation.compose.currentBackStackEntryAsState
import androidx.paging.LoadState
import androidx.paging.compose.collectAsLazyPagingItems
import androidx.paging.compose.items
import androidx.test.espresso.idling.CountingIdlingResource
import com.bumptech.glide.integration.compose.ExperimentalGlideComposeApi
import com.bumptech.glide.integration.compose.GlideImage
import com.catscoffeeandkitchen.domain.models.Exercise
import com.catscoffeeandkitchen.domain.util.capitalizeWords
import com.catscoffeeandkitchen.fitnessjournal.TestTags
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalButton
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalCard
import com.catscoffeeandkitchen.fitnessjournal.ui.workouts.searchexercises.create.CreateOrChangeExerciseDialog
import timber.log.Timber

@OptIn(ExperimentalMaterial3Api::class, ExperimentalFoundationApi::class)
@Composable
fun SearchExercisesScreen(
    navController: NavController,
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">    modifier: Modifier = Modifier,</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">    muscle: String? = null,</span>
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">    category: String? = null,</span>
<span class="fc" id="L45">    viewModel: SearchExercisesViewModel = hiltViewModel(),</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">    ) {</span>
<span class="fc" id="L47">    val searchState = viewModel.searchRequest.collectAsState(</span>
<span class="fc" id="L48">        initial = ExerciseSearch(</span>
<span class="fc" id="L49">            muscle = muscle, category = category</span>
        ))
<span class="fc" id="L51">    val pagingItems = viewModel.pagedExerciseFlow.collectAsLazyPagingItems()</span>
<span class="pc" id="L52">    var showCreateExerciseDialog by remember { mutableStateOf(false) }</span>
<span class="pc" id="L53">    var editingExercise by remember { mutableStateOf(null as Exercise?) }</span>

<span class="fc" id="L55">    val coroutineScope = rememberCoroutineScope()</span>
<span class="fc" id="L56">    LaunchedEffect(coroutineScope) {</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (pagingItems.itemSnapshotList.isEmpty()) {</span>
<span class="fc" id="L58">            viewModel.searchExercises(searchState.value)</span>
        }
<span class="pc" id="L60">    }</span>

<span class="pc bpc" id="L62" title="1 of 2 branches missed.">    if (showCreateExerciseDialog) {</span>
<span class="pc" id="L63">        CreateOrChangeExerciseDialog(</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">            isCreating = editingExercise == null,</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            currentExercise = editingExercise ?:</span>
<span class="nc" id="L66">                Exercise(</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">                    name = searchState.value.name.capitalizeWords().orEmpty(),</span>
<span class="nc" id="L68">                    musclesWorked = emptyList()</span>
                ),
<span class="nc" id="L70">            onDismiss = { showCreateExerciseDialog = false },</span>
            onConfirm = { exercise -&gt;
<span class="nc bnc" id="L72" title="All 2 branches missed.">                if  (editingExercise == null) {</span>
<span class="nc" id="L73">                    viewModel.createExercise(exercise) {</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">                        navController.previousBackStackEntry?.savedStateHandle?.set(</span>
<span class="nc" id="L75">                            &quot;exerciseToAdd&quot;,</span>
<span class="nc" id="L76">                            exercise.name</span>
                        )
<span class="nc" id="L78">                        navController.popBackStack()</span>
<span class="nc" id="L79">                    }</span>
                } else {
<span class="nc" id="L81">                    viewModel.updateExercise(exercise, refreshItems = { pagingItems.refresh() })</span>
                }
<span class="nc" id="L83">                showCreateExerciseDialog = false</span>
<span class="nc" id="L84">            }</span>
        )
    }

<span class="pc bpc" id="L88" title="1 of 2 branches missed.">    LazyColumn(modifier = modifier.testTag(TestTags.ScrollableComponent)) {</span>
<span class="fc" id="L89">        stickyHeader {</span>
<span class="pc bpc" id="L90" title="3 of 4 branches missed.">            SearchExerciseHeader(</span>
<span class="fc" id="L91">                currentSearch = searchState.value.name,</span>
<span class="fc" id="L92">                currentCategoryFilter = searchState.value.category,</span>
<span class="fc" id="L93">                currentMuscleFilter = searchState.value.muscle,</span>
                onSearch = { text -&gt;
<span class="nc" id="L95">                    viewModel.searchExercises(searchState.value.copy(name = text))</span>
<span class="nc" id="L96">                    pagingItems.refresh()</span>
<span class="nc" id="L97">                },</span>
                filterMuscle = { muscle -&gt;
<span class="nc" id="L99">                    viewModel.searchExercises(searchState.value.copy(muscle = muscle))</span>
<span class="nc" id="L100">                    pagingItems.refresh()</span>
<span class="nc" id="L101">                },</span>
                filterCategory = { category -&gt;
<span class="nc" id="L103">                    viewModel.searchExercises(searchState.value.copy(category = category))</span>
<span class="nc" id="L104">                    pagingItems.refresh()</span>
<span class="nc" id="L105">                }</span>
<span class="nc" id="L106">            )</span>
<span class="fc" id="L107">        }</span>

<span class="fc" id="L109">        items(pagingItems) {exercise -&gt;</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">            if (exercise != null) {</span>
<span class="fc" id="L111">                ExerciseItem(exercise,</span>
                    onTap = {
<span class="pc bpc" id="L113" title="2 of 4 branches missed.">                        navController.previousBackStackEntry?.savedStateHandle?.set(</span>
<span class="fc" id="L114">                            &quot;exerciseToAdd&quot;,</span>
<span class="fc" id="L115">                            exercise.name</span>
                        )
<span class="fc" id="L117">                        navController.popBackStack()</span>
<span class="fc" id="L118">                    },</span>
                    onLongPress = {
<span class="nc" id="L120">                        editingExercise = exercise</span>
<span class="nc" id="L121">                        showCreateExerciseDialog = true</span>
<span class="nc" id="L122">                    }</span>
                )
            }
<span class="fc" id="L125">        }</span>

<span class="fc" id="L127">        item {</span>
<span class="pc bpc" id="L128" title="3 of 6 branches missed.">            when (val loadState = pagingItems.loadState.mediator?.refresh) {</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">                is LoadState.Loading -&gt; {</span>
<span class="fc" id="L130">                    Box(</span>
<span class="fc" id="L131">                        modifier = Modifier.fillMaxWidth(),</span>
<span class="fc" id="L132">                        contentAlignment = Alignment.Center</span>
                    ) {
<span class="pc bpc" id="L134" title="3 of 4 branches missed.">                        CircularProgressIndicator()</span>
<span class="pc" id="L135">                    }</span>
                }
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">                is LoadState.Error -&gt; {</span>
<span class="nc" id="L138">                    Divider()</span>
<span class="nc" id="L139">                    Text(loadState.error.message.toString())</span>
                }
<span class="fc" id="L141">                else -&gt; { }</span>
<span class="nc" id="L142">            }</span>
<span class="fc" id="L143">        }</span>

<span class="fc bfc" id="L145" title="All 4 branches covered.">        if (pagingItems.loadState.mediator?.refresh is LoadState.NotLoading) {</span>
<span class="fc" id="L146">            item {</span>
<span class="pc bpc" id="L147" title="3 of 4 branches missed.">                FitnessJournalButton(</span>
<span class="fc" id="L148">                    text = &quot;Create Exercise&quot;,</span>
<span class="fc" id="L149">                    fullWidth = true,</span>
<span class="fc" id="L150">                    onClick = {</span>
<span class="nc" id="L151">                        editingExercise = null</span>
<span class="nc" id="L152">                        showCreateExerciseDialog = true</span>
<span class="nc" id="L153">                    }</span>
<span class="nc" id="L154">                )</span>
<span class="fc" id="L155">            }</span>
        }
<span class="fc" id="L157">    }</span>
<span class="fc" id="L158">}</span>

@OptIn(ExperimentalGlideComposeApi::class, ExperimentalFoundationApi::class)
@Composable
fun ExerciseItem(
    exercise: Exercise,
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">    modifier: Modifier = Modifier.testTag(TestTags.ExerciseSearchResult),</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">    onTap: () -&gt; Unit = {},</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">    onLongPress: () -&gt; Unit = {},</span>
<span class="fc" id="L167">    darkTheme: Boolean = isSystemInDarkTheme(),</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">) {</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">    FitnessJournalCard(</span>
<span class="fc" id="L170">        modifier = modifier</span>
<span class="fc" id="L171">            .fillMaxWidth()</span>
<span class="fc" id="L172">            .padding(horizontal = 8.dp, vertical = 4.dp)</span>
<span class="fc" id="L173">            .combinedClickable(</span>
<span class="fc" id="L174">                onClick = { onTap() },</span>
<span class="pc" id="L175">                onLongClick = { onLongPress() }</span>
            )
<span class="fc" id="L177">    ) {</span>
<span class="pc bpc" id="L178" title="2 of 4 branches missed.">        Row(</span>
<span class="fc" id="L179">            verticalAlignment = Alignment.CenterVertically</span>
        ) {
<span class="pc bpc" id="L181" title="9 of 12 branches missed.">            if (exercise.thumbnailUrl?.isNotEmpty() == true) {</span>
<span class="pc" id="L182">                GlideImage(</span>
<span class="nc" id="L183">                    model = exercise.thumbnailUrl!!,</span>
<span class="nc" id="L184">                    contentDescription = &quot;Exercise Image&quot;,</span>
<span class="nc" id="L185">                    modifier = Modifier</span>
<span class="nc" id="L186">                        .size(60.dp)</span>
<span class="nc" id="L187">                        .padding(6.dp),</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                    colorFilter = if (darkTheme)</span>
<span class="nc" id="L189">                        ColorFilter.colorMatrix(</span>
<span class="nc" id="L190">                            ColorMatrix(floatArrayOf(</span>
<span class="nc" id="L191">                                -1f, 0f, 0f, 0f, 255f,</span>
<span class="nc" id="L192">                                0f, -1f, 0f, 0f, 255f,</span>
<span class="nc" id="L193">                                0f, 0f, -1f, 0f, 255f,</span>
<span class="nc" id="L194">                                0f, 0f, 0f, 1f, 0f</span>
                            ))
<span class="nc" id="L196">                        ) else null</span>
                )
            }

<span class="fc" id="L200">            Column(modifier = Modifier.padding(8.dp)) {</span>
<span class="pc bpc" id="L201" title="3 of 4 branches missed.">                Text(</span>
<span class="fc" id="L202">                    exercise.name,</span>
<span class="fc" id="L203">                    modifier = Modifier.padding(2.dp),</span>
<span class="fc" id="L204">                    style = MaterialTheme.typography.headlineSmall</span>
                )
    //            Text(
    //                &quot;Performed ${exercise} sets&quot;,
    //                modifier = Modifier.padding(2.dp),
    //                style = MaterialTheme.typography.labelSmall
    //            )
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">                exercise.category?.let { Text(it, style = MaterialTheme.typography.labelLarge) }</span>

<span class="pc bpc" id="L213" title="2 of 4 branches missed.">                if (exercise.musclesWorked.isNotEmpty()) {</span>
<span class="fc" id="L214">                    Text(exercise.musclesWorked.joinToString(&quot;, &quot;) { it })</span>
<span class="pc" id="L215">                }</span>
<span class="pc" id="L216">        }</span>
<span class="pc" id="L217">        }</span>
<span class="fc" id="L218">    }</span>
<span class="fc" id="L219">}</span>

@Preview
@Composable
<span class="nc bnc" id="L223" title="All 4 branches missed.">fun ExerciseItemPreview() {</span>
<span class="nc" id="L224">    ExerciseItem(</span>
<span class="nc" id="L225">        Exercise(</span>
<span class="nc" id="L226">            name = &quot;Bicep Curl&quot;,</span>
<span class="nc" id="L227">            musclesWorked = listOf(&quot;Biceps&quot;, &quot;Triceps&quot;),</span>
        )
    )
<span class="nc bnc" id="L230" title="All 2 branches missed.">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>