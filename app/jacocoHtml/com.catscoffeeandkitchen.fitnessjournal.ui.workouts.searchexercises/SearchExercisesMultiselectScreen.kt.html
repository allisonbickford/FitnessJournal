<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchExercisesMultiselectScreen.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.workouts.searchexercises</a> &gt; <span class="el_source">SearchExercisesMultiselectScreen.kt</span></div><h1>SearchExercisesMultiselectScreen.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.workouts.searchexercises

import androidx.compose.foundation.*
import androidx.compose.foundation.gestures.detectTapGestures
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Check
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.ColorFilter
import androidx.compose.ui.graphics.ColorMatrix
import androidx.compose.ui.input.pointer.pointerInput
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.navigation.NavController
import androidx.navigation.compose.currentBackStackEntryAsState
import androidx.paging.LoadState
import androidx.paging.compose.collectAsLazyPagingItems
import androidx.paging.compose.items
import com.bumptech.glide.integration.compose.ExperimentalGlideComposeApi
import com.bumptech.glide.integration.compose.GlideImage
import com.catscoffeeandkitchen.domain.models.Exercise
import com.catscoffeeandkitchen.domain.util.capitalizeWords
import com.catscoffeeandkitchen.fitnessjournal.TestTags
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalButton
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalCard
import com.catscoffeeandkitchen.fitnessjournal.ui.navigation.FitnessJournalScreen
import com.catscoffeeandkitchen.fitnessjournal.ui.workouts.searchexercises.create.CreateOrChangeExerciseDialog
import timber.log.Timber

@OptIn(ExperimentalMaterial3Api::class, ExperimentalFoundationApi::class)
@Composable
fun SearchExercisesMultiSelectScreen(
    navController: NavController,
<span class="nc bnc" id="L42" title="All 2 branches missed.">    modifier: Modifier = Modifier,</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">    muscle: String? = null,</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">    category: String? = null,</span>
<span class="nc" id="L45">    viewModel: SelectExercisesViewModel = hiltViewModel(),</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">    ) {</span>
<span class="nc" id="L47">    val searchState = viewModel.searchRequest.collectAsState(</span>
<span class="nc" id="L48">        initial = ExerciseSearch(</span>
<span class="nc" id="L49">            muscle = muscle, category = category</span>
        ))
<span class="nc" id="L51">    val pagingItems = viewModel.pagedExerciseFlow.collectAsLazyPagingItems()</span>
<span class="nc" id="L52">    val selectedItems = viewModel.selectedExercises.collectAsState(emptyList())</span>
<span class="nc" id="L53">    var showCreateExerciseDialog by remember { mutableStateOf(false) }</span>
<span class="nc" id="L54">    var editingExercise by remember { mutableStateOf(null as Exercise?) }</span>

<span class="nc" id="L56">    val coroutineScope = rememberCoroutineScope()</span>
<span class="nc" id="L57">    LaunchedEffect(coroutineScope) {</span>
<span class="nc" id="L58">        Timber.d(&quot;*** launchedEffect muscle = $muscle, category = $category&quot;)</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (pagingItems.itemSnapshotList.isEmpty()) {</span>
<span class="nc" id="L60">            viewModel.searchExercises(searchState.value)</span>
        }
<span class="nc" id="L62">    }</span>

<span class="nc bnc" id="L64" title="All 2 branches missed.">    Scaffold(</span>
<span class="nc" id="L65">        floatingActionButton = {</span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">            FloatingActionButton(</span>
                onClick = {
<span class="nc bnc" id="L68" title="All 4 branches missed.">                    navController.previousBackStackEntry?.savedStateHandle?.set&lt;String&gt;(</span>
<span class="nc" id="L69">                        &quot;selectedExercises&quot;,</span>
<span class="nc" id="L70">                        selectedItems.value.joinToString(&quot;|&quot;) { it.name }</span>
                    )
<span class="nc" id="L72">                    navController.popBackStack()</span>
<span class="nc" id="L73">                },</span>
<span class="nc" id="L74">                modifier = Modifier.testTag(TestTags.FAB)</span>
<span class="nc" id="L75">            ) {</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">                Icon(Icons.Default.Check, contentDescription = &quot;finished selecting&quot;)</span>
<span class="nc" id="L77">            }</span>
<span class="nc" id="L78">        }</span>
<span class="nc" id="L79">    ) { padding -&gt;</span>
<span class="nc bnc" id="L80" title="All 6 branches missed.">        if (showCreateExerciseDialog) {</span>
<span class="nc" id="L81">            CreateOrChangeExerciseDialog(</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                isCreating = editingExercise == null,</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                currentExercise = editingExercise ?: Exercise(</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                    name = (searchState.value).name.capitalizeWords().orEmpty(),</span>
<span class="nc" id="L85">                    musclesWorked = emptyList()</span>
                ),
<span class="nc" id="L87">                onDismiss = { showCreateExerciseDialog = false },</span>
                onConfirm = { exercise -&gt;
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    if (editingExercise == null) {</span>
<span class="nc" id="L90">                        viewModel.createExercise(exercise) { }</span>
                    } else {
<span class="nc" id="L92">                        viewModel.updateExercise(exercise, refreshItems = { pagingItems.refresh() })</span>
                    }
<span class="nc" id="L94">                    showCreateExerciseDialog = false</span>
<span class="nc" id="L95">                }</span>
            )
        }

<span class="nc" id="L99">        LazyColumn(modifier = modifier.padding(padding).testTag(TestTags.ScrollableComponent)) {</span>
<span class="nc" id="L100">            stickyHeader {</span>
<span class="nc bnc" id="L101" title="All 4 branches missed.">                SearchExerciseHeader(</span>
<span class="nc" id="L102">                    currentSearch = searchState.value.name,</span>
<span class="nc" id="L103">                    currentCategoryFilter = searchState.value.category,</span>
<span class="nc" id="L104">                    currentMuscleFilter = searchState.value.muscle,</span>
                    onSearch = { text -&gt;
<span class="nc" id="L106">                        viewModel.searchExercises(searchState.value.copy(name = text))</span>
<span class="nc" id="L107">                        pagingItems.refresh()</span>
<span class="nc" id="L108">                    },</span>
                    filterMuscle = { muscle -&gt;
<span class="nc" id="L110">                        viewModel.searchExercises(searchState.value.copy(muscle = muscle))</span>
<span class="nc" id="L111">                        pagingItems.refresh()</span>
<span class="nc" id="L112">                    },</span>
                    filterCategory = { category -&gt;
<span class="nc" id="L114">                        viewModel.searchExercises(searchState.value.copy(category = category))</span>
<span class="nc" id="L115">                        pagingItems.refresh()</span>
<span class="nc" id="L116">                    }</span>
                )

<span class="nc bnc" id="L119" title="All 4 branches missed.">                if (selectedItems.value.isNotEmpty()) {</span>
<span class="nc" id="L120">                    Box(</span>
<span class="nc" id="L121">                        modifier = Modifier</span>
<span class="nc" id="L122">                            .fillMaxWidth()</span>
<span class="nc" id="L123">                            .background(MaterialTheme.colorScheme.background)</span>
<span class="nc" id="L124">                            .padding(vertical = 4.dp, horizontal = 8.dp)</span>
                    ) {
<span class="nc bnc" id="L126" title="All 4 branches missed.">                        Row(</span>
<span class="nc" id="L127">                            modifier = Modifier</span>
<span class="nc" id="L128">                                .clip(MaterialTheme.shapes.small)</span>
<span class="nc" id="L129">                                .fillMaxWidth()</span>
<span class="nc" id="L130">                                .background(MaterialTheme.colorScheme.primaryContainer)</span>
<span class="nc" id="L131">                                .padding(2.dp)</span>
                        ) {
<span class="nc bnc" id="L133" title="All 4 branches missed.">                            Text(</span>
<span class="nc" id="L134">                                &quot;${selectedItems.value.size} exercises selected&quot;,</span>
<span class="nc" id="L135">                                style = MaterialTheme.typography.titleSmall,</span>
<span class="nc" id="L136">                                color = MaterialTheme.colorScheme.onPrimaryContainer,</span>
<span class="nc" id="L137">                                modifier = Modifier.padding(horizontal = 12.dp, vertical = 4.dp)</span>
<span class="nc" id="L138">                            )</span>
<span class="nc" id="L139">                        }</span>
<span class="nc" id="L140">                    }</span>
<span class="nc" id="L141">                }</span>
<span class="nc" id="L142">            }</span>

<span class="nc" id="L144">            items(selectedItems.value) { exercise -&gt;</span>
                SelectableExerciseItem(
                    exercise,
                    isSelected = selectedItems.value.contains(exercise),
                    onTap = {
<span class="nc" id="L149">                        viewModel.unselectExercise(exercise)</span>
<span class="nc" id="L150">                    },</span>
                    onLongPress = {
<span class="nc" id="L152">                        editingExercise = exercise</span>
<span class="nc" id="L153">                        showCreateExerciseDialog = true</span>
<span class="nc" id="L154">                    }</span>
                )
            }

<span class="nc" id="L158">            items(pagingItems) { exercise -&gt;</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">                if (exercise != null &amp;&amp; !selectedItems.value.contains(exercise)) {</span>
<span class="nc" id="L160">                    SelectableExerciseItem(</span>
<span class="nc" id="L161">                        exercise,</span>
<span class="nc" id="L162">                        isSelected = selectedItems.value.contains(exercise),</span>
                        onTap = {
<span class="nc bnc" id="L164" title="All 2 branches missed.">                            if (selectedItems.value.contains(exercise)) {</span>
<span class="nc" id="L165">                                viewModel.unselectExercise(exercise)</span>
                            } else {
<span class="nc" id="L167">                                viewModel.selectExercise(exercise)</span>
                            }
<span class="nc" id="L169">                        },</span>
                        onLongPress = {
<span class="nc" id="L171">                            editingExercise = exercise</span>
<span class="nc" id="L172">                            showCreateExerciseDialog = true</span>
<span class="nc" id="L173">                        }</span>
                    )
                }
<span class="nc" id="L176">            }</span>

<span class="nc" id="L178">            item {</span>
<span class="nc bnc" id="L179" title="All 6 branches missed.">                when (val loadState = pagingItems.loadState.mediator?.refresh) {</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                    is LoadState.Loading -&gt; {</span>
<span class="nc" id="L181">                        Box(</span>
<span class="nc" id="L182">                            modifier = Modifier.fillMaxWidth(),</span>
<span class="nc" id="L183">                            contentAlignment = Alignment.Center</span>
                        ) {
<span class="nc bnc" id="L185" title="All 4 branches missed.">                            CircularProgressIndicator()</span>
<span class="nc" id="L186">                        }</span>
                    }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                    is LoadState.Error -&gt; {</span>
<span class="nc" id="L189">                        Divider()</span>
<span class="nc" id="L190">                        Text(loadState.error.message.toString())</span>
                    }
<span class="nc" id="L192">                    else -&gt; {}</span>
<span class="nc" id="L193">                }</span>
<span class="nc" id="L194">            }</span>

<span class="nc bnc" id="L196" title="All 4 branches missed.">            if (pagingItems.loadState.mediator?.refresh is LoadState.NotLoading) {</span>
<span class="nc" id="L197">                item {</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">                    FitnessJournalButton(</span>
<span class="nc" id="L199">                        text = &quot;Create Exercise&quot;,</span>
<span class="nc" id="L200">                        fullWidth = true,</span>
<span class="nc" id="L201">                        onClick = {</span>
<span class="nc" id="L202">                            editingExercise = null</span>
<span class="nc" id="L203">                            showCreateExerciseDialog = true</span>
<span class="nc" id="L204">                        }</span>
<span class="nc" id="L205">                    )</span>
<span class="nc" id="L206">                }</span>
            }
<span class="nc" id="L208">        }</span>
<span class="nc" id="L209">    }</span>
<span class="nc" id="L210">}</span>

@OptIn(ExperimentalGlideComposeApi::class, ExperimentalFoundationApi::class)
@Composable
fun SelectableExerciseItem(
    exercise: Exercise,
    isSelected: Boolean,
<span class="nc bnc" id="L217" title="All 2 branches missed.">    modifier: Modifier = Modifier.testTag(TestTags.ExerciseSearchResult),</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">    onTap: () -&gt; Unit = {},</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">    onLongPress: () -&gt; Unit = {},</span>
<span class="nc" id="L220">    darkTheme: Boolean = isSystemInDarkTheme(),</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">    FitnessJournalCard(</span>
<span class="nc" id="L223">        modifier = Modifier</span>
<span class="nc" id="L224">            .fillMaxWidth()</span>
<span class="nc" id="L225">            .padding(horizontal = 8.dp, vertical = 4.dp)</span>
<span class="nc" id="L226">            .combinedClickable(</span>
<span class="nc" id="L227">                onClick = { onTap() },</span>
<span class="nc" id="L228">                onLongClick = { onLongPress() }</span>
            ),
<span class="nc bnc" id="L230" title="All 2 branches missed.">        backgroundColor = if (isSelected) MaterialTheme.colorScheme.primary else null,</span>
<span class="nc" id="L231">        ) {</span>
<span class="nc bnc" id="L232" title="All 4 branches missed.">        Row(</span>
<span class="nc" id="L233">            verticalAlignment = Alignment.CenterVertically</span>
        ) {
<span class="nc bnc" id="L235" title="All 12 branches missed.">            if (exercise.thumbnailUrl?.isNotEmpty() == true) {</span>
<span class="nc" id="L236">                GlideImage(</span>
<span class="nc" id="L237">                    model = exercise.thumbnailUrl!!,</span>
<span class="nc" id="L238">                    contentDescription = &quot;Exercise Image&quot;,</span>
<span class="nc" id="L239">                    modifier = Modifier</span>
<span class="nc" id="L240">                        .size(60.dp)</span>
<span class="nc" id="L241">                        .padding(6.dp),</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">                    colorFilter = if (darkTheme)</span>
<span class="nc" id="L243">                        ColorFilter.colorMatrix(</span>
<span class="nc" id="L244">                            ColorMatrix(floatArrayOf(</span>
<span class="nc" id="L245">                                -1f, 0f, 0f, 0f, 255f,</span>
<span class="nc" id="L246">                                0f, -1f, 0f, 0f, 255f,</span>
<span class="nc" id="L247">                                0f, 0f, -1f, 0f, 255f,</span>
<span class="nc" id="L248">                                0f, 0f, 0f, 1f, 0f</span>
                            ))
<span class="nc" id="L250">                        ) else null</span>
                )
            }

<span class="nc" id="L254">            Column(modifier = Modifier.padding(8.dp)) {</span>
<span class="nc bnc" id="L255" title="All 4 branches missed.">                Text(</span>
<span class="nc" id="L256">                    exercise.name,</span>
<span class="nc" id="L257">                    modifier = Modifier.padding(2.dp),</span>
<span class="nc" id="L258">                    style = MaterialTheme.typography.headlineSmall</span>
                )
    //            Text(
    //                &quot;Performed ${exercise} sets&quot;,
    //                modifier = Modifier.padding(2.dp),
    //                style = MaterialTheme.typography.labelSmall
    //            )
<span class="nc bnc" id="L265" title="All 2 branches missed.">                exercise.category?.let { Text(it, style = MaterialTheme.typography.labelLarge) }</span>

<span class="nc bnc" id="L267" title="All 4 branches missed.">                if (exercise.musclesWorked.isNotEmpty()) {</span>
<span class="nc" id="L268">                    Text(exercise.musclesWorked.joinToString(&quot;, &quot;) { it })</span>
<span class="nc" id="L269">                }</span>
<span class="nc" id="L270">        }</span>
<span class="nc" id="L271">        }</span>
<span class="nc" id="L272">    }</span>
<span class="nc" id="L273">}</span>

@Preview
@Composable
<span class="nc bnc" id="L277" title="All 4 branches missed.">fun SelectableExerciseItemPreview() {</span>
<span class="nc" id="L278">    SelectableExerciseItem(</span>
<span class="nc" id="L279">        isSelected = true,</span>
<span class="nc" id="L280">        exercise = Exercise(</span>
<span class="nc" id="L281">            name = &quot;Bicep Curl&quot;,</span>
<span class="nc" id="L282">            musclesWorked = listOf(&quot;Biceps&quot;, &quot;Triceps&quot;),</span>
        )
    )
<span class="nc bnc" id="L285" title="All 2 branches missed.">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>