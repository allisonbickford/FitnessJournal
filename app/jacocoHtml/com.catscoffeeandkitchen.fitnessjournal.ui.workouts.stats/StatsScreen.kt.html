<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatsScreen.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.workouts.stats</a> &gt; <span class="el_source">StatsScreen.kt</span></div><h1>StatsScreen.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.workouts.stats

import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.GridItemSpan
import androidx.compose.foundation.lazy.grid.LazyHorizontalGrid
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.lazy.rememberLazyListState
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.catscoffeeandkitchen.domain.util.DataState
import com.catscoffeeandkitchen.fitnessjournal.TestTags
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalCard
import com.catscoffeeandkitchen.fitnessjournal.ui.components.graphs.MPExerciseLineGraph
import kotlinx.coroutines.launch
import timber.log.Timber
import java.time.DayOfWeek
import java.time.Duration
import java.time.OffsetDateTime
import java.time.format.DateTimeFormatter
import kotlin.math.absoluteValue


@OptIn(ExperimentalFoundationApi::class)
@Composable
fun StatsScreen(
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">    modifier: Modifier = Modifier,</span>
<span class="fc" id="L39">    viewModel: StatsViewModel = hiltViewModel()</span>
<span class="pc bpc" id="L40" title="12 of 20 branches missed.">) {</span>
<span class="fc" id="L41">    val listState = rememberLazyListState()</span>
<span class="fc" id="L42">    val coroutineScope = rememberCoroutineScope()</span>
<span class="fc" id="L43">    val selectedExercise = viewModel.selectedExerciseRequest.collectAsState(initial = null as String?)</span>

    // 0 = calendar, 1 = bar chart
<span class="pc" id="L46">    var currentTab by remember { mutableStateOf(0)}</span>
<span class="fc" id="L47">    val tabOptions = listOf(&quot;Calendar&quot;, &quot;Charts&quot;)</span>

<span class="fc" id="L49">    Column(</span>
<span class="fc" id="L50">        modifier = modifier.fillMaxSize()</span>
    ) {
<span class="pc bpc" id="L52" title="3 of 4 branches missed.">        TabRow(</span>
<span class="fc" id="L53">            selectedTabIndex = currentTab,</span>
<span class="fc" id="L54">        ) {</span>
<span class="pc bpc" id="L55" title="3 of 4 branches missed.">            tabOptions.forEachIndexed { index, tab -&gt;</span>
<span class="fc" id="L56">                Tab(</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">                    selected = currentTab == index,</span>
<span class="pc" id="L58">                    onClick = { currentTab = index },</span>
<span class="pc bpc" id="L59" title="2 of 4 branches missed.">                    text = { Text(text = tab) }</span>
                )
<span class="pc" id="L61">            }</span>
<span class="fc" id="L62">        }</span>

<span class="fc" id="L64">        when (currentTab) {</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">            0 -&gt; {</span>
<span class="fc" id="L66">                LazyVerticalGrid(</span>
<span class="fc" id="L67">                    columns = GridCells.Fixed(7),</span>
<span class="fc" id="L68">                    modifier = Modifier.padding(horizontal = 12.dp)</span>
                ) {
<span class="fc" id="L70">                    val dates = viewModel.workoutDates.value</span>

<span class="fc" id="L72">                    when (dates) {</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">                        is DataState.Success -&gt; {</span>
<span class="pc" id="L74">                            Timber.d(&quot;*** completedDates = ${dates.data.joinToString { it.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;)) }}&quot;)</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">                            for (monthsAgo in 0 until 3) {</span>
<span class="fc" id="L76">                                val dateMonthsAgo = OffsetDateTime.now().withDayOfMonth(1).minusMonths(monthsAgo.toLong())</span>
<span class="fc" id="L77">                                val lastDayOfMonth = dateMonthsAgo.plusMonths(1).withDayOfMonth(1).minusDays(1)</span>
<span class="fc" id="L78">                                val monthInDays = Duration.between(dateMonthsAgo, lastDayOfMonth).toDays().toInt() + 1</span>

<span class="fc" id="L80">                                item(</span>
<span class="fc" id="L81">                                    span = { GridItemSpan(7) }</span>
<span class="fc" id="L82">                                ) {</span>
<span class="pc bpc" id="L83" title="3 of 4 branches missed.">                                    Text(</span>
<span class="fc" id="L84">                                        dateMonthsAgo.month.name.lowercase(),</span>
<span class="fc" id="L85">                                        style = MaterialTheme.typography.titleMedium,</span>
<span class="fc" id="L86">                                        modifier = Modifier.padding(12.dp)</span>
<span class="nc" id="L87">                                    )</span>
<span class="fc" id="L88">                                }</span>

<span class="fc" id="L90">                                items(7) { number -&gt;</span>
<span class="pc bpc" id="L91" title="3 of 4 branches missed.">                                    val day = dateMonthsAgo.withDayOfMonth(1).with(DayOfWeek.SUNDAY).plusDays(number.toLong())</span>
<span class="fc" id="L92">                                    Text(</span>
<span class="fc" id="L93">                                        day.dayOfWeek.name.lowercase().take(3),</span>
<span class="fc" id="L94">                                        style = MaterialTheme.typography.titleSmall,</span>
<span class="fc" id="L95">                                        modifier = Modifier.padding(12.dp)</span>
<span class="nc" id="L96">                                    )</span>
<span class="fc" id="L97">                                }</span>

<span class="fc" id="L99">                                items(monthInDays.absoluteValue) { number -&gt;</span>
<span class="pc bpc" id="L100" title="3 of 4 branches missed.">                                    val day = dateMonthsAgo.withDayOfMonth(1).plusDays(number.toLong())</span>
<span class="fc" id="L101">                                    val daysUntilStartOfWeek = Duration.between(</span>
<span class="fc" id="L102">                                        dateMonthsAgo</span>
<span class="fc" id="L103">                                            .withDayOfMonth(1)</span>
<span class="fc" id="L104">                                            .with(DayOfWeek.SUNDAY)</span>
<span class="fc" id="L105">                                            .plusDays(number.toLong()),</span>
<span class="fc" id="L106">                                        day</span>
<span class="fc" id="L107">                                    ).toDays()</span>
<span class="fc" id="L108">                                    val dayWithCorrectWeekday = day.plusDays(daysUntilStartOfWeek - 1)</span>

<span class="pc bpc" id="L110" title="3 of 4 branches missed.">                                    val matchingDate = dates.data.find { completedDate -&gt;</span>
<span class="nc" id="L111">                                        dayWithCorrectWeekday.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;)) ==</span>
<span class="nc" id="L112">                                                completedDate.format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;))</span>
                                    }

<span class="fc bfc" id="L115" title="All 2 branches covered.">                                    if (dayWithCorrectWeekday.month != day.month) {</span>
<span class="fc" id="L116">                                        Text(&quot;&quot;)</span>
<span class="fc" id="L117">                                    } else {</span>
<span class="fc" id="L118">                                        Text(</span>
<span class="fc" id="L119">                                            (dayWithCorrectWeekday.dayOfMonth).toString(),</span>
<span class="fc" id="L120">                                            textAlign = TextAlign.Center,</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">                                            color = if (matchingDate != null)</span>
<span class="nc" id="L122">                                                MaterialTheme.colorScheme.onPrimaryContainer</span>
<span class="fc" id="L123">                                                else MaterialTheme.colorScheme.onBackground,</span>
<span class="fc" id="L124">                                            modifier = Modifier</span>
<span class="fc" id="L125">                                                .padding(6.dp)</span>
<span class="fc" id="L126">                                                .clip(MaterialTheme.shapes.small)</span>
<span class="fc" id="L127">                                                .background(</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">                                                    if (matchingDate != null)</span>
<span class="nc" id="L129">                                                        MaterialTheme.colorScheme.primaryContainer</span>
<span class="fc" id="L130">                                                    else MaterialTheme.colorScheme.background</span>
                                                )
<span class="fc" id="L132">                                                .padding(6.dp)</span>
                                        )
<span class="nc" id="L134">                                    }</span>
<span class="fc" id="L135">                                }</span>

<span class="fc" id="L137">                                item(</span>
<span class="nc" id="L138">                                    span = { GridItemSpan(7) }</span>
<span class="fc" id="L139">                                ) {</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">                                    Divider(</span>
<span class="nc" id="L141">                                        Modifier</span>
<span class="nc" id="L142">                                            .fillMaxWidth()</span>
<span class="nc" id="L143">                                            .padding(12.dp))</span>
<span class="nc" id="L144">                                }</span>
                            }
                        }
<span class="pc bnc" id="L147" title="All 4 branches missed.">                        else -&gt; { item { CircularProgressIndicator() } }</span>
                    }
<span class="fc" id="L149">                }</span>
            }
<span class="nc" id="L151">            else -&gt; {</span>
<span class="nc" id="L152">                LazyColumn(</span>
<span class="nc" id="L153">                    modifier = modifier.padding(horizontal = 8.dp).testTag(TestTags.ScrollableComponent),</span>
<span class="nc" id="L154">                    state = listState,</span>
<span class="nc" id="L155">                    verticalArrangement = Arrangement.spacedBy(8.dp)</span>
                ) {
<span class="nc" id="L157">                    when (val state = viewModel.sets.value) {</span>
<span class="pc bnc" id="L158" title="All 6 branches missed.">                        is DataState.NotSent -&gt; item { Text(&quot;Select an exercise!&quot;) }</span>
<span class="pc bnc" id="L159" title="All 6 branches missed.">                        is DataState.Loading -&gt; item { CircularProgressIndicator() }</span>
<span class="nc bnc" id="L160" title="All 6 branches missed.">                        is DataState.Error -&gt; item { Text(state.e.message.toString()) }</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">                        is DataState.Success -&gt; {</span>


<span class="nc bnc" id="L164" title="All 2 branches missed.">                            selectedExercise.value?.let { name -&gt;</span>
<span class="nc" id="L165">                                item {</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">                                    Text(name, style = MaterialTheme.typography.headlineMedium)</span>
<span class="nc" id="L167">                                }</span>
<span class="nc" id="L168">                            }</span>

<span class="nc" id="L170">                            item {</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">                                val statsData = state.data</span>
<span class="nc" id="L172">                                    .groupBy { it.completedAt }</span>
<span class="nc" id="L173">                                    .map { grouping -&gt;</span>
<span class="nc" id="L174">                                        val sortedGroup = grouping.value.sortedByDescending { set -&gt;</span>
                                            set.weightInPounds / (1.0278 - 0.0278 * set.reps)
                                        }
<span class="nc" id="L177">                                        StatsData(</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                                            date = grouping.key ?: OffsetDateTime.now(),</span>
<span class="nc" id="L179">                                            bestSet = sortedGroup.first(),</span>
<span class="nc" id="L180">                                            repMax = (sortedGroup.first().weightInPounds / (1.0278 - 0.0278 * sortedGroup.first().reps)).toFloat(),</span>
<span class="nc bnc" id="L181" title="All 4 branches missed.">                                            totalVolume = grouping.value.maxOf { it.weightInPounds * it.reps },</span>
<span class="nc bnc" id="L182" title="All 4 branches missed.">                                            highestWeight = grouping.value.maxOf { it.weightInPounds },</span>
<span class="nc bnc" id="L183" title="All 6 branches missed.">                                            reps = grouping.value.maxOf { it.reps }.toFloat()</span>
                                        )
                                    }

<span class="nc" id="L187">                                Timber.d(&quot;*** statsData = ${statsData.joinToString { it.repMax.toString() }}&quot;)</span>

<span class="nc bnc" id="L189" title="All 4 branches missed.">                                if (statsData.isNotEmpty()) {</span>
<span class="nc" id="L190">                                    MPExerciseLineGraph(entries = statsData)</span>
<span class="nc" id="L191">                                } else {</span>
<span class="nc" id="L192">                                    Text(&quot;No sets to graph.&quot;)</span>
<span class="nc" id="L193">                                }</span>
<span class="nc" id="L194">                            }</span>
                        }
                        else -&gt; {

                        }
                    }

<span class="pc" id="L201">                    item {</span>
<span class="nc bnc" id="L202" title="All 4 branches missed.">                        // TODO: stats recap</span>
                        // 12 month change
                        // 6 month change
                        // 3 month change

<span class="nc" id="L207">                        // average sets performed per week</span>
<span class="nc" id="L208">                    }</span>

<span class="nc" id="L210">                    when (val state = viewModel.exercises.value) {</span>
<span class="pc bnc" id="L211" title="All 6 branches missed.">                        is DataState.NotSent -&gt; item { Text(&quot;Not getting exercises at the moment.&quot;) }</span>
<span class="pc bnc" id="L212" title="All 6 branches missed.">                        is DataState.Loading -&gt; item { CircularProgressIndicator() }</span>
<span class="nc bnc" id="L213" title="All 6 branches missed.">                        is DataState.Error -&gt; item { Text(state.e.message.toString()) }</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                        is DataState.Success -&gt; items(state.data) { exercise -&gt;</span>
                            FitnessJournalCard(
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .padding(horizontal = 8.dp)
                                    .clickable {
<span class="nc" id="L220">                                        viewModel.selectExercise(exercise.name)</span>

<span class="nc" id="L222">                                        coroutineScope.launch {</span>
<span class="nc" id="L223">                                            listState.scrollToItem(0)</span>
<span class="nc" id="L224">                                        }</span>
<span class="nc" id="L225">                                    }</span>
                            ) {
<span class="nc bnc" id="L227" title="All 4 branches missed.">                                Text(</span>
<span class="nc" id="L228">                                    exercise.name,</span>
<span class="nc" id="L229">                                    modifier = Modifier.padding(start = 8.dp, top = 12.dp),</span>
<span class="nc" id="L230">                                    style = MaterialTheme.typography.headlineMedium</span>
                                )

<span class="nc" id="L233">                                Text(</span>
<span class="nc" id="L234">                                    &quot;completed ${exercise.amountOfSets} times&quot;,</span>
<span class="nc" id="L235">                                    modifier = Modifier.padding(start = 8.dp, bottom = 12.dp),</span>
<span class="nc" id="L236">                                    style = MaterialTheme.typography.labelMedium</span>
<span class="nc" id="L237">                                )</span>
<span class="nc" id="L238">                            }</span>
                        }
                    }
<span class="nc" id="L241">                }</span>
            }
<span class="pc" id="L243">        }</span>
<span class="pc" id="L244">    }</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>