<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SetDetailsInputs.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details.exercise</a> &gt; <span class="el_source">SetDetailsInputs.kt</span></div><h1>SetDetailsInputs.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details.exercise

import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.core.MutableTransitionState
import androidx.compose.animation.expandVertically
import androidx.compose.animation.shrinkVertically
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.combinedClickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.ExperimentalComposeUiApi
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalSoftwareKeyboardController
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import com.catscoffeeandkitchen.domain.models.Exercise
import com.catscoffeeandkitchen.domain.models.ExerciseEquipmentType
import com.catscoffeeandkitchen.domain.models.ExerciseSet
import com.catscoffeeandkitchen.domain.models.ExerciseSetType
import com.catscoffeeandkitchen.fitnessjournal.TestTags
import com.catscoffeeandkitchen.fitnessjournal.ui.util.WeightUnit
import com.catscoffeeandkitchen.fitnessjournal.ui.util.toCleanString
import com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details.exercise.inputs.*
import com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details.plates.BarbellType
import com.catscoffeeandkitchen.fitnessjournal.ui.workouts.details.plates.PlateCalculator
import com.google.accompanist.flowlayout.FlowCrossAxisAlignment
import com.google.accompanist.flowlayout.FlowRow
import com.google.accompanist.flowlayout.MainAxisAlignment
import java.time.OffsetDateTime

enum class InputToDisplay() {
<span class="nc" id="L38">    Reps,</span>
<span class="nc" id="L39">    Weight,</span>
<span class="nc" id="L40">    RIR,</span>
<span class="nc" id="L41">    PE,</span>
}

@OptIn(ExperimentalFoundationApi::class, ExperimentalComposeUiApi::class)
@Composable
fun SetDetailsInputs(
    set: ExerciseSet,
    unit: WeightUnit,
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">    modifier: Modifier = Modifier,</span>
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">    useKeyboard: Boolean = false,</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">    updateValue: (field: ExerciseSetField) -&gt; Unit = { },</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">    removeSet: () -&gt; Unit = {},</span>
<span class="pc bpc" id="L53" title="1 of 2 branches missed.">    onFocus: () -&gt; Unit = {},</span>
<span class="nc" id="L54">    onBlur: () -&gt; Unit = {},</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">) {</span>
<span class="fc" id="L56">    val keyboardController = LocalSoftwareKeyboardController.current</span>
//    var setWithUpdatedData by remember { mutableStateOf(set) }
<span class="pc" id="L58">    var showInput by remember { mutableStateOf(null as InputToDisplay?) }</span>
<span class="pc" id="L59">    var inputOpen by remember { mutableStateOf(false) }</span>
<span class="pc" id="L60">    var shouldShowPlateCalculator by remember { mutableStateOf(false) }</span>

<span class="fc" id="L62">    val setColor = when {</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        set.isComplete -&gt; MaterialTheme.colorScheme.background</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        set.type == ExerciseSetType.WarmUp -&gt; MaterialTheme.colorScheme.secondary.copy(alpha = .6f)</span>
<span class="fc" id="L65">        else -&gt; MaterialTheme.colorScheme.primary.copy(alpha = .6f)</span>
    }

<span class="fc" id="L68">    val labelColor = when {</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        set.isComplete -&gt; MaterialTheme.colorScheme.onBackground</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        set.type == ExerciseSetType.WarmUp -&gt; MaterialTheme.colorScheme.onSecondary</span>
<span class="fc" id="L71">        else -&gt; MaterialTheme.colorScheme.onPrimary</span>
    }

<span class="pc" id="L74">    var showOptionsMenu by remember { mutableStateOf(false) }</span>

<span class="fc" id="L76">    Box(modifier = modifier.padding(bottom = 10.dp)) {</span>
<span class="pc bpc" id="L77" title="3 of 4 branches missed.">        ExerciseSetDropdownMenu(</span>
<span class="fc" id="L78">            set = set,</span>
<span class="fc" id="L79">            isVisible = showOptionsMenu,</span>
<span class="pc" id="L80">            onDismiss = { showOptionsMenu = false },</span>
<span class="fc" id="L81">            removeSet = {</span>
<span class="nc" id="L82">                showOptionsMenu = false</span>
<span class="nc" id="L83">                removeSet()</span>
<span class="nc" id="L84">            },</span>
<span class="fc" id="L85">            updateValue = { field -&gt;</span>
<span class="nc" id="L86">                updateValue(field)</span>
<span class="nc" id="L87">                showOptionsMenu = false</span>
<span class="nc" id="L88">            },</span>
<span class="fc" id="L89">            showPlateCalculator = {</span>
<span class="nc" id="L90">                shouldShowPlateCalculator = true</span>
<span class="nc" id="L91">            }</span>
        )

<span class="fc" id="L94">        Column {</span>
<span class="pc bpc" id="L95" title="3 of 4 branches missed.">            Row(</span>
<span class="fc" id="L96">                modifier = Modifier</span>
<span class="fc" id="L97">                    .fillMaxWidth()</span>
<span class="fc" id="L98">                    .clip(RoundedCornerShape(4.dp))</span>
<span class="fc" id="L99">                    .background(setColor)</span>
<span class="fc" id="L100">                    .combinedClickable(</span>
<span class="nc" id="L101">                        onClick = {},</span>
<span class="fc" id="L102">                        onLongClick = {</span>
<span class="nc" id="L103">                            showOptionsMenu = true</span>
<span class="nc" id="L104">                        }</span>
                    )
<span class="fc" id="L106">                    .padding(6.dp),</span>
<span class="fc" id="L107">                horizontalArrangement = Arrangement.SpaceEvenly,</span>
            ) {
<span class="pc bpc" id="L109" title="3 of 4 branches missed.">                Checkbox(</span>
<span class="fc" id="L110">                    checked = set.isComplete,</span>
<span class="fc" id="L111">                    onCheckedChange = { checked -&gt;</span>
<span class="nc" id="L112">                        updateValue(</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                            ExerciseSetField.Complete(if (checked) OffsetDateTime.now() else null),</span>
                        )
<span class="nc" id="L115">                    },</span>
<span class="fc" id="L116">                    colors = CheckboxDefaults.colors(</span>
<span class="fc" id="L117">                        uncheckedColor = labelColor</span>
                    ),
<span class="fc" id="L119">                    modifier = Modifier.testTag(TestTags.CompleteSetCheckbox)</span>
                )

<span class="fc" id="L122">                SetInput(</span>
<span class="fc" id="L123">                    value = set.reps.toString(),</span>
<span class="fc" id="L124">                    label = &quot;reps&quot;,</span>
<span class="fc" id="L125">                    labelColor = labelColor,</span>
<span class="fc" id="L126">                    useKeyboard = useKeyboard,</span>
<span class="fc" id="L127">                    onFocus = {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                        if (useKeyboard) {</span>
<span class="nc" id="L129">                            showInput = InputToDisplay.Reps</span>
<span class="nc" id="L130">                            inputOpen = true</span>
                        } else {
<span class="nc bnc" id="L132" title="All 4 branches missed.">                            if (!inputOpen || showInput != InputToDisplay.Reps) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                                keyboardController?.hide()</span>
<span class="nc" id="L134">                                showInput = InputToDisplay.Reps</span>
<span class="nc" id="L135">                                inputOpen = true</span>
                            } else {
<span class="nc" id="L137">                                inputOpen = false</span>
                            }
                        }
<span class="nc" id="L140">                    },</span>
<span class="fc" id="L141">                    updateValue = { value -&gt;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">                        updateValue(ExerciseSetField.Reps(value.toIntOrNull() ?: 0))</span>
<span class="nc" id="L143">                    },</span>
<span class="fc" id="L144">                    onBlur = {</span>
<span class="nc" id="L145">                        showInput = null</span>
<span class="nc" id="L146">                    }</span>
                )

<span class="fc" id="L149">                SetInput(</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                    value = if (unit == WeightUnit.Pounds)</span>
<span class="fc" id="L151">                        set.weightInPounds.toCleanString() else</span>
<span class="nc" id="L152">                        set.weightInKilograms.toCleanString(),</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">                    label = if (unit == WeightUnit.Pounds) &quot;lbs&quot; else &quot;kg&quot;,</span>
<span class="fc" id="L154">                    useKeyboard = useKeyboard,</span>
<span class="fc" id="L155">                    updateValue = { value -&gt;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                        if (unit == WeightUnit.Pounds) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                            updateValue(ExerciseSetField.WeightInPounds(value.toFloatOrNull() ?: 0f))</span>
                        } else {
<span class="nc bnc" id="L159" title="All 2 branches missed.">                            updateValue(ExerciseSetField.WeightInKilograms(value.toFloatOrNull() ?: 0f))</span>
                        }
<span class="nc" id="L161">                    },</span>
<span class="fc" id="L162">                    labelColor = labelColor,</span>
<span class="fc" id="L163">                    onFocus = {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                        if (useKeyboard) {</span>
<span class="nc" id="L165">                            showInput = InputToDisplay.Weight</span>
                        } else {
<span class="nc bnc" id="L167" title="All 4 branches missed.">                            if (!inputOpen || showInput != InputToDisplay.Weight) {</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">                                keyboardController?.hide()</span>
<span class="nc" id="L169">                                inputOpen = true</span>
<span class="nc" id="L170">                                showInput = InputToDisplay.Weight</span>
                            } else {
<span class="nc" id="L172">                                inputOpen = false</span>
                            }
                        }
<span class="nc" id="L175">                    },</span>
<span class="fc" id="L176">                    onBlur = {</span>
<span class="nc" id="L177">                        showInput = null</span>
<span class="nc" id="L178">                    }</span>
                )

<span class="fc" id="L181">                SetInput(</span>
<span class="fc" id="L182">                    value = set.repsInReserve.toString(),</span>
<span class="fc" id="L183">                    label = &quot;RIR&quot;,</span>
<span class="fc" id="L184">                    useKeyboard = useKeyboard,</span>
<span class="fc" id="L185">                    updateValue = { value -&gt;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                        updateValue(ExerciseSetField.RepsInReserve(value.toIntOrNull() ?: 0))</span>
<span class="nc" id="L187">                    },</span>
<span class="fc" id="L188">                    labelColor = labelColor,</span>
<span class="fc" id="L189">                    onFocus = {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                        if (useKeyboard) {</span>
<span class="nc" id="L191">                            showInput = InputToDisplay.RIR</span>
                        } else {
<span class="nc bnc" id="L193" title="All 4 branches missed.">                            if (!inputOpen || showInput != InputToDisplay.RIR) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                                keyboardController?.hide()</span>
<span class="nc" id="L195">                                inputOpen = true</span>
<span class="nc" id="L196">                                showInput = InputToDisplay.RIR</span>
                            } else {
<span class="nc" id="L198">                                inputOpen = false</span>
                            }
                        }
<span class="nc" id="L201">                    },</span>
<span class="fc" id="L202">                    onBlur = onBlur,</span>
                )

<span class="fc" id="L205">                SetInput(</span>
<span class="fc" id="L206">                    value = set.perceivedExertion.toString(),</span>
<span class="fc" id="L207">                    label = &quot;PE&quot;,</span>
<span class="fc" id="L208">                    useKeyboard = useKeyboard,</span>
<span class="fc" id="L209">                    updateValue = { value -&gt;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                        updateValue(ExerciseSetField.PerceivedExertion(value.toIntOrNull() ?: 0))</span>
<span class="nc" id="L211">                    },</span>
<span class="fc" id="L212">                    labelColor = labelColor,</span>
<span class="fc" id="L213">                    onFocus = {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                        if (useKeyboard) {</span>
<span class="nc" id="L215">                            showInput = InputToDisplay.PE</span>
                        } else {
<span class="nc bnc" id="L217" title="All 4 branches missed.">                            if (!inputOpen || showInput != InputToDisplay.PE) {</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                                keyboardController?.hide()</span>
<span class="nc" id="L219">                                inputOpen = true</span>
<span class="nc" id="L220">                                showInput = InputToDisplay.PE</span>
                            } else {
<span class="nc" id="L222">                                inputOpen = false</span>
                            }
                        }
<span class="nc" id="L225">                    },</span>
<span class="fc" id="L226">                    onBlur = onBlur,</span>
<span class="pc" id="L227">                )</span>
<span class="pc" id="L228">            }</span>

<span class="fc" id="L230">            AnimatedVisibility(</span>
<span class="pc bpc" id="L231" title="2 of 4 branches missed.">                visible = !useKeyboard &amp;&amp; inputOpen,</span>
<span class="fc" id="L232">                enter = expandVertically(),</span>
<span class="fc" id="L233">                exit = shrinkVertically()</span>
<span class="fc" id="L234">            ) {</span>
<span class="nc bnc" id="L235" title="All 7 branches missed.">                when (showInput) {</span>
<span class="nc" id="L236">                    InputToDisplay.Reps -&gt; {</span>
<span class="nc" id="L237">                        RepsInput(set.reps, onUpdate = { reps -&gt;</span>
<span class="nc" id="L238">                            updateValue(ExerciseSetField.Reps(reps))</span>
<span class="nc" id="L239">                            inputOpen = false</span>
<span class="nc" id="L240">                        })</span>
                    }
<span class="nc" id="L242">                    InputToDisplay.RIR -&gt; {</span>
<span class="nc" id="L243">                        RepsInReserveInput(</span>
<span class="nc" id="L244">                            rir = set.repsInReserve,</span>
<span class="nc" id="L245">                            onUpdate = { rir -&gt;</span>
<span class="nc" id="L246">                                updateValue(ExerciseSetField.RepsInReserve(rir))</span>
<span class="nc" id="L247">                                inputOpen = false</span>
<span class="nc" id="L248">                            })</span>
                    }
<span class="nc" id="L250">                    InputToDisplay.Weight -&gt; {</span>
<span class="nc" id="L251">                        WeightInput(</span>
<span class="nc" id="L252">                            unit,</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">                            if (unit == WeightUnit.Kilograms)</span>
<span class="nc" id="L254">                                set.weightInKilograms else set.weightInPounds,</span>
<span class="nc" id="L255">                            onUpdate = { weight -&gt;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                                if (unit == WeightUnit.Kilograms) {</span>
<span class="nc" id="L257">                                    updateValue(ExerciseSetField.WeightInKilograms(weight))</span>
                                } else {
<span class="nc" id="L259">                                    updateValue(ExerciseSetField.WeightInPounds(weight))</span>
                                }
<span class="nc" id="L261">                                inputOpen = false</span>
<span class="nc" id="L262">                            }</span>
                        )
                    }
<span class="nc" id="L265">                    InputToDisplay.PE -&gt; {</span>
<span class="nc" id="L266">                        PerceivedExertionInput(</span>
<span class="nc" id="L267">                            pe = set.perceivedExertion,</span>
<span class="nc" id="L268">                            onUpdate = { pe -&gt;</span>
<span class="nc" id="L269">                                updateValue(ExerciseSetField.PerceivedExertion(pe))</span>
<span class="nc" id="L270">                                inputOpen = false</span>
<span class="nc" id="L271">                            })</span>
                    }
<span class="nc" id="L273">                    else -&gt; {}</span>
                }
<span class="nc" id="L275">            }</span>

<span class="fc bfc" id="L277" title="All 2 branches covered.">            val isBarbellExercise = set.exercise.equipmentType == ExerciseEquipmentType.Barbell</span>
<span class="pc bpc" id="L278" title="2 of 6 branches missed.">            if (shouldShowPlateCalculator || (!set.isComplete &amp;&amp; isBarbellExercise)</span>
            ) {
<span class="fc" id="L280">                PlateCalculator(</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">                    barbell = if (isBarbellExercise) BarbellType.Standard else BarbellType.None,</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">                    weight = if (unit == WeightUnit.Pounds) set.weightInPounds.toDouble()</span>
<span class="nc" id="L283">                        else set.weightInKilograms.toDouble(),</span>
<span class="fc" id="L284">                    unit = unit,</span>
                )
<span class="pc" id="L286">            }</span>
<span class="pc" id="L287">        }</span>
<span class="pc" id="L288">    }</span>
<span class="fc" id="L289">}</span>

@Composable
fun SetInput(
    value: String,
    useKeyboard: Boolean,
    label: String,
    labelColor: Color,
    updateValue: (value: String) -&gt; Unit,
    onFocus: () -&gt; Unit,
    onBlur: () -&gt; Unit,
<span class="pc bpc" id="L300" title="11 of 32 branches missed.">) {</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">    if(!useKeyboard) {</span>
<span class="fc" id="L302">        ExerciseSetButtonInput(</span>
<span class="fc" id="L303">            value = value,</span>
<span class="fc" id="L304">            label = label,</span>
<span class="fc" id="L305">            labelColor = labelColor,</span>
<span class="fc" id="L306">            onClick = onFocus,</span>
        )
<span class="nc" id="L308">    } else {</span>
<span class="nc" id="L309">        ExerciseSetInputWithLabel(</span>
<span class="nc" id="L310">            value = value,</span>
<span class="nc" id="L311">            label = label,</span>
<span class="nc" id="L312">            updateValue = updateValue,</span>
<span class="nc" id="L313">            labelColor = labelColor,</span>
<span class="nc" id="L314">            onFocus = onFocus,</span>
<span class="nc" id="L315">            onBlur = onBlur</span>
        )
    }
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">}</span>


@Preview(
    name = &quot;Grid&quot;
)
@Composable
<span class="nc bnc" id="L325" title="All 4 branches missed.">fun SetItemGridPreview() {</span>
<span class="nc" id="L326">    Card {</span>
<span class="nc bnc" id="L327" title="All 4 branches missed.">        SetDetailsInputs(</span>
<span class="nc" id="L328">            set = ExerciseSet(</span>
<span class="nc" id="L329">                id = 0L,</span>
<span class="nc" id="L330">                exercise = Exercise(</span>
<span class="nc" id="L331">                    name = &quot;Bicep Curl&quot;,</span>
<span class="nc" id="L332">                    musclesWorked = listOf()</span>
                ),
<span class="nc" id="L334">                reps = 4,</span>
<span class="nc" id="L335">                setNumber = 1,</span>
<span class="nc" id="L336">                weightInPounds = 140f,</span>
<span class="nc" id="L337">                repsInReserve = 3,</span>
<span class="nc" id="L338">                perceivedExertion = 7,</span>
<span class="nc" id="L339">                isComplete = true</span>
            ),
<span class="nc" id="L341">            unit = WeightUnit.Pounds,</span>
<span class="nc" id="L342">        )</span>
<span class="nc" id="L343">    }</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>