<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkoutPlanEditScreen.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.workouts.plan</a> &gt; <span class="el_source">WorkoutPlanEditScreen.kt</span></div><h1>WorkoutPlanEditScreen.kt</h1><pre class="source lang-java linenums">@file:OptIn(ExperimentalMaterial3Api::class)

package com.catscoffeeandkitchen.fitnessjournal.ui.workouts.plan

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyListScope
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalLifecycleOwner
import androidx.compose.ui.platform.testTag
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.Lifecycle
import androidx.lifecycle.LifecycleEventObserver
import androidx.lifecycle.LifecycleOwner
import androidx.navigation.NavController
import com.catscoffeeandkitchen.domain.models.ExpectedSet
import com.catscoffeeandkitchen.domain.models.WorkoutPlan
import com.catscoffeeandkitchen.domain.util.DataState
import com.catscoffeeandkitchen.fitnessjournal.TestTags
import com.catscoffeeandkitchen.fitnessjournal.ui.components.AddExerciseOrGroupButtons
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalButton
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalOutlinedTextField
import com.catscoffeeandkitchen.fitnessjournal.ui.navigation.FitnessJournalScreen

@Composable
fun WorkoutPlanEditScreen(
    navController: NavController,
<span class="nc bnc" id="L32" title="All 2 branches missed.">    modifier: Modifier = Modifier,</span>
<span class="nc" id="L33">    viewModel: WorkoutPlanViewModel = hiltViewModel(),</span>
<span class="nc" id="L34">    lifecycleOwner: LifecycleOwner = LocalLifecycleOwner.current,</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">    ) {</span>
<span class="nc" id="L36">    val onStartOrResume by rememberUpdatedState(viewModel::addExercise)</span>
<span class="nc" id="L37">    val groupExercises by rememberUpdatedState(viewModel::showGroupNameDialog)</span>
<span class="nc" id="L38">    val selectGroup by rememberUpdatedState(viewModel::selectGroup)</span>
<span class="nc" id="L39">    var exerciseToRemove by remember { mutableStateOf(null as ExpectedSet?) }</span>
<span class="nc" id="L40">    val showExerciseGroupNameDialog = viewModel.showExerciseGroupNameDialog.collectAsState()</span>
<span class="nc" id="L41">    val exercisesToGroup = viewModel.exercisesToGroup.collectAsState()</span>
<span class="nc" id="L42">    var groupName by remember { mutableStateOf(&quot;&quot;) }</span>

<span class="nc" id="L44">    DisposableEffect(lifecycleOwner) {</span>
<span class="nc" id="L45">        val observer = LifecycleEventObserver { _, event -&gt;</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">            if (event == Lifecycle.Event.ON_RESUME) {</span>
<span class="nc bnc" id="L47" title="All 4 branches missed.">                navController.currentBackStackEntry?.savedStateHandle</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">                    ?.getLiveData&lt;String&gt;(&quot;exerciseToAdd&quot;)?.observe(lifecycleOwner) { result -&gt;</span>
<span class="nc" id="L49">                        onStartOrResume(result)</span>
                        
<span class="nc bnc" id="L51" title="All 4 branches missed.">                        navController.currentBackStackEntry?.savedStateHandle</span>
<span class="nc" id="L52">                            ?.remove&lt;String&gt;(&quot;exerciseToAdd&quot;)</span>
<span class="nc" id="L53">                    }</span>

<span class="nc bnc" id="L55" title="All 4 branches missed.">                navController.currentBackStackEntry?.savedStateHandle</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">                    ?.getLiveData&lt;String&gt;(&quot;selectedExercises&quot;)?.observe(lifecycleOwner) { result -&gt;</span>
<span class="nc" id="L57">                        groupExercises(result.split(&quot;|&quot;))</span>
<span class="nc bnc" id="L58" title="All 4 branches missed.">                        navController.currentBackStackEntry?.savedStateHandle</span>
<span class="nc" id="L59">                            ?.remove&lt;String&gt;(&quot;selectedExercises&quot;)</span>
<span class="nc" id="L60">                    }</span>

<span class="nc bnc" id="L62" title="All 4 branches missed.">                navController.currentBackStackEntry?.savedStateHandle</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">                    ?.getLiveData&lt;Long?&gt;(&quot;selectedGroup&quot;)?.observe(lifecycleOwner) { result -&gt;</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                        result?.let {</span>
<span class="nc" id="L65">                            selectGroup(it)</span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">                            navController.currentBackStackEntry?.savedStateHandle</span>
<span class="nc" id="L67">                                ?.remove&lt;Long&gt;(&quot;selectedGroup&quot;)</span>
<span class="nc" id="L68">                        }</span>
<span class="nc" id="L69">                    }</span>
            }
<span class="nc" id="L71">        }</span>
<span class="nc" id="L72">        lifecycleOwner.lifecycle.addObserver(observer)</span>
<span class="nc" id="L73">        onDispose {</span>
            lifecycleOwner.lifecycle.removeObserver(observer)
        }
    }

<span class="nc bnc" id="L78" title="All 2 branches missed.">    if (showExerciseGroupNameDialog.value) {</span>
<span class="nc" id="L79">        AlertDialog(</span>
            onDismissRequest = {
<span class="nc" id="L81">                groupName = &quot;&quot;</span>
<span class="nc" id="L82">                viewModel.hideGroupNameDialog()</span>
<span class="nc" id="L83">            },</span>
<span class="nc bnc" id="L84" title="All 4 branches missed.">            confirmButton = { TextButton(onClick = {</span>
<span class="nc" id="L85">                viewModel.addExerciseGroup(exercisesToGroup.value, groupName = groupName)</span>
<span class="nc" id="L86">                viewModel.hideGroupNameDialog()</span>
<span class="nc" id="L87">                groupName = &quot;&quot;</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">            }) { Text(&quot;OK&quot;) }},</span>
<span class="nc bnc" id="L89" title="All 4 branches missed.">            dismissButton = { TextButton(onClick = {</span>
<span class="nc" id="L90">                groupName = &quot;&quot;</span>
<span class="nc" id="L91">                viewModel.addExerciseGroup(exercisesToGroup.value)</span>
<span class="nc" id="L92">                viewModel.hideGroupNameDialog()</span>
<span class="nc bnc" id="L93" title="All 4 branches missed.">            }) { Text(&quot;Skip&quot;) }},</span>
<span class="nc bnc" id="L94" title="All 4 branches missed.">            title = { Text(</span>
<span class="nc" id="L95">                &quot;Name this group?&quot;,</span>
<span class="nc" id="L96">                style = MaterialTheme.typography.titleSmall</span>
<span class="nc" id="L97">            ) },</span>
<span class="nc" id="L98">            text = {</span>
<span class="nc bnc" id="L99" title="All 4 branches missed.">                Column(</span>
<span class="nc" id="L100">                    modifier = Modifier</span>
<span class="nc" id="L101">                        .fillMaxWidth(.9f)</span>
<span class="nc" id="L102">                        .height(((30 * exercisesToGroup.value.size) + 120).dp),</span>
<span class="nc" id="L103">                    verticalArrangement = Arrangement.SpaceEvenly</span>
                ) {
<span class="nc bnc" id="L105" title="All 4 branches missed.">                    Text(</span>
<span class="nc" id="L106">                        &quot;Create a name for this group of &quot; +</span>
<span class="nc" id="L107">                            &quot;exercises:\n\n${exercisesToGroup.value.joinToString(&quot;\n&quot;)}&quot;,</span>
<span class="nc" id="L108">                        style = MaterialTheme.typography.bodyMedium</span>
                    )
<span class="nc" id="L110">                    TextField(</span>
<span class="nc" id="L111">                        value = groupName,</span>
<span class="nc" id="L112">                        onValueChange = { groupName = it },</span>
<span class="nc" id="L113">                    )</span>
<span class="nc" id="L114">                }</span>
<span class="nc" id="L115">            }</span>
        )
    }

<span class="nc bnc" id="L119" title="All 2 branches missed.">    if (exerciseToRemove != null) {</span>
<span class="nc" id="L120">        AlertDialog(</span>
<span class="nc" id="L121">            onDismissRequest = { exerciseToRemove = null },</span>
<span class="nc bnc" id="L122" title="All 4 branches missed.">            confirmButton = { TextButton(onClick = {</span>
<span class="nc" id="L123">                viewModel.removeSet(exerciseToRemove!!)</span>
<span class="nc" id="L124">                exerciseToRemove = null</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">            }) { Text(&quot;Remove&quot;) }},</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">            dismissButton = { TextButton(onClick = {</span>
<span class="nc" id="L127">                exerciseToRemove = null</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">            }) { Text(&quot;Cancel&quot;) }},</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">            title = { Text(</span>
<span class="nc bnc" id="L130" title="All 6 branches missed.">                &quot;Remove ${exerciseToRemove?.exercise?.name ?: &quot;exercise&quot;}?&quot;,</span>
<span class="nc" id="L131">                style = MaterialTheme.typography.titleSmall</span>
<span class="nc" id="L132">            ) },</span>
        )
    }

<span class="nc bnc" id="L136" title="All 2 branches missed.">    LazyColumn(</span>
<span class="nc" id="L137">        modifier = modifier.testTag(TestTags.ScrollableComponent),</span>
<span class="nc" id="L138">        verticalArrangement = Arrangement.spacedBy(8.dp)</span>
    ) {
<span class="nc" id="L140">        when (val workoutState = viewModel.workoutPlan.value) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            is DataState.Loading -&gt; {</span>
<span class="nc" id="L142">                item {</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">                    CircularProgressIndicator()</span>
<span class="nc" id="L144">                }</span>
            }
<span class="nc bnc" id="L146" title="All 2 branches missed.">            is DataState.Success -&gt; {</span>
<span class="nc" id="L147">                exercisePlanItems(</span>
<span class="nc" id="L148">                    plan = workoutState.data,</span>
<span class="nc" id="L149">                    expectedSets = workoutState.data.entries,</span>
<span class="nc" id="L150">                    uiActions = object : ExercisePlanUiActions {</span>

                        override fun updateWorkoutName(name: String) {
<span class="nc" id="L153">                            viewModel.updateWorkoutName(name)</span>
<span class="nc" id="L154">                        }</span>

                        override fun updateWorkoutNotes(notes: String) {
<span class="nc" id="L157">                            viewModel.updateWorkoutNotes(notes)</span>
<span class="nc" id="L158">                        }</span>

                        override fun updateExercise(
                            setNumber: Int,
                            field: ExercisePlanField,
                            value: Int
                        ) {
<span class="nc bnc" id="L165" title="All 2 branches missed.">                            if (field == ExercisePlanField.SetNumber) {</span>
<span class="nc" id="L166">                                viewModel.updateExercisePosition(setNumber, value)</span>
                            } else {
<span class="nc" id="L168">                                viewModel.updateExercisePlan(setNumber, field, value)</span>
                            }
<span class="nc" id="L170">                        }</span>

                        override fun startWorkout() {
<span class="nc" id="L173">                            navController.navigate(</span>
<span class="nc" id="L174">                                &quot;${FitnessJournalScreen.WorkoutDetails.route}/0?&quot; +</span>
<span class="nc" id="L175">                                        &quot;plan=${workoutState.data.id}&quot;</span>
                            )
<span class="nc" id="L177">                        }</span>

                        override fun addExercise() {
<span class="nc" id="L180">                            navController.navigate(FitnessJournalScreen.SearchExercisesScreen.route)</span>
<span class="nc" id="L181">                        }</span>

                        override fun addExerciseGroup() {
<span class="nc" id="L184">                            navController.navigate(&quot;${FitnessJournalScreen.ExerciseGroupScreen.route}?selectable=true&quot;)</span>
<span class="nc" id="L185">                        }</span>

                        override fun removeExercise(exercise: ExpectedSet) {
<span class="nc" id="L188">                            exerciseToRemove = exercise</span>
<span class="nc" id="L189">                        }</span>
                    }
                )
            }
            else -&gt; {
<span class="nc" id="L194">                item {</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">                    Text(workoutState.toString())</span>
<span class="nc" id="L196">                }</span>
            }
        }
<span class="nc" id="L199">    }</span>
<span class="nc" id="L200">}</span>


fun LazyListScope.exercisePlanItems(
    plan: WorkoutPlan,
    expectedSets: List&lt;ExpectedSet&gt;,
    uiActions: ExercisePlanUiActions?
    ) {

<span class="nc" id="L209">    item {</span>
<span class="nc bnc" id="L210" title="All 4 branches missed.">        FitnessJournalOutlinedTextField(</span>
<span class="nc" id="L211">            value = plan.name,</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            onUpdate = { uiActions?.updateWorkoutName(it) },</span>
<span class="nc" id="L213">            label = &quot;plan name&quot;,</span>
<span class="nc" id="L214">            modifier = Modifier</span>
<span class="nc" id="L215">                .fillMaxWidth()</span>
<span class="nc" id="L216">                .padding(horizontal = 8.dp)</span>
<span class="nc" id="L217">        )</span>
<span class="nc" id="L218">    }</span>

<span class="nc" id="L220">    item {</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">        FitnessJournalOutlinedTextField(</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">            value = plan.note.orEmpty(),</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">            onUpdate = { uiActions?.updateWorkoutNotes(it) },</span>
<span class="nc" id="L224">            singleLine = false,</span>
<span class="nc" id="L225">            label = &quot;note&quot;,</span>
<span class="nc" id="L226">            modifier = Modifier</span>
<span class="nc" id="L227">                .fillMaxWidth()</span>
<span class="nc" id="L228">                .padding(horizontal = 8.dp)</span>
<span class="nc" id="L229">        )</span>
<span class="nc" id="L230">    }</span>

<span class="nc" id="L232">    items(expectedSets) { expected -&gt;</span>
        ExercisePlanCard(
            expected,
            updateExercise = { field, value -&gt;
<span class="nc bnc" id="L236" title="All 2 branches missed.">                uiActions?.updateExercise(expected.positionInWorkout, field, value)</span>
<span class="nc" id="L237">            },</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">            removeExpectedSet = { uiActions?.removeExercise(expected) },</span>
            isFirstSet = expectedSets.minOfOrNull { it.positionInWorkout } == expected.positionInWorkout,
            isLastSet = expectedSets.maxOfOrNull { it.positionInWorkout } == expected.positionInWorkout
        )
    }
<span class="nc" id="L243">    item {</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">        AddExerciseOrGroupButtons(</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            addExercise = { uiActions?.addExercise() },</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            addGroup = { uiActions?.addExerciseGroup() }</span>
<span class="nc" id="L247">        )</span>
<span class="nc" id="L248">    }</span>

<span class="nc" id="L250">    item {</span>
<span class="nc bnc" id="L251" title="All 4 branches missed.">        FitnessJournalButton(</span>
<span class="nc" id="L252">            &quot;Start Workout&quot;,</span>
            onClick = {
<span class="nc bnc" id="L254" title="All 2 branches missed.">                uiActions?.startWorkout()</span>
<span class="nc" id="L255">            },</span>
<span class="nc" id="L256">            fullWidth = true</span>
<span class="nc" id="L257">        )</span>
<span class="nc" id="L258">    }</span>
<span class="nc" id="L259">}</span>

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>