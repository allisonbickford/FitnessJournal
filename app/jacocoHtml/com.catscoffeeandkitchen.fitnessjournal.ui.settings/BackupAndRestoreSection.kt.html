<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BackupAndRestoreSection.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.settings</a> &gt; <span class="el_source">BackupAndRestoreSection.kt</span></div><h1>BackupAndRestoreSection.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.settings

import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Environment
import android.os.FileUtils
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.core.content.ContextCompat
import com.catscoffeeandkitchen.domain.util.DataState
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalButton
import timber.log.Timber
import java.io.File
import java.time.OffsetDateTime
import java.time.format.DateTimeFormatter
import java.time.format.FormatStyle
import kotlin.io.path.createTempFile
import kotlin.io.path.extension
import kotlin.io.path.outputStream


@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun BackupAndRestoreSection(
    showAppClosingDialog: Boolean,
    lastBackupDate: OffsetDateTime,
    backupData: (uri: Uri?) -&gt; Unit,
    restoreData: (file: File?) -&gt; Unit,
    closeApp: () -&gt; Unit,
<span class="nc" id="L45">    modifier: Modifier = Modifier,</span>
<span class="pc bpc" id="L46" title="22 of 38 branches missed.">) {</span>
<span class="fc" id="L47">    val context = LocalContext.current</span>
<span class="pc" id="L48">    var showFileNameDialog by remember { mutableStateOf(false) }</span>

<span class="fc" id="L50">    val chooseFileLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L51">        ActivityResultContracts.GetContent()</span>
    ) { uri -&gt;
<span class="nc bnc" id="L53" title="All 2 branches missed.">        if (uri != null) {</span>
<span class="nc" id="L54">            try {</span>
<span class="nc" id="L55">                val inputStream = context.contentResolver.openInputStream(uri)</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">                if (inputStream != null) {</span>
<span class="nc" id="L57">                    val file = createTempFile(</span>
<span class="nc" id="L58">                        &quot;backup&quot;,</span>
<span class="nc" id="L59">                        suffix = &quot;.llbackup&quot;</span>
                    )
<span class="nc bnc" id="L61" title="All 2 branches missed.">                    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {</span>
<span class="nc" id="L62">                        FileUtils.copy(inputStream, file.outputStream())</span>
                    }
<span class="nc" id="L64">                    inputStream.close()</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                    if (file.extension == &quot;llbackup&quot;) {</span>
<span class="nc" id="L66">                        restoreData(file.toFile())</span>
                    } else {
<span class="nc" id="L68">                        Toast.makeText(context, &quot;Not a backup file.&quot;, Toast.LENGTH_SHORT).show()</span>
                    }
                }
<span class="nc" id="L71">            } catch (ex: Exception) {</span>
<span class="nc" id="L72">                Toast.makeText(context, &quot;There was a problem getting that file.&quot;, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L73">                Timber.e(ex)</span>
            }
        }
<span class="nc" id="L76">    }</span>

<span class="fc" id="L78">    val requestReadPermissionLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L79">        ActivityResultContracts.RequestPermission()</span>
    ) { isGranted: Boolean -&gt;
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (isGranted) {</span>
<span class="nc" id="L82">            chooseFileLauncher.launch(&quot;*/*&quot;)</span>
        } else {
<span class="nc" id="L84">            restoreData(null)</span>
        }
<span class="nc" id="L86">    }</span>

<span class="fc" id="L88">    val chooseSaveLocationLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L89">        ActivityResultContracts.CreateDocument(&quot;*/*&quot;)</span>
    ) { uri -&gt;
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (uri != null) {</span>
<span class="nc" id="L92">            try {</span>
<span class="nc" id="L93">                showFileNameDialog = false</span>
<span class="nc" id="L94">                backupData(uri)</span>
<span class="nc" id="L95">                Toast.makeText(context, &quot;Successfully backed up data.&quot;, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L96">            } catch (ex: Exception) {</span>
<span class="nc" id="L97">                Toast.makeText(context, &quot;There was a problem getting that location.&quot;, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L98">                Timber.e(ex)</span>
            }
        }
<span class="nc" id="L101">    }</span>

<span class="fc" id="L103">    val requestPermissionLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L104">        ActivityResultContracts.RequestPermission()</span>
    ) { isGranted: Boolean -&gt;
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (isGranted) {</span>
<span class="nc" id="L107">            chooseSaveLocationLauncher.launch(&quot;lifting_log_backup&quot;)</span>
        } else {
<span class="nc" id="L109">            backupData(null)</span>
        }
<span class="nc" id="L111">    }</span>

<span class="pc bpc" id="L113" title="1 of 2 branches missed.">    if (showAppClosingDialog) {</span>
<span class="pc" id="L114">        AlertDialog(</span>
<span class="nc" id="L115">            onDismissRequest = { },</span>
<span class="nc" id="L116">            confirmButton = {</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">                TextButton(onClick = {</span>
<span class="nc" id="L118">                    closeApp()</span>
<span class="nc bnc" id="L119" title="All 4 branches missed.">                }) { Text(&quot;OK&quot;) }</span>
<span class="nc" id="L120">            },</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">            dismissButton = {},</span>
<span class="nc bnc" id="L122" title="All 4 branches missed.">            title = { Text(&quot;App Closing&quot;) },</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">            text = { Text(&quot;The app will now close to refresh the database.&quot;)}</span>
        )
    }

<span class="fc" id="L127">    Column(</span>
<span class="fc" id="L128">        modifier = modifier</span>
<span class="fc" id="L129">            .fillMaxWidth()</span>
<span class="fc" id="L130">            .padding(12.dp)</span>
<span class="fc" id="L131">            .border(1.dp, MaterialTheme.colorScheme.primary, MaterialTheme.shapes.small)</span>
<span class="fc" id="L132">            .padding(12.dp),</span>
<span class="fc" id="L133">        verticalArrangement = Arrangement.spacedBy(12.dp),</span>
<span class="fc" id="L134">        horizontalAlignment = Alignment.CenterHorizontally</span>
    ) {
<span class="pc bpc" id="L136" title="3 of 4 branches missed.">        Text(</span>
<span class="fc" id="L137">            &quot;Restoring data will close the app so it can be completely restarted&quot; +</span>
<span class="fc" id="L138">                    &quot; with the correct data.&quot;,</span>
<span class="fc" id="L139">            style = MaterialTheme.typography.bodyLarge,</span>
<span class="fc" id="L140">            modifier = Modifier</span>
<span class="fc" id="L141">                .clip(MaterialTheme.shapes.small)</span>
<span class="fc" id="L142">                .background(MaterialTheme.colorScheme.errorContainer)</span>
<span class="fc" id="L143">                .padding(12.dp),</span>
<span class="fc" id="L144">            color = MaterialTheme.colorScheme.onErrorContainer</span>
        )

<span class="fc" id="L147">        FitnessJournalButton(</span>
<span class="fc" id="L148">            &quot;Backup Data&quot;,</span>
<span class="fc" id="L149">            fullWidth = true,</span>
            onClick = {
<span class="nc" id="L151">                val permission = when {</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                    Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU -&gt; &quot;READ_MEDIA_IMAGES&quot;</span>
<span class="nc" id="L153">                    else -&gt; &quot;WRITE_EXTERNAL_STORAGE&quot;</span>
                }

<span class="nc" id="L156">                when (PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                    ContextCompat.checkSelfPermission(</span>
<span class="nc" id="L158">                        context,</span>
<span class="nc" id="L159">                        &quot;android.permission.$permission&quot;</span>
                    ) -&gt; {
<span class="nc" id="L161">                        chooseSaveLocationLauncher.launch(&quot;lifting_log_backup.llbackup&quot;)</span>
                    }
                    else -&gt; {
                        // You can directly ask for the permission.
                        // The registered ActivityResultCallback gets the result of this request.
<span class="nc" id="L166">                        requestPermissionLauncher.launch(</span>
<span class="nc" id="L167">                            &quot;android.permission.$permission&quot;</span>
                        )
                    }
                }
<span class="nc" id="L171">            }</span>
        )

<span class="fc" id="L174">        FitnessJournalButton(</span>
<span class="fc" id="L175">            &quot;Restore Data&quot;,</span>
<span class="fc" id="L176">            fullWidth = true,</span>
            onClick = {
<span class="nc" id="L178">                val permission = when {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">                    Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU -&gt; &quot;READ_MEDIA_IMAGES&quot;</span>
<span class="nc" id="L180">                    else -&gt; &quot;READ_EXTERNAL_STORAGE&quot;</span>
                }

<span class="nc" id="L183">                when (PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                    ContextCompat.checkSelfPermission(</span>
<span class="nc" id="L185">                        context,</span>
<span class="nc" id="L186">                        &quot;android.permission.$permission&quot;</span>
                    ) -&gt; {
<span class="nc" id="L188">                        chooseFileLauncher.launch(&quot;*/*&quot;)</span>
                    }
                    else -&gt; {
                        // You can directly ask for the permission.
                        // The registered ActivityResultCallback gets the result of this request.
<span class="nc" id="L193">                        requestReadPermissionLauncher.launch(</span>
<span class="nc" id="L194">                            &quot;android.permission.$permission&quot;</span>
                        )
                    }
                }

<span class="nc" id="L199">            }</span>
        )

<span class="fc" id="L202">        Text(</span>
<span class="fc" id="L203">            &quot;This method of backup will keep all your plans and exercise groups.&quot;,</span>
<span class="fc" id="L204">            style = MaterialTheme.typography.labelLarge</span>
<span class="pc" id="L205">        )</span>
<span class="pc" id="L206">    }</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">}</span>

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>