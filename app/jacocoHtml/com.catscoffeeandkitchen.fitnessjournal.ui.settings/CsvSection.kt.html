<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CsvSection.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.fitnessjournal.ui.settings</a> &gt; <span class="el_source">CsvSection.kt</span></div><h1>CsvSection.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.fitnessjournal.ui.settings

import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Build.VERSION_CODES
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.border
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.core.content.ContextCompat
import com.catscoffeeandkitchen.domain.models.csv.CsvFormatError
import com.catscoffeeandkitchen.domain.models.csv.DatabaseError
import com.catscoffeeandkitchen.domain.util.DataState
import com.catscoffeeandkitchen.fitnessjournal.BuildConfig
import com.catscoffeeandkitchen.fitnessjournal.ui.components.FitnessJournalButton
import timber.log.Timber
import java.time.format.DateTimeParseException
import kotlin.math.roundToInt


@Composable
fun CsvSection(
    importStatus: DataState&lt;Double&gt;,
    exportStatus: DataState&lt;Int&gt;,
    importFromCsv: (Uri) -&gt; Unit,
    exportToCsv: (Uri) -&gt; Unit,
<span class="fc" id="L38">    modifier: Modifier = Modifier,</span>
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">) {</span>
<span class="fc" id="L40">    val context = LocalContext.current</span>
<span class="pc" id="L41">    var showImportDialog by remember { mutableStateOf(true) }</span>
<span class="pc" id="L42">    var showExportDialog by remember { mutableStateOf(true) }</span>
<span class="pc" id="L43">    var showImportErrorDialog by remember { mutableStateOf(true) }</span>
<span class="pc" id="L44">    var showExportErrorDialog by remember { mutableStateOf(true) }</span>
<span class="pc bpc" id="L45" title="2 of 4 branches missed.">    val importCount = (importStatus as? DataState.Success)?.data</span>
<span class="pc bpc" id="L46" title="2 of 4 branches missed.">    val exportData = (exportStatus as? DataState.Success)?.data</span>

<span class="fc" id="L48">    val chooseCsvLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L49">        ActivityResultContracts.GetContent()</span>
    ) { uri -&gt;
<span class="nc bnc" id="L51" title="All 2 branches missed.">        if (uri != null) {</span>
<span class="nc" id="L52">            try {</span>
<span class="nc" id="L53">                importFromCsv(uri)</span>
<span class="nc" id="L54">            } catch (ex: Exception) {</span>
<span class="nc" id="L55">                Toast.makeText(context, &quot;There was a problem getting that file.&quot;, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L56">                Timber.e(ex)</span>
            }
        }
<span class="nc" id="L59">    }</span>
<span class="fc" id="L60">    val chooseSaveLocationLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L61">        ActivityResultContracts.CreateDocument(&quot;text/csv&quot;)</span>
    ) { uri -&gt;
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (uri != null) {</span>
<span class="nc" id="L64">            try {</span>
<span class="nc" id="L65">                exportToCsv(uri)</span>
<span class="nc" id="L66">            } catch (ex: Exception) {</span>
<span class="nc" id="L67">                Toast.makeText(context, &quot;There was a problem getting that location.&quot;, Toast.LENGTH_SHORT).show()</span>
<span class="nc" id="L68">                Timber.e(ex)</span>
            }
        }
<span class="nc" id="L71">    }</span>

<span class="fc" id="L73">    val requestReadPermissionLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L74">        ActivityResultContracts.RequestPermission()</span>
    ) { isGranted: Boolean -&gt;
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (isGranted) {</span>
<span class="nc" id="L77">            chooseCsvLauncher.launch(&quot;*/*&quot;)</span>
        } else {
<span class="nc" id="L79">            Toast.makeText(context, &quot;Cannot import CSV without file access permissions.&quot;, Toast.LENGTH_SHORT).show()</span>
        }
<span class="nc" id="L81">    }</span>

<span class="fc" id="L83">    val requestWritePermissionLauncher = rememberLauncherForActivityResult(</span>
<span class="fc" id="L84">        ActivityResultContracts.RequestPermission()</span>
    ) { isGranted: Boolean -&gt;
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (isGranted) {</span>
<span class="nc" id="L87">            chooseSaveLocationLauncher.launch(&quot;text/csv&quot;)</span>
        } else {
<span class="nc" id="L89">            Toast.makeText(context, &quot;Cannot export as CSV without file write permissions.&quot;, Toast.LENGTH_SHORT).show()</span>
        }
<span class="nc" id="L91">    }</span>

<span class="pc bpc" id="L93" title="3 of 4 branches missed.">    if (importCount != null &amp;&amp; importCount &gt; 0.0) {</span>
<span class="nc" id="L94">        AlertDialog(</span>
<span class="nc" id="L95">            onDismissRequest = { },</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">            confirmButton = { },</span>
<span class="nc bnc" id="L97" title="All 4 branches missed.">            dismissButton = {},</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">            title = { Text(&quot;Importing Data&quot;) },</span>
<span class="nc" id="L99">            text = {</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">                Column(</span>
<span class="nc" id="L101">                    modifier = Modifier.fillMaxWidth(),</span>
<span class="nc" id="L102">                    horizontalAlignment = Alignment.CenterHorizontally,</span>
<span class="nc" id="L103">                    verticalArrangement = Arrangement.spacedBy(8.dp)</span>
                ) {
<span class="nc bnc" id="L105" title="All 4 branches missed.">                    CircularProgressIndicator()</span>
<span class="nc bnc" id="L106" title="All 8 branches missed.">                    (importStatus as? DataState.Success)?.data?.roundToInt()?.let { importCount -&gt;</span>
<span class="nc" id="L107">                        Text(&quot;Imported $importCount workouts&quot;)</span>
<span class="nc" id="L108">                    }</span>
<span class="nc" id="L109">                }</span>
<span class="nc" id="L110">            }</span>
        )
<span class="pc bpc" id="L112" title="4 of 6 branches missed.">    } else if (showImportDialog &amp;&amp; importCount != null &amp;&amp; importCount &lt;= 0) {</span>
<span class="nc" id="L113">        AlertDialog(</span>
<span class="nc" id="L114">            onDismissRequest = { showImportDialog = false },</span>
<span class="nc" id="L115">            confirmButton = {</span>
<span class="nc bnc" id="L116" title="All 4 branches missed.">                TextButton(onClick = { showImportDialog = false} ) {</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">                    Text(&quot;OK&quot;)</span>
<span class="nc" id="L118">                }</span>
<span class="nc" id="L119">            },</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">            dismissButton = {},</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">            title = { Text(&quot;Importing Data&quot;) },</span>
<span class="nc" id="L122">            text = {</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">                Text(&quot;Import completed!&quot;)</span>
<span class="nc" id="L124">            }</span>
        )
<span class="pc bpc" id="L126" title="2 of 4 branches missed.">    } else if (showImportErrorDialog &amp;&amp; importStatus is DataState.Error) {</span>
<span class="nc" id="L127">        val errorDescription = when (importStatus.e) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            is CsvFormatError -&gt; &quot;The format of the CSV could not be read.&quot;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">            is DatabaseError -&gt; &quot;Could not merge CSV data with existing data.&quot;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">            is DateTimeParseException -&gt; &quot;Could not read the dates from CSV file.&quot;</span>
<span class="nc" id="L131">            else -&gt; &quot;Could not read CSV.&quot;</span>
        }

<span class="nc" id="L134">        AlertDialog(</span>
<span class="nc" id="L135">            onDismissRequest = { showImportErrorDialog = false },</span>
<span class="nc" id="L136">            confirmButton = {</span>
<span class="nc bnc" id="L137" title="All 4 branches missed.">                TextButton(onClick = { showImportErrorDialog = false } ) {</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">                    Text(&quot;OK&quot;)</span>
<span class="nc" id="L139">                }</span>
<span class="nc" id="L140">            },</span>
<span class="nc bnc" id="L141" title="All 4 branches missed.">            dismissButton = {},</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">            title = { Text(&quot;Import Error&quot;) },</span>
<span class="nc" id="L143">            text = {</span>
<span class="nc bnc" id="L144" title="All 4 branches missed.">                Text(errorDescription)</span>
<span class="nc" id="L145">            }</span>
        )

<span class="pc bpc" id="L148" title="3 of 4 branches missed.">    } else if (exportData != null &amp;&amp; exportData &gt; 0) {</span>
<span class="nc" id="L149">        AlertDialog(</span>
<span class="nc" id="L150">            onDismissRequest = { },</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">            confirmButton = { },</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">            dismissButton = {},</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">            title = { Text(&quot;Exporting Data&quot;) },</span>
<span class="nc" id="L154">            text = {</span>
<span class="nc bnc" id="L155" title="All 4 branches missed.">                Column(</span>
<span class="nc" id="L156">                    modifier = Modifier.fillMaxWidth(),</span>
<span class="nc" id="L157">                    horizontalAlignment = Alignment.CenterHorizontally,</span>
<span class="nc" id="L158">                    verticalArrangement = Arrangement.spacedBy(8.dp)</span>
                ) {
<span class="nc bnc" id="L160" title="All 4 branches missed.">                    CircularProgressIndicator()</span>
<span class="nc bnc" id="L161" title="All 6 branches missed.">                    (exportStatus as? DataState.Success)?.data?.let { exportCount -&gt;</span>
<span class="nc" id="L162">                        Text(&quot;Exported $exportCount sets&quot;)</span>
<span class="nc" id="L163">                    }</span>
<span class="nc" id="L164">                }</span>
<span class="nc" id="L165">            }</span>
        )
<span class="pc bpc" id="L167" title="2 of 4 branches missed.">    } else if (showExportErrorDialog &amp;&amp; exportStatus is DataState.Error) {</span>
<span class="nc" id="L168">        AlertDialog(</span>
<span class="nc" id="L169">            onDismissRequest = { showExportErrorDialog = false },</span>
<span class="nc" id="L170">            confirmButton = {</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">                TextButton(onClick = { showExportErrorDialog = false }) {</span>
<span class="nc bnc" id="L172" title="All 4 branches missed.">                    Text(&quot;OK&quot;)</span>
<span class="nc" id="L173">                }</span>
<span class="nc" id="L174">            },</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">            dismissButton = {},</span>
<span class="nc bnc" id="L176" title="All 4 branches missed.">            title = { Text(&quot;Export Error&quot;) },</span>
<span class="nc" id="L177">            text = {</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">                Text(&quot;There was a problem exporting your workouts.&quot;)</span>
<span class="nc" id="L179">            }</span>
        )
<span class="pc bpc" id="L181" title="2 of 4 branches missed.">    } else if (showExportDialog &amp;&amp; exportData != null) {</span>
<span class="nc" id="L182">        AlertDialog(</span>
<span class="nc" id="L183">            onDismissRequest = { showExportDialog = false },</span>
<span class="nc" id="L184">            confirmButton = {</span>
<span class="nc bnc" id="L185" title="All 4 branches missed.">                TextButton(onClick = { showExportDialog = false} ) {</span>
<span class="nc bnc" id="L186" title="All 4 branches missed.">                    Text(&quot;OK&quot;)</span>
<span class="nc" id="L187">                }</span>
<span class="nc" id="L188">            },</span>
<span class="nc bnc" id="L189" title="All 4 branches missed.">            dismissButton = {},</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">            title = { Text(&quot;Exporting Data&quot;) },</span>
<span class="nc" id="L191">            text = {</span>
<span class="nc bnc" id="L192" title="All 4 branches missed.">                Text(&quot;Export completed!&quot;)</span>
<span class="nc" id="L193">            }</span>
        )
<span class="fc" id="L195">    }</span>

<span class="fc" id="L197">        Column(</span>
<span class="fc" id="L198">        modifier = modifier</span>
<span class="fc" id="L199">            .fillMaxWidth()</span>
<span class="fc" id="L200">            .padding(12.dp)</span>
<span class="fc" id="L201">            .border(1.dp, MaterialTheme.colorScheme.primary, MaterialTheme.shapes.small)</span>
<span class="fc" id="L202">            .padding(12.dp),</span>
<span class="fc" id="L203">        verticalArrangement = Arrangement.spacedBy(12.dp),</span>
<span class="fc" id="L204">        horizontalAlignment = Alignment.CenterHorizontally</span>
    ) {

<span class="pc bpc" id="L207" title="3 of 4 branches missed.">        FitnessJournalButton(</span>
<span class="fc" id="L208">            &quot;Import from CSV&quot;,</span>
<span class="fc" id="L209">            fullWidth = true,</span>
            onClick = {
<span class="nc" id="L211">                val permission = when {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                    Build.VERSION.SDK_INT &gt;= VERSION_CODES.TIRAMISU -&gt; &quot;READ_MEDIA_IMAGES&quot;</span>
<span class="nc" id="L213">                    else -&gt; &quot;WRITE_EXTERNAL_STORAGE&quot;</span>
                }

<span class="nc" id="L216">                when (PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                    ContextCompat.checkSelfPermission(</span>
<span class="nc" id="L218">                        context,</span>
<span class="nc" id="L219">                        &quot;android.permission.$permission&quot;</span>
                    ) -&gt; {
<span class="nc" id="L221">                        chooseCsvLauncher.launch(&quot;*/*&quot;)</span>
                    }
                    else -&gt; {
                        // You can directly ask for the permission.
                        // The registered ActivityResultCallback gets the result of this request.
<span class="nc" id="L226">                        requestReadPermissionLauncher.launch(</span>
<span class="nc" id="L227">                            &quot;android.permission.$permission&quot;</span>
                        )
                    }
                }
<span class="nc" id="L231">            }</span>
        )

<span class="fc" id="L234">        FitnessJournalButton(</span>
<span class="fc" id="L235">            &quot;Export to CSV&quot;,</span>
<span class="fc" id="L236">            fullWidth = true,</span>
            onClick = {
<span class="nc" id="L238">                val permission = when {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    Build.VERSION.SDK_INT &gt;= VERSION_CODES.TIRAMISU -&gt; &quot;READ_MEDIA_IMAGES&quot;</span>
<span class="nc" id="L240">                    else -&gt; &quot;WRITE_EXTERNAL_STORAGE&quot;</span>
                }

<span class="nc" id="L243">                when (PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                    ContextCompat.checkSelfPermission(</span>
<span class="nc" id="L245">                        context,</span>
<span class="nc" id="L246">                        &quot;android.permission.$permission&quot;</span>
                    ) -&gt; {
<span class="nc" id="L248">                        chooseSaveLocationLauncher.launch(&quot;lifting_log.csv&quot;)</span>
                    }
                    else -&gt; {
                        // You can directly ask for the permission.
                        // The registered ActivityResultCallback gets the result of this request.
<span class="nc" id="L253">                        requestWritePermissionLauncher.launch(</span>
<span class="nc" id="L254">                            &quot;android.permission.$permission&quot;</span>
                        )
                    }
                }
<span class="nc" id="L258">            }</span>
        )


<span class="fc" id="L262">        Text(</span>
<span class="fc" id="L263">            &quot;Importing and exporting CSVs will only affect workouts, NOT plans or exercise groups.&quot;,</span>
<span class="fc" id="L264">            style = MaterialTheme.typography.labelLarge</span>
<span class="pc" id="L265">        )</span>
<span class="pc" id="L266">    }</span>
<span class="fc" id="L267">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>