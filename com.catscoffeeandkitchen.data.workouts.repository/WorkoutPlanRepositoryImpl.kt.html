<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkoutPlanRepositoryImpl.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.data.workouts.repository</a> &gt; <span class="el_source">WorkoutPlanRepositoryImpl.kt</span></div><h1>WorkoutPlanRepositoryImpl.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.data.workouts.repository

import com.catscoffeeandkitchen.data.workouts.db.FitnessJournalDb
import com.catscoffeeandkitchen.data.workouts.models.ExerciseGoal
import com.catscoffeeandkitchen.data.workouts.models.exercise.ExercisePositionEntity
import com.catscoffeeandkitchen.data.workouts.util.*
import com.catscoffeeandkitchen.data.workouts.models.WorkoutPlanEntity as DbWorkoutPlan
import com.catscoffeeandkitchen.data.workouts.models.exercise.ExerciseEntity as DbExercise
import com.catscoffeeandkitchen.domain.interfaces.WorkoutPlanRepository
import com.catscoffeeandkitchen.domain.models.*
import timber.log.Timber
import java.time.DayOfWeek
import java.time.OffsetDateTime
import javax.inject.Inject
import kotlin.math.roundToInt

<span class="nc" id="L17">class WorkoutPlanRepositoryImpl @Inject constructor(</span>
<span class="nc" id="L18">    private val database: FitnessJournalDb</span>
): WorkoutPlanRepository {
<span class="nc" id="L20">    override suspend fun getWorkoutPlans(): List&lt;WorkoutPlan&gt; {</span>
<span class="nc" id="L21">        return database.workoutPlanDao().getAllWithGoals().map { dbWorkout -&gt;</span>
<span class="nc" id="L22">            Timber.d(&quot;got workout ${dbWorkout.plan.wpId}, note = ${dbWorkout.plan.note}&quot;)</span>
<span class="nc" id="L23">            WorkoutPlan(</span>
<span class="nc" id="L24">                id = dbWorkout.plan.wpId,</span>
<span class="nc" id="L25">                addedAt = dbWorkout.plan.addedAt,</span>
<span class="nc" id="L26">                name = dbWorkout.plan.name,</span>
<span class="nc" id="L27">                note = dbWorkout.plan.note,</span>
<span class="nc" id="L28">                entries = getExpectedSetFromGoals(dbWorkout.goals),</span>
<span class="nc" id="L29">                daysOfWeek = dbWorkout.plan.daysOfWeek.map { DayOfWeek.valueOf(it) }</span>
            )
        }
    }

<span class="nc" id="L34">    override suspend fun getWorkoutPlan(id: Long): WorkoutPlan {</span>
<span class="nc" id="L35">        val dbWorkout = database.workoutPlanDao().getWorkoutPlanWithGoalsById(id)</span>
<span class="nc" id="L36">        return WorkoutPlan(</span>
<span class="nc" id="L37">            id = dbWorkout.plan.wpId,</span>
<span class="nc" id="L38">            addedAt = dbWorkout.plan.addedAt,</span>
<span class="nc" id="L39">            name = dbWorkout.plan.name,</span>
<span class="nc" id="L40">            note = dbWorkout.plan.note,</span>
<span class="nc" id="L41">            entries = getExpectedSetFromGoals(dbWorkout.goals),</span>
<span class="nc" id="L42">            daysOfWeek = dbWorkout.plan.daysOfWeek.map { DayOfWeek.valueOf(it) }</span>
        )
    }

    override suspend fun createWorkoutPlan(plan: WorkoutPlan) {
<span class="nc" id="L47">        database.workoutPlanDao().insert(plan.toEntity())</span>
<span class="nc" id="L48">    }</span>

<span class="nc" id="L50">    override suspend fun createPlanFromWorkout(workout: Workout): OffsetDateTime {</span>
<span class="nc" id="L51">        val workoutEntity = database.workoutDao().getWorkoutByAddedAt(workout.addedAt)</span>
<span class="nc" id="L52">        val planToAdd = DbWorkoutPlan(</span>
<span class="nc" id="L53">            wpId = 0L,</span>
<span class="nc" id="L54">            addedAt = OffsetDateTime.now(),</span>
<span class="nc" id="L55">            name = &quot;Plan from ${workout.name}&quot;,</span>
        )
<span class="nc" id="L57">        val planId = database.workoutPlanDao().insert(planToAdd)</span>
<span class="nc" id="L58">        val workoutPositions = database.exercisePositionDao().getPositionsWithExerciseAndSets(workoutEntity.wId)</span>

<span class="nc" id="L60">        val dbExercises = arrayListOf&lt;DbExercise&gt;()</span>
<span class="nc" id="L61">        val goals = workoutPositions.map { item -&gt;</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">            item.exercise?.let { dbExercises.add(it) }</span>
<span class="nc bnc" id="L63" title="All 4 branches missed.">            val position = workoutPositions.first { it.position.epId == item.position.epId }</span>
<span class="nc" id="L64">            val positionId = database.exercisePositionDao().insert(</span>
<span class="nc" id="L65">                position.position.copy(epId = 0L, planId = planId)</span>
            )

<span class="nc" id="L68">            ExerciseGoal(</span>
<span class="nc" id="L69">                egId = 0L,</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                exerciseId = item.exercise?.eId ?: 0L,</span>
<span class="nc" id="L71">                workoutPlanId = planId,</span>
<span class="nc" id="L72">                sets = item.exerciseSets.size,</span>
<span class="nc" id="L73">                positionId = positionId,</span>
<span class="nc" id="L74">                reps = item.exerciseSets.map { it.reps }.average().roundToInt(),</span>
<span class="nc bnc" id="L75" title="All 6 branches missed.">                repRangeMax = item.exerciseSets.minOf { it.reps },</span>
<span class="nc bnc" id="L76" title="All 6 branches missed.">                repRangeMin = item.exerciseSets.maxOf { it.reps },</span>
<span class="nc" id="L77">                weightInPounds = item.exerciseSets.map { it.weightInPounds }.average().toFloat(),</span>
<span class="nc" id="L78">                weightInKilograms = item.exerciseSets.map { it.weightInKilograms }.average().toFloat(),</span>
<span class="nc" id="L79">                repsInReserve = item.exerciseSets.map { it.repsInReserve }.average().roundToInt(),</span>
<span class="nc" id="L80">                perceivedExertion = item.exerciseSets.map { it.perceivedExertion }.average().roundToInt(),</span>
<span class="nc" id="L81">                note = &quot;&quot;,</span>
            )
        }
<span class="nc" id="L84">        database.exerciseGoalDao().insertAll(goals)</span>

<span class="nc" id="L86">        return planToAdd.addedAt</span>
    }

<span class="nc" id="L89">    override suspend fun updateWorkoutPlan(plan: WorkoutPlan) {</span>
<span class="nc" id="L90">        val dbPlan = database.workoutPlanDao().getById(plan.id)</span>
<span class="nc" id="L91">        database.workoutPlanDao().update(plan.toEntity(dbPlan.wpId))</span>
<span class="nc" id="L92">    }</span>

<span class="nc" id="L94">    override suspend fun addExpectedSetToWorkout(workout: WorkoutPlan, expectedSet: ExpectedSet) {</span>
<span class="nc" id="L95">        val dbWorkout = database.workoutPlanDao().getWorkoutPlanByAddedAt(workout.addedAt)</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        val exercise = expectedSet.exercise?.let { database.exerciseDao().getExerciseByName(it.name) }</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        Timber.d(&quot;adding ${exercise?.name} at set ${workout.entries.size} to workout ${dbWorkout.wpId}&quot;)</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">        val setNumber = if (workout.entries.isNotEmpty())</span>
<span class="nc bnc" id="L99" title="All 6 branches missed.">            workout.entries.maxOf { it.positionInWorkout } + 1</span>
<span class="nc" id="L100">            else 1</span>

<span class="nc" id="L102">        val positionId = database.exercisePositionDao().insert(</span>
<span class="nc" id="L103">            ExercisePositionEntity(</span>
<span class="nc" id="L104">                epId = 0L,</span>
<span class="nc" id="L105">                workoutId = null,</span>
<span class="nc" id="L106">                planId = dbWorkout.wpId,</span>
<span class="nc" id="L107">                position = setNumber,</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                exerciseId = exercise?.eId,</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                groupId = expectedSet.exerciseGroup?.id</span>
            )
        )

<span class="nc" id="L113">        val id = database.exerciseGoalDao().insert(</span>
<span class="nc" id="L114">            ExerciseGoal(</span>
<span class="nc" id="L115">                egId = 0L,</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">                exerciseId = exercise?.eId,</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                exerciseGroupId = expectedSet.exerciseGroup?.id,</span>
<span class="nc" id="L118">                workoutPlanId = dbWorkout.wpId,</span>
<span class="nc" id="L119">                sets = expectedSet.sets,</span>
<span class="nc" id="L120">                reps = expectedSet.reps,</span>
<span class="nc" id="L121">                repRangeMax = expectedSet.maxReps,</span>
<span class="nc" id="L122">                repRangeMin = expectedSet.minReps,</span>
<span class="nc" id="L123">                repsInReserve = expectedSet.rir,</span>
<span class="nc" id="L124">                perceivedExertion = expectedSet.perceivedExertion,</span>
<span class="nc" id="L125">                positionId = positionId,</span>
            )
        )
<span class="nc" id="L128">        Timber.d(&quot;successfully added workout goal $id&quot;)</span>
<span class="nc" id="L129">    }</span>

<span class="nc" id="L131">    override suspend fun removeExpectedSetFromWorkout(workout: WorkoutPlan, expectedSet: ExpectedSet) {</span>
<span class="nc" id="L132">        val planWithGoals = database.workoutPlanDao().getWithGoalsByAddedAt(workout.addedAt)</span>
<span class="nc" id="L133">        val positions = database.exercisePositionDao().getPositionsInPlan(planWithGoals.plan.wpId)</span>

<span class="nc" id="L135">        val dbExerciseGoal = database.exerciseGoalDao().getByPlanAndPositionId(</span>
<span class="nc" id="L136">            planId = planWithGoals.plan.wpId,</span>
<span class="nc bnc" id="L137" title="All 4 branches missed.">            positionId = positions.first { it.position == expectedSet.positionInWorkout }.epId</span>
        )
<span class="nc" id="L139">        database.exerciseGoalDao().delete(dbExerciseGoal)</span>

<span class="nc" id="L141">        val updatedPositions = positions</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">            .filter { it.position &gt; expectedSet.positionInWorkout }.map { entry -&gt;</span>
<span class="nc" id="L143">                entry.copy(position = entry.position - 1)</span>
            }

<span class="nc" id="L146">        database.exercisePositionDao().updateAll(updatedPositions)</span>
<span class="nc" id="L147">    }</span>

<span class="nc" id="L149">    override suspend fun updateExpectedSet(</span>
        workout: WorkoutPlan,
        expectedSet: ExpectedSet
    ) {
<span class="nc" id="L153">        val planEntity = database.workoutPlanDao().getWorkoutPlanByAddedAt(workout.addedAt)</span>
<span class="nc" id="L154">        val position = database.exercisePositionDao().getPositionInPlanByPosition(</span>
<span class="nc" id="L155">            planEntity.wpId,</span>
<span class="nc" id="L156">            position = expectedSet.positionInWorkout</span>
        )

<span class="nc" id="L159">        val dbExerciseGoal = database.exerciseGoalDao().getByPlanAndPositionId(</span>
<span class="nc" id="L160">            planEntity.wpId,</span>
<span class="nc" id="L161">            positionId = position.epId</span>
        )

<span class="nc" id="L164">        database.exerciseGoalDao().update(</span>
<span class="nc" id="L165">            expectedSet.toGoal(</span>
<span class="nc" id="L166">                exerciseId = dbExerciseGoal.exerciseId,</span>
<span class="nc" id="L167">                groupId = dbExerciseGoal.exerciseGroupId,</span>
<span class="nc" id="L168">                planId = planEntity.wpId,</span>
<span class="nc" id="L169">                positionId = dbExerciseGoal.positionId</span>
            )
        )
<span class="nc" id="L172">    }</span>

<span class="nc" id="L174">    override suspend fun updateExpectedSetPosition(</span>
        workout: WorkoutPlan,
        expectedSet: ExpectedSet,
        newPosition: Int
    ) {
<span class="nc" id="L179">        val planEntity = database.workoutPlanDao().getWorkoutPlanByAddedAt(workout.addedAt)</span>
<span class="nc" id="L180">        val positions = database.exercisePositionDao().getPositionsInPlan(planEntity.wpId)</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">        val movingUp = expectedSet.positionInWorkout &gt; newPosition</span>
<span class="nc bnc" id="L183" title="All 8 branches missed.">        positions.find { it.position == newPosition }?.let { entry -&gt;</span>
<span class="nc" id="L184">            Timber.d(&quot;*** updating ${entry.position} to &quot; +</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                    &quot;${if (movingUp) (entry.position + 1) else (entry.position - 1)}&quot;)</span>
<span class="nc" id="L186">            database.exercisePositionDao().update(entry.copy(</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                position = if (movingUp) (entry.position + 1) else (entry.position - 1)</span>
            ))
<span class="nc" id="L189">        }</span>

<span class="nc bnc" id="L191" title="All 8 branches missed.">        positions.find { it.position == expectedSet.positionInWorkout }?.let { positionToMove -&gt;</span>
<span class="nc" id="L192">            database.exercisePositionDao().update(positionToMove.copy(position = newPosition))</span>
<span class="nc" id="L193">        }</span>
<span class="nc" id="L194">    }</span>

<span class="nc" id="L196">    private suspend fun getExpectedSetFromGoals(goals: List&lt;ExerciseGoal&gt;): List&lt;ExpectedSet&gt; {</span>
<span class="nc" id="L197">        return goals.mapNotNull { goal -&gt;</span>
<span class="nc" id="L198">            val position = database.exercisePositionDao().getPosition(goal.positionId)</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            when {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                goal.exerciseId != null -&gt; {</span>
<span class="nc" id="L201">                    val dbExercise = database.exerciseDao().getExerciseById(goal.exerciseId)</span>
<span class="nc" id="L202">                    goal.toExpectedSet(</span>
<span class="nc" id="L203">                        position = position.position,</span>
<span class="nc" id="L204">                        exercise = dbExercise.toExercise(position.position)</span>
                    )
                }
<span class="nc bnc" id="L207" title="All 2 branches missed.">                goal.exerciseGroupId != null -&gt; {</span>
<span class="nc" id="L208">                    val dbExerciseGroup =</span>
<span class="nc" id="L209">                        database.exerciseGroupDao().getGroupByIdWithExercises(goal.exerciseGroupId)</span>

<span class="nc" id="L211">                    goal.toExpectedSet(</span>
<span class="nc" id="L212">                        position = position.position,</span>
<span class="nc" id="L213">                        group = dbExerciseGroup.group.toExerciseGroup(</span>
<span class="nc" id="L214">                            exercises = dbExerciseGroup.exercises.map { it.toExercise(position.position) },</span>
                        )
                    )
                }
<span class="nc" id="L218">                else -&gt; null</span>
            }
<span class="nc" id="L220">        }.sortedBy { it.positionInWorkout }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>