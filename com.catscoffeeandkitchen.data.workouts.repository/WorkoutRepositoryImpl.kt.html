<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkoutRepositoryImpl.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.data.workouts.repository</a> &gt; <span class="el_source">WorkoutRepositoryImpl.kt</span></div><h1>WorkoutRepositoryImpl.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.data.workouts.repository

import androidx.paging.*
import com.catscoffeeandkitchen.data.workouts.db.FitnessJournalDb
import com.catscoffeeandkitchen.data.workouts.models.exercise.ExercisePositionEntity
import com.catscoffeeandkitchen.data.workouts.models.ExerciseSetPartial
import com.catscoffeeandkitchen.data.workouts.models.SetEntity
import com.catscoffeeandkitchen.data.workouts.models.WorkoutEntity
import com.catscoffeeandkitchen.data.workouts.util.*
import com.catscoffeeandkitchen.domain.interfaces.WorkoutRepository
import com.catscoffeeandkitchen.domain.models.*
import kotlinx.coroutines.flow.*
import timber.log.Timber
import java.time.DayOfWeek
import java.time.OffsetDateTime

<span class="fc" id="L17">@OptIn(ExperimentalPagingApi::class)</span>
<span class="fc" id="L18">class WorkoutRepositoryImpl(</span>
<span class="fc" id="L19">    val database: FitnessJournalDb,</span>
): WorkoutRepository {
<span class="fc" id="L21">    override suspend fun getWorkouts(): List&lt;Workout&gt; {</span>
<span class="fc" id="L22">        return database.workoutDao().getWorkoutsWithPlans().map { dbWorkout -&gt;</span>
<span class="fc" id="L23">            val entryData = database.exercisePositionDao()</span>
<span class="fc" id="L24">                .getPositionsWithExerciseAndSets(dbWorkout.workout.wId)</span>

<span class="fc" id="L26">            Workout(</span>
<span class="fc" id="L27">                id = dbWorkout.workout.wId,</span>
<span class="fc" id="L28">                name = dbWorkout.workout.name,</span>
<span class="fc" id="L29">                note = dbWorkout.workout.note,</span>
<span class="fc" id="L30">                completedAt = dbWorkout.workout.completedAt,</span>
<span class="fc" id="L31">                addedAt = dbWorkout.workout.addedAt,</span>
<span class="fc bfc" id="L32" title="All 2 branches covered.">                plan = if (dbWorkout.plan == null) null else</span>
<span class="fc" id="L33">                    WorkoutPlan(</span>
<span class="fc" id="L34">                        id = dbWorkout.plan.wpId,</span>
<span class="fc" id="L35">                        addedAt = dbWorkout.plan.addedAt,</span>
<span class="fc" id="L36">                        name = dbWorkout.plan.name,</span>
<span class="fc" id="L37">                        note = dbWorkout.plan.note,</span>
<span class="fc" id="L38">                        entries = emptyList(),</span>
<span class="pc" id="L39">                        daysOfWeek = dbWorkout.plan.daysOfWeek.map { DayOfWeek.valueOf(it) }</span>
                ),
<span class="fc" id="L41">                entries = entryData.map { entry -&gt;</span>
<span class="fc" id="L42">                    WorkoutEntry(</span>
<span class="fc" id="L43">                        position = entry.position.position,</span>
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">                        exercise = entry.exercise?.toExercise(),</span>
<span class="pc bpc" id="L45" title="8 of 10 branches missed.">                        expectedSet = dbWorkout.goals.find { it.goal.positionId == entry.position.epId }?.goal</span>
<span class="pc" id="L46">                            ?.toExpectedSet(entry.position.position),</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">                        sets = if (entry.exercise == null) emptyList()</span>
<span class="fc" id="L48">                            else entry.exerciseSets.map { set -&gt;</span>
<span class="fc" id="L49">                                set.toExerciseSet(entry.exercise.toExercise())</span>
<span class="fc" id="L50">                            }.sortedBy { it.setNumber }</span>
                    )
                }
            )
        }
    }

    override fun getPagedWorkouts(): Flow&lt;PagingData&lt;Workout&gt;&gt; {
<span class="nc" id="L58">        return Pager(</span>
<span class="nc" id="L59">            config = PagingConfig(</span>
<span class="nc" id="L60">                pageSize = 20,</span>
<span class="nc" id="L61">                enablePlaceholders = false,</span>
<span class="nc" id="L62">                prefetchDistance = 5</span>
            ),
            pagingSourceFactory = {
<span class="nc" id="L65">                database.workoutDao().getAllPaged()</span>
            }
<span class="nc" id="L67">        ).flow.map { pagingData -&gt;</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            pagingData.map { data -&gt;</span>
<span class="nc" id="L69">                data.workout.toWorkout().copy(</span>
<span class="nc" id="L70">                    entries = data.sets.groupBy { it.positionInWorkout.position }.map { set -&gt;</span>
<span class="nc" id="L71">                        WorkoutEntry(</span>
<span class="nc" id="L72">                            position = set.key,</span>
<span class="nc" id="L73">                            exercise = set.value.first().exercise.toExercise(),</span>
<span class="nc" id="L74">                            expectedSet = null,</span>
<span class="nc" id="L75">                            sets = set.value.map { it.set.toExerciseSet(it.exercise.toExercise()) }.sortedBy { it.setNumber }</span>
                        )
<span class="nc" id="L77">                    }.sortedBy { it.position },</span>
                ) }
        }
    }

    override suspend fun getWorkoutCompletedDates(monthsBack: Int): List&lt;OffsetDateTime&gt; {
<span class="fc" id="L83">        val earliest = OffsetDateTime.now().minusMonths(monthsBack.toLong())</span>
<span class="fc" id="L84">        return database.workoutDao().getAllCompletedWorkoutDates(earliest.toUTCEpochMilli())</span>
    }

<span class="fc" id="L87">    override suspend fun getWorkout(id: Long): Workout {</span>
<span class="fc" id="L88">        Timber.d(&quot;*** getting workout $id&quot;)</span>
<span class="fc" id="L89">        val dbWorkout = database.workoutDao().getWorkout(id)</span>
<span class="fc" id="L90">        val sets = database.exercisePositionDao().getPositionsWithExerciseAndSets(dbWorkout.wId)</span>

<span class="fc" id="L92">        val plan = when (dbWorkout.planId) {</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">            null -&gt; null</span>
<span class="fc" id="L94">            else -&gt; database.workoutPlanDao().getWorkoutPlanWithGoalsById(dbWorkout.planId)</span>
        }

<span class="fc" id="L97">        return Workout(</span>
<span class="fc" id="L98">            id = dbWorkout.wId,</span>
<span class="fc" id="L99">            name = dbWorkout.name,</span>
<span class="fc" id="L100">            note = dbWorkout.note,</span>
<span class="fc" id="L101">            completedAt = dbWorkout.completedAt,</span>
<span class="fc" id="L102">            addedAt = dbWorkout.addedAt,</span>
<span class="fc" id="L103">            entries = sets.map { data -&gt;</span>
<span class="pc bpc" id="L104" title="2 of 8 branches missed.">                val matchingGoal = plan?.goals?.find { goal -&gt;</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">                    goal.exerciseGroupId == data.position.groupId ||</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">                            goal.exerciseId == data.position.exerciseId</span>
                }
<span class="fc" id="L108">                val groupedExercises = when {</span>
<span class="fc bfc" id="L109" title="All 4 branches covered.">                    matchingGoal?.exerciseGroupId != null -&gt; database.exerciseGroupDao()</span>
<span class="fc" id="L110">                        .getGroupByIdWithExercises(matchingGoal.exerciseGroupId).exercises</span>
<span class="fc" id="L111">                    else -&gt; emptyList()</span>
                }

<span class="fc" id="L114">                WorkoutEntry(</span>
<span class="fc" id="L115">                    position = data.position.position,</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">                    exercise = data.exercise?.toExercise(),</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">                    expectedSet = matchingGoal?.toExpectedSet(</span>
<span class="fc" id="L118">                        data.position.position,</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">                        data.exercise?.toExercise(),</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">                        data.group?.toExerciseGroup(groupedExercises.map { it.toExercise() })</span>
                    ),
<span class="fc" id="L122">                    sets = data.exerciseSets.mapNotNull { set -&gt;</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">                        if (data.exercise == null) null</span>
<span class="nc" id="L124">                        else set.toExerciseSet(data.exercise.toExercise())</span>
<span class="fc" id="L125">                    }.sortedBy { it.setNumber }</span>
                )
<span class="fc" id="L127">            }.sortedBy { it.position },</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">            plan = if (plan == null) null else</span>
<span class="fc" id="L129">                WorkoutPlan(</span>
<span class="fc" id="L130">                    id = plan.plan.wpId,</span>
<span class="fc" id="L131">                    addedAt = plan.plan.addedAt,</span>
<span class="fc" id="L132">                    name = plan.plan.name,</span>
<span class="fc" id="L133">                    note = plan.plan.note,</span>
<span class="fc" id="L134">                    entries = emptyList(),</span>
<span class="pc" id="L135">                    daysOfWeek = plan.plan.daysOfWeek.map { DayOfWeek.valueOf(it) }</span>
                )
        )
    }

<span class="fc" id="L140">    override suspend fun createWorkout(workout: Workout, planId: Long?): Workout {</span>
<span class="fc" id="L141">        val planEntry = when (planId) {</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">            null -&gt; null</span>
<span class="fc" id="L143">            else -&gt; database.workoutPlanDao().getWorkoutPlanWithGoalsById(planId)</span>
        }
<span class="fc bfc" id="L145" title="All 2 branches covered.">        val plan = planEntry?.plan</span>

<span class="fc" id="L147">        val workoutId = database.workoutDao().insert(</span>
<span class="fc" id="L148">            WorkoutEntity(</span>
<span class="fc" id="L149">                wId = 0L,</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">                planId = plan?.wpId,</span>
<span class="fc bfc" id="L151" title="All 4 branches covered.">                name = plan?.name ?: &quot;${OffsetDateTime.now().dayOfWeek.name.lowercase()} workout&quot;,</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">                note = plan?.note,</span>
<span class="fc" id="L153">                minutesToComplete = 0,</span>
<span class="fc" id="L154">                completedAt = workout.completedAt,</span>
<span class="fc" id="L155">                addedAt = workout.addedAt,</span>
            )
        )

<span class="fc" id="L159">        var createdWorkout = workout.copy(id = workoutId)</span>
<span class="pc bpc" id="L160" title="1 of 4 branches missed.">        if (planEntry != null &amp;&amp; plan != null) {</span>
<span class="fc" id="L161">            val planPositions = database.exercisePositionDao().getPositionsInPlan(plan.wpId)</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            val dbExercises = database.exerciseDao().getExercisesByIds(planEntry.goals.mapNotNull { it.exerciseId })</span>

<span class="fc" id="L164">            createdWorkout = createdWorkout.copy(</span>
<span class="fc" id="L165">                plan = WorkoutPlan(</span>
<span class="fc" id="L166">                    id = plan.wpId,</span>
<span class="fc" id="L167">                    addedAt = plan.addedAt,</span>
<span class="fc" id="L168">                    name = plan.name,</span>
<span class="fc" id="L169">                    note = plan.note,</span>
<span class="fc" id="L170">                    entries = emptyList(),</span>
<span class="pc" id="L171">                    daysOfWeek = plan.daysOfWeek.map { DayOfWeek.valueOf(it) }</span>
                ),
            )

<span class="fc" id="L175">            val positions = planPositions</span>
<span class="fc" id="L176">                .map { position -&gt;</span>
<span class="fc" id="L177">                    ExercisePositionEntity(</span>
<span class="fc" id="L178">                        epId = 0L,</span>
<span class="fc" id="L179">                        exerciseId = position.exerciseId,</span>
<span class="fc" id="L180">                        groupId = position.groupId,</span>
<span class="fc" id="L181">                        workoutId = workoutId,</span>
<span class="fc" id="L182">                        position = position.position,</span>
                    )
                }
<span class="fc" id="L185">            database.exercisePositionDao().insertAll(positions)</span>

<span class="fc" id="L187">            val addedPositions = database.exercisePositionDao().getPositionsInWorkout(workoutId)</span>
<span class="fc" id="L188">            val individualSets = planEntry.goals</span>
<span class="fc bfc" id="L189" title="All 4 branches covered.">                .filter { it.exerciseId != null }</span>
<span class="fc" id="L190">                .flatMap { goal -&gt;</span>
<span class="fc" id="L191">                    val tmp = arrayListOf&lt;SetEntity&gt;()</span>
<span class="fc" id="L192">                    val position = addedPositions.first { goalPosition -&gt;</span>
<span class="pc bpc" id="L193" title="2 of 4 branches missed.">                        goalPosition.groupId == goal.exerciseGroupId ||</span>
<span class="pc bnc" id="L194" title="All 2 branches missed.">                                goalPosition.exerciseId == goal.exerciseId</span>
                    }

<span class="fc bfc" id="L197" title="All 2 branches covered.">                    for (i in 0 until goal.sets) {</span>
<span class="fc" id="L198">                        val lastSet = database.exerciseSetDao().getLastCompletedSet(goal.exerciseId!!)</span>

<span class="fc" id="L200">                        tmp.add(SetEntity(</span>
<span class="fc" id="L201">                            sId = 0L,</span>
<span class="fc" id="L202">                            exerciseId = goal.exerciseId,</span>
<span class="fc" id="L203">                            workoutId = workoutId,</span>
<span class="fc" id="L204">                            positionId = position.epId,</span>
<span class="pc bpc" id="L205" title="5 of 8 branches missed.">                            reps = goal.reps.takeIf { it &gt; 0 } ?: lastSet?.reps ?: 0,</span>
<span class="pc bpc" id="L206" title="3 of 8 branches missed.">                            weightInPounds = goal.weightInPounds.takeIf { it &gt; 0 } ?: lastSet?.weightInPounds ?: 0f,</span>
<span class="pc bpc" id="L207" title="3 of 8 branches missed.">                            weightInKilograms = goal.weightInKilograms.takeIf { it &gt; 0 } ?: lastSet?.weightInKilograms ?: 0f,</span>
<span class="pc bpc" id="L208" title="3 of 8 branches missed.">                            repsInReserve = goal.repsInReserve.takeIf { it &gt; 0 } ?: lastSet?.repsInReserve ?: 0,</span>
<span class="pc bpc" id="L209" title="3 of 8 branches missed.">                            perceivedExertion = goal.perceivedExertion.takeIf { it &gt; 0 } ?: lastSet?.perceivedExertion ?: 0,</span>
<span class="fc" id="L210">                            setNumber = (i + 1),</span>
<span class="fc" id="L211">                            seconds = 0,</span>
<span class="fc" id="L212">                            modifier = goal.modifier,</span>
<span class="fc" id="L213">                            type = goal.type,</span>
                        ))
                    }
<span class="fc" id="L216">                    tmp</span>
                }

<span class="fc" id="L219">            database.exerciseSetDao().insertAll(individualSets)</span>

<span class="fc" id="L221">            val insertedSets = database.exerciseSetDao().getSetsInWorkout(workoutId)</span>
<span class="fc" id="L222">            createdWorkout = createdWorkout.copy(</span>
<span class="fc" id="L223">                entries = addedPositions.map { position -&gt;</span>
<span class="pc bpc" id="L224" title="1 of 8 branches missed.">                    val matchingExercise = dbExercises.find { it.eId == position.exerciseId }</span>
<span class="pc bpc" id="L225" title="1 of 4 branches missed.">                    val matchingGoal = planEntry.goals.find { goal -&gt;</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">                        goal.exerciseId == position.exerciseId ||</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">                                goal.exerciseGroupId == position.groupId</span>
                    }
<span class="pc bpc" id="L229" title="2 of 8 branches missed.">                    val goalExercise = dbExercises.firstOrNull { matchingGoal != null &amp;&amp; it.eId == matchingGoal.exerciseId }</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">                    val goalGroup = position.groupId?.let { database.exerciseGroupDao().getGroupByIdWithExercises(it) }</span>

<span class="fc" id="L232">                    WorkoutEntry(</span>
<span class="fc" id="L233">                        position = position.position,</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">                        exercise = matchingExercise?.toExercise(),</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">                        expectedSet = matchingGoal?.toExpectedSet(</span>
<span class="fc" id="L236">                            position.position,</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">                            exercise = goalExercise?.toExercise(),</span>
<span class="pc bpc" id="L238" title="1 of 4 branches missed.">                            group = goalGroup?.group?.toExerciseGroup(</span>
<span class="fc" id="L239">                                goalGroup.exercises.map { it.toExercise() }.orEmpty())</span>
                        ),
<span class="pc bpc" id="L241" title="1 of 6 branches missed.">                        sets = insertedSets.filter { it.exerciseId == position.exerciseId }</span>
<span class="fc" id="L242">                            .map { item -&gt;</span>
<span class="fc" id="L243">                                item.toExerciseSet(matchingExercise!!.toExercise())</span>
                            }
<span class="fc" id="L245">                            .sortedBy { it.setNumber }</span>
                    )
<span class="fc" id="L247">                }.sortedBy { it.position },</span>
            )
        }

<span class="fc" id="L251">        return createdWorkout</span>
    }

<span class="fc" id="L254">    override suspend fun deleteWorkout(workout: Workout) {</span>
<span class="fc" id="L255">        val dbWorkout = database.workoutDao().getWorkoutByAddedAt(workout.addedAt)</span>
<span class="fc" id="L256">        database.workoutDao().delete(dbWorkout)</span>
<span class="fc" id="L257">    }</span>

<span class="fc" id="L259">    override suspend fun updateWorkout(workout: Workout): Workout {</span>
<span class="fc" id="L260">        val existingWorkout = database.workoutDao().getWorkout(workout.id)</span>

<span class="fc" id="L262">        database.workoutDao().update(workout.toDbWorkout(</span>
<span class="fc" id="L263">            existingWorkout.wId,</span>
<span class="fc" id="L264">            planId = existingWorkout.planId</span>
        ))
<span class="fc" id="L266">        return workout</span>
    }

<span class="nc" id="L269">    override suspend fun addEntry(</span>
        workoutEntry: WorkoutEntry,
        workoutAddedAt: OffsetDateTime
    ): WorkoutEntry {
<span class="nc" id="L273">        val workoutEntity = database.workoutDao().getWorkoutByAddedAt(workoutAddedAt)</span>
<span class="nc" id="L274">        val positions = database.exercisePositionDao().getPositionsInWorkout(workoutEntity.wId)</span>

<span class="nc" id="L276">        val exercise = when (workoutEntry.exercise) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            null -&gt; null</span>
<span class="nc" id="L278">            else -&gt; database.exerciseDao().getExerciseByName(workoutEntry.exercise!!.name)</span>
        }

<span class="nc" id="L281">        var insertedSet = null as SetEntity?</span>

<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (exercise != null) {</span>
<span class="nc" id="L284">            val insertedPositionId = database.exercisePositionDao().insert(</span>
<span class="nc" id="L285">                ExercisePositionEntity(</span>
<span class="nc" id="L286">                    epId = 0L,</span>
<span class="nc" id="L287">                    workoutId = workoutEntity.wId,</span>
<span class="nc" id="L288">                    position = positions.size + 1,</span>
<span class="nc" id="L289">                    exerciseId = exercise.eId,</span>
                )
            )

<span class="nc" id="L293">            val lastSet = database.exerciseSetDao().getLastCompletedSet(exercise.eId)</span>
<span class="nc bnc" id="L294" title="All 4 branches missed.">            insertedSet = lastSet?.copy(</span>
<span class="nc" id="L295">                    sId = 0L,</span>
<span class="nc" id="L296">                    exerciseId = exercise.eId,</span>
<span class="nc" id="L297">                    workoutId = workoutEntity.wId,</span>
<span class="nc" id="L298">                    positionId = insertedPositionId,</span>
<span class="nc" id="L299">                    setNumber = 1,</span>
<span class="nc" id="L300">                    completedAt = null,</span>
                ) ?:
<span class="nc" id="L302">                SetEntity(</span>
<span class="nc" id="L303">                    sId = 0L,</span>
<span class="nc" id="L304">                    exerciseId = exercise.eId,</span>
<span class="nc" id="L305">                    workoutId = workoutEntity.wId,</span>
<span class="nc" id="L306">                    positionId = insertedPositionId,</span>
<span class="nc" id="L307">                    setNumber = 1,</span>
<span class="nc" id="L308">                    completedAt = null,</span>
                )
<span class="nc" id="L310">            database.exerciseSetDao().insert(insertedSet)</span>
        }


<span class="nc" id="L314">        return WorkoutEntry(</span>
<span class="nc" id="L315">            position = positions.size + 1,</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            exercise = exercise?.toExercise(),</span>
<span class="nc bnc" id="L317" title="All 6 branches missed.">            sets = listOfNotNull(exercise?.toExercise()?.let { insertedSet?.toExerciseSet(it) })</span>
        )
    }

<span class="nc" id="L321">    override suspend fun removeEntryFromWorkout(entry: WorkoutEntry, workoutAddedAt: OffsetDateTime) {</span>
<span class="nc" id="L322">        val dbWorkout = database.workoutDao().getWorkoutByAddedAt(workoutAddedAt)</span>
<span class="nc" id="L323">        val positions = database.exercisePositionDao().getPositionsInWorkout(dbWorkout.wId)</span>

        // delete position of exercise to remove
<span class="nc bnc" id="L326" title="All 8 branches missed.">        positions.find { it.position == entry.position }?.let { pos -&gt;</span>
<span class="nc" id="L327">            database.exercisePositionDao().delete(pos)</span>
            // ExerciseSets should be deleted because of CASCADE
<span class="nc" id="L329">        }</span>

        // update other positions
<span class="nc" id="L332">        val positionsToMove = positions.filter { pos -&gt;</span>
<span class="nc bnc" id="L333" title="All 4 branches missed.">            pos.position &gt;= entry.position</span>
        }
<span class="nc" id="L335">        database.exercisePositionDao().updateAll(</span>
<span class="nc" id="L336">            positionsToMove.map { it.copy(position = it.position - 1) }</span>
        )
<span class="nc" id="L338">    }</span>

    override suspend fun updateCompletedSet(workout: Workout, exerciseSet: ExerciseSet) {
<span class="nc" id="L341">        database.exerciseSetDao().updatePartial(exerciseSet = ExerciseSetPartial(</span>
<span class="nc" id="L342">            exerciseSet.id,</span>
<span class="nc" id="L343">            reps = exerciseSet.reps,</span>
<span class="nc" id="L344">            setNumber = exerciseSet.setNumber,</span>
<span class="nc" id="L345">            weightInPounds = exerciseSet.weightInPounds,</span>
<span class="nc" id="L346">            weightInKilograms = exerciseSet.weightInKilograms,</span>
<span class="nc" id="L347">            repsInReserve = exerciseSet.repsInReserve,</span>
<span class="nc" id="L348">            perceivedExertion = exerciseSet.perceivedExertion,</span>
        ))
<span class="nc" id="L350">    }</span>

    override suspend fun deleteSet(set: ExerciseSet, workoutId: Long) {
<span class="nc" id="L353">        val setEntity = database.exerciseSetDao().getSet(set.id)</span>
<span class="nc" id="L354">        database.exerciseSetDao().delete(set.id)</span>

<span class="nc" id="L356">        val positions = database.exercisePositionDao().getPositionsWithExerciseAndSets(workoutId)</span>
<span class="nc bnc" id="L357" title="All 6 branches missed.">        val position = positions.find { it.position.epId == setEntity.positionId }</span>
<span class="nc bnc" id="L358" title="All 8 branches missed.">        if (position?.exerciseSets?.isEmpty() == true) {</span>
<span class="nc" id="L359">            database.exercisePositionDao().delete(position.position)</span>
        }
<span class="nc" id="L361">    }</span>

<span class="nc" id="L363">    override suspend fun swapEntryPosition(</span>
        workoutAddedAt: OffsetDateTime,
        entry: WorkoutEntry,
        newPosition: Int
    ) {
<span class="nc" id="L368">        val dbWorkout = database.workoutDao().getWorkoutByAddedAt(workoutAddedAt)</span>
<span class="nc" id="L369">        val dbPositions = database.exercisePositionDao().getPositionsInWorkout(dbWorkout.wId)</span>

<span class="nc bnc" id="L371" title="All 8 branches missed.">        dbPositions.find { it.position == entry.position }?.let { entryToMove -&gt;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            val movingUp = entryToMove.position &gt; newPosition</span>
<span class="nc bnc" id="L373" title="All 8 branches missed.">            dbPositions.find { it.position == newPosition }?.let { positionInWantedSpot -&gt;</span>
<span class="nc" id="L374">                database.exercisePositionDao().update(</span>
<span class="nc" id="L375">                    positionInWantedSpot.copy(</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">                        position = if (movingUp)</span>
<span class="nc" id="L377">                            (positionInWantedSpot.position + 1)</span>
                        else
<span class="nc" id="L379">                            (positionInWantedSpot.position - 1)</span>
                    )
                )
<span class="nc" id="L382">            }</span>

<span class="nc" id="L384">            database.exercisePositionDao().update(entryToMove.copy(position = newPosition))</span>
<span class="nc" id="L385">        }</span>
<span class="nc" id="L386">    }</span>

<span class="nc" id="L388">    override suspend fun replaceGroupWithExercise(</span>
        workoutAddedAt: OffsetDateTime,
        group: ExerciseGroup,
        exercise: Exercise,
        position: Int,
        expectedSet: ExpectedSet?
    ) {
<span class="nc" id="L395">        val dbWorkout = database.workoutDao().getWorkoutByAddedAt(workoutAddedAt)</span>
<span class="nc" id="L396">        val dbPositions = database.exercisePositionDao().getPositionsInWorkout(dbWorkout.wId)</span>
<span class="nc" id="L397">        val dbExercise = database.exerciseDao().getExerciseByName(exercise.name)</span>


<span class="nc bnc" id="L400" title="All 6 branches missed.">        dbPositions.firstOrNull { it.position == position }?.let { pos -&gt;</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            Timber.d(&quot;*** adding ${dbExercise?.name} exercise from group ${group.name}&quot;)</span>
<span class="nc" id="L402">            database.exercisePositionDao().update(pos.copy(</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                exerciseId = dbExercise?.eId,</span>
            ))

<span class="nc bnc" id="L406" title="All 2 branches missed.">            if (dbExercise != null) {</span>
<span class="nc" id="L407">                Timber.d(&quot;*** expectedSet = $expectedSet&quot;)</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                if (expectedSet != null) {</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                    val minSets = if (expectedSet.sets == 0) 1 else expectedSet.sets</span>
<span class="nc" id="L410">                    val inserted = database.exerciseSetDao().insertAll(</span>
<span class="nc" id="L411">                        IntRange(1, minSets).toList().map { number -&gt;</span>
<span class="nc" id="L412">                            SetEntity(</span>
<span class="nc" id="L413">                                sId = 0L,</span>
<span class="nc" id="L414">                                exerciseId = dbExercise.eId,</span>
<span class="nc" id="L415">                                workoutId = dbWorkout.wId,</span>
<span class="nc" id="L416">                                groupId = group.id,</span>
<span class="nc" id="L417">                                positionId = pos.epId,</span>
<span class="nc" id="L418">                                reps = expectedSet.reps,</span>
<span class="nc" id="L419">                                repsInReserve = expectedSet.rir,</span>
<span class="nc" id="L420">                                perceivedExertion = expectedSet.perceivedExertion,</span>
<span class="nc" id="L421">                                type = expectedSet.type,</span>
<span class="nc" id="L422">                                setNumber = number,</span>
                            )
                        }
                    )
<span class="nc" id="L426">                    Timber.d(&quot;*** added ${inserted.size} sets&quot;)</span>
                } else {
<span class="nc" id="L428">                    database.exerciseSetDao().insert(</span>
<span class="nc" id="L429">                        SetEntity(</span>
<span class="nc" id="L430">                            sId = 0L,</span>
<span class="nc" id="L431">                            exerciseId = dbExercise.eId,</span>
<span class="nc" id="L432">                            workoutId = dbWorkout.wId,</span>
<span class="nc" id="L433">                            groupId = group.id,</span>
<span class="nc" id="L434">                            positionId = pos.epId</span>
                        )
                    )
                }
            }
<span class="nc" id="L439">        }</span>
<span class="nc" id="L440">    }</span>

<span class="nc" id="L442">    override suspend fun replaceExerciseWithGroup(</span>
        workoutAddedAt: OffsetDateTime,
        entry: WorkoutEntry,
    ): WorkoutEntry {
<span class="nc" id="L446">        val dbWorkout = database.workoutDao().getWorkoutByAddedAt(workoutAddedAt)</span>
<span class="nc" id="L447">        val dbPositions = database.exercisePositionDao().getPositionsInWorkout(dbWorkout.wId)</span>

<span class="nc bnc" id="L449" title="All 6 branches missed.">        dbPositions.firstOrNull { it.position == entry.position }?.let { pos -&gt;</span>
<span class="nc" id="L450">            database.exercisePositionDao().update(pos.copy(</span>
<span class="nc" id="L451">                exerciseId = null,</span>
            ))

<span class="nc" id="L454">            val dbSets = database.exerciseSetDao().getSetsInWorkout(dbWorkout.wId)</span>
<span class="nc bnc" id="L455" title="All 4 branches missed.">            database.exerciseSetDao().deleteAll(dbSets.filter { it.positionId == pos.epId })</span>
<span class="nc" id="L456">        }</span>

<span class="nc" id="L458">        return WorkoutEntry(</span>
<span class="nc" id="L459">            position = entry.position,</span>
<span class="nc" id="L460">            exercise = null,</span>
<span class="nc" id="L461">            expectedSet = entry.expectedSet,</span>
<span class="nc" id="L462">            sets = emptyList()</span>
        )
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>