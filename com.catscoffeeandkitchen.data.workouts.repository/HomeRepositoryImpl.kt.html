<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HomeRepositoryImpl.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data</a> &gt; <a href="index.source.html" class="el_package">com.catscoffeeandkitchen.data.workouts.repository</a> &gt; <span class="el_source">HomeRepositoryImpl.kt</span></div><h1>HomeRepositoryImpl.kt</h1><pre class="source lang-java linenums">package com.catscoffeeandkitchen.data.workouts.repository

import com.catscoffeeandkitchen.data.workouts.db.FitnessJournalDb
import com.catscoffeeandkitchen.data.workouts.models.ExerciseGoal
import com.catscoffeeandkitchen.data.workouts.util.*
import com.catscoffeeandkitchen.domain.interfaces.HomeRepository
import com.catscoffeeandkitchen.domain.models.*
import com.catscoffeeandkitchen.domain.util.DataState
import java.time.DayOfWeek
import java.time.Duration
import java.time.OffsetDateTime
import java.time.ZoneId
import java.time.temporal.WeekFields
import java.util.*
import javax.inject.Inject
import kotlin.math.roundToInt

<span class="fc" id="L18">class HomeRepositoryImpl @Inject constructor(</span>
<span class="fc" id="L19">    private val database: FitnessJournalDb</span>
): HomeRepository {
<span class="fc" id="L21">    override suspend fun getNextWorkoutPlan(): WorkoutPlan? {</span>
<span class="fc" id="L22">        val today = OffsetDateTime.now().dayOfWeek</span>
<span class="fc" id="L23">        val plans = database.workoutPlanDao().getWithDay(today.name)</span>
<span class="pc bfc" id="L24" title="All 4 branches covered.">        val nextPlan = plans.maxByOrNull { it.addedAt }?.toPlan() ?: return null</span>

<span class="fc" id="L26">        val planWithGoals = database.workoutPlanDao().getWorkoutPlanWithGoalsById(nextPlan.id)</span>
<span class="fc" id="L27">        return WorkoutPlan(</span>
<span class="fc" id="L28">            id = planWithGoals.plan.wpId,</span>
<span class="fc" id="L29">            addedAt = planWithGoals.plan.addedAt,</span>
<span class="fc" id="L30">            name = planWithGoals.plan.name,</span>
<span class="fc" id="L31">            note = planWithGoals.plan.note,</span>
<span class="fc" id="L32">            entries = getExpectedSetFromGoals(planWithGoals.goals),</span>
<span class="fc" id="L33">            daysOfWeek = planWithGoals.plan.daysOfWeek.map { DayOfWeek.valueOf(it) }</span>
        )
    }

<span class="fc" id="L37">    override suspend fun getWorkoutWeekStats(weeks: Int): WorkoutWeekStats {</span>
<span class="fc" id="L38">        val startDate = OffsetDateTime.now().minusWeeks(weeks.toLong())</span>
<span class="fc" id="L39">        val workouts = database.workoutDao().getWorkoutsAfter(startDate.toUTCEpochMilli())</span>
<span class="fc" id="L40">        val dates = workouts.map { it.completedAt!! }</span>

<span class="fc" id="L42">        val mostCommonTimes = dates</span>
<span class="fc" id="L43">            .asSequence()</span>
<span class="fc" id="L44">            .groupBy { it.atZoneSameInstant(ZoneId.systemDefault()).hour }</span>
<span class="fc" id="L45">            .map { it.key to it.value.size }</span>
<span class="fc" id="L46">            .sortedByDescending { it.second }</span>
<span class="fc" id="L47">            .take(3)</span>
<span class="fc" id="L48">            .map { it.first }</span>
<span class="fc" id="L49">            .toList()</span>

<span class="fc" id="L51">        val weekOfYear = WeekFields.of(Locale.getDefault()).weekOfYear()</span>
<span class="fc" id="L52">        val averageWorkoutsPerWeek = dates.groupBy { it.get(weekOfYear) }</span>
<span class="fc" id="L53">            .map { it.value.size }</span>
<span class="fc" id="L54">            .average()</span>
<span class="fc bfc" id="L55" title="All 4 branches covered.">            .takeIf { !it.isNaN() }</span>

<span class="fc" id="L57">        val mostCommonDays = dates</span>
<span class="fc" id="L58">            .asSequence()</span>
<span class="fc" id="L59">            .groupBy { it.dayOfWeek }</span>
<span class="fc" id="L60">            .map { it.key to it.value.size }</span>
<span class="fc" id="L61">            .sortedByDescending { it.second }</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">            .take(averageWorkoutsPerWeek?.roundToInt() ?: 0)</span>
<span class="fc" id="L63">            .map { it.first }</span>
<span class="fc" id="L64">            .toList()</span>

<span class="fc" id="L66">        return WorkoutWeekStats(</span>
<span class="fc" id="L67">            dates,</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">            averageWorkoutsPerWeek ?: 0.0,</span>
<span class="fc" id="L69">            mostCommonDays,</span>
<span class="fc" id="L70">            mostCommonTimes</span>
        )
    }

    override suspend fun getLastExercisesCompleted(): List&lt;WorkoutEntry&gt; {
<span class="fc bfc" id="L75" title="All 2 branches covered.">        val lastWorkout = database.workoutDao().getLastWorkout() ?: return emptyList()</span>
<span class="fc" id="L76">        val sets = database.exercisePositionDao().getPositionsWithExerciseAndSets(lastWorkout.wId)</span>

<span class="fc" id="L78">        return sets.map { data -&gt;</span>
<span class="fc" id="L79">            WorkoutEntry(</span>
<span class="fc" id="L80">                position = data.position.position,</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                exercise = data.exercise?.toExercise(),</span>
<span class="fc" id="L82">                expectedSet = null,</span>
<span class="fc" id="L83">                sets = data.exerciseSets.mapNotNull { set -&gt;</span>
<span class="pc bpc" id="L84" title="2 of 4 branches missed.">                    data.exercise?.let { exercise -&gt;</span>
<span class="fc" id="L85">                        set.toExerciseSet(exercise.toExercise())</span>
                    }
<span class="fc" id="L87">                }.sortedBy { it.setNumber }</span>
            )
<span class="fc" id="L89">        }.sortedBy { it.position }</span>
    }

<span class="fc" id="L92">    override suspend fun getMostImprovedExercise(weeks: Int): ExerciseProgressStats? {</span>
<span class="fc" id="L93">        val startDate = OffsetDateTime.now().minusWeeks(weeks.toLong())</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        val bestSet = database.exerciseSetDao().getBestSetSince(startDate.toUTCEpochMilli()) ?: return null</span>
<span class="fc" id="L95">        val exercise = database.exerciseDao().getExerciseById(bestSet.exerciseId)</span>

<span class="fc bfc" id="L97" title="All 2 branches covered.">        val worstSet = database.exerciseSetDao().getWorstSetSince(</span>
<span class="fc" id="L98">            startDate.toUTCEpochMilli(),</span>
<span class="fc" id="L99">            exercise.eId,</span>
<span class="fc" id="L100">            bestSet.sId</span>
<span class="fc" id="L101">        ) ?: return null</span>

<span class="fc" id="L103">        return ExerciseProgressStats(</span>
<span class="fc" id="L104">            exercise = exercise.toExercise(),</span>
<span class="fc" id="L105">            worstSet = worstSet.toExerciseSet(exercise.toExercise()),</span>
<span class="fc" id="L106">            bestSet = bestSet.toExerciseSet(exercise.toExercise()),</span>
<span class="fc" id="L107">            amountOfTime = Duration.between(startDate, OffsetDateTime.now()),</span>
<span class="fc" id="L108">            starting1RM = worstSet.weightInPounds / (1.0278 - 0.0278 * worstSet.reps).toFloat(),</span>
<span class="fc" id="L109">            ending1RM = bestSet.weightInPounds / (1.0278 - 0.0278 * bestSet.reps).toFloat()</span>
        )
    }


<span class="fc" id="L114">    private suspend fun getExpectedSetFromGoals(goals: List&lt;ExerciseGoal&gt;): List&lt;ExpectedSet&gt; {</span>
<span class="fc" id="L115">        return goals.mapNotNull { goal -&gt;</span>
<span class="fc" id="L116">            val position = database.exercisePositionDao().getPosition(goal.positionId)</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">            when {</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">                goal.exerciseId != null -&gt; {</span>
<span class="fc" id="L119">                    val dbExercise = database.exerciseDao().getExerciseById(goal.exerciseId)</span>
<span class="fc" id="L120">                    goal.toExpectedSet(</span>
<span class="fc" id="L121">                        position = position.position,</span>
<span class="fc" id="L122">                        exercise = dbExercise.toExercise(position.position)</span>
                    )
                }
<span class="fc bfc" id="L125" title="All 2 branches covered.">                goal.exerciseGroupId != null -&gt; {</span>
<span class="fc" id="L126">                    val dbExerciseGroup =</span>
<span class="fc" id="L127">                        database.exerciseGroupDao().getGroupByIdWithExercises(goal.exerciseGroupId)</span>

<span class="fc" id="L129">                    goal.toExpectedSet(</span>
<span class="fc" id="L130">                        position = position.position,</span>
<span class="fc" id="L131">                        group = dbExerciseGroup.group.toExerciseGroup(</span>
<span class="fc" id="L132">                            exercises = dbExerciseGroup.exercises.map { it.toExercise(position.position) },</span>
                        )
                    )
                }
<span class="fc" id="L136">                else -&gt; null</span>
            }
<span class="fc" id="L138">        }.sortedBy { it.positionInWorkout }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>